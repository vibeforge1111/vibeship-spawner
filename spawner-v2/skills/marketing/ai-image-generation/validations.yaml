id: ai-image-generation-validations
skill: ai-image-generation
version: 1.0.0

validations:
  # Critical: Security and Legal
  - id: no-api-keys-hardcoded
    name: No API keys in code
    severity: critical
    description: API keys must use environment variables, never hardcoded
    pattern:
      file_glob: "**/*.{ts,js,py,yaml,json}"
      match: "(OPENAI_API|MIDJOURNEY|REPLICATE|FAL_KEY|STABILITY|IDEOGRAM).*=.*['\"][^'\"]{20,}['\"]"
      exclude: "process\\.env|import\\.meta\\.env|os\\.environ|\\$\\{"
    message: "API key hardcoded. Use environment variables."
    autofix: false

  - id: no-copyrighted-artist-names
    name: Avoid copyrighted artist style references
    severity: high
    description: Referencing living artists by name creates legal risk
    pattern:
      file_glob: "**/*.{ts,js,py,yaml,json,md}"
      match: "style of (Greg Rutkowski|Artgerm|Wlop|Sakimichan|Ross Tran)"
      exclude: "avoid|don't|not|example of what NOT"
    message: "Living artist name in prompt creates legal risk. Describe style instead."
    autofix: false

  - id: user-input-sanitization
    name: Sanitize user input in prompts
    severity: critical
    description: User input concatenated into prompts needs sanitization
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "prompt.*\\+.*\\b(user|input|req\\.body|params)"
      exclude: "sanitize|escape|clean|filter|validate"
    message: "User input in prompt without sanitization. Add input validation."
    autofix: false

  # High: Quality Control
  - id: prompt-has-structure
    name: Prompts need structural elements
    severity: high
    description: Quality prompts should specify medium, subject, and style
    pattern:
      file_glob: "**/*.{ts,js,yaml}"
      match: 'prompt\\s*[:=]\\s*["\''''][^"\'''']{1,80}["\'''']'
      exclude: "photograph|render|painting|illustration|drawing|3d|digital art"
    message: "Prompt lacks medium type. Add 'photograph of', 'illustration of', etc."
    autofix: false

  - id: negative-prompt-for-people
    name: Use negative prompts for human subjects
    severity: medium
    description: Human subjects should have anatomy-related negative prompts
    pattern:
      file_glob: "**/*.{ts,js,yaml}"
      match: "(person|woman|man|human|portrait|face)"
      exclude: "negative|bad anatomy|extra fingers|deformed"
    message: "Human subject without anatomy negative prompts. Add 'no extra fingers, proper anatomy'."
    autofix: false

  - id: resolution-specified
    name: Specify output resolution
    severity: medium
    description: Generation calls should specify resolution for predictable output
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "(generate|create).*image"
      exclude: "size|resolution|width|height|1024|1792|aspect"
    message: "Generation without resolution specified. Set width/height or aspect ratio."
    autofix: false

  # Medium: Best Practices
  - id: seed-for-reproducibility
    name: Use seeds for reproducibility
    severity: medium
    description: Important generations should use explicit seeds for reproducibility
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "generate.*\\{[^}]*prompt"
      exclude: "seed|reproducible|random.*false"
    message: "Consider using explicit seed for reproducibility."
    autofix: false

  - id: cost-tracking-present
    name: Track generation costs
    severity: medium
    description: API calls should log cost estimates for budget management
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "(openai|replicate|fal)\\.(generate|images|run)"
      exclude: "cost|price|budget|track|log|estimate"
    message: "Image generation without cost tracking. Add cost logging."
    autofix: false

  - id: error-handling-for-generation
    name: Generation calls need error handling
    severity: high
    description: AI generation API calls should handle failures gracefully
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "await.*(generate|openai\\.images|replicate\\.run|fal\\.)"
      exclude: "try|catch|error|Error|except|finally|\\.catch"
    message: "Generation call without error handling. Wrap in try/catch."
    autofix: false

  - id: batch-has-rate-limiting
    name: Batch generation needs rate limiting
    severity: high
    description: Multiple simultaneous generations should respect rate limits
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "Promise\\.all.*generate|for.*await.*generate|\\.map.*generate"
      exclude: "queue|limit|throttle|batch|PQueue|p-limit|concurrent"
    message: "Batch generation without rate limiting. Add concurrency control."
    autofix: false

  - id: output-metadata-saved
    name: Save generation metadata
    severity: low
    description: Generation outputs should be saved with prompt and settings
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "(save|write|store).*\\.png|\\.jpg|image"
      exclude: "metadata|prompt|seed|settings|json|log"
    message: "Saving image without metadata. Store prompt and settings for reference."
    autofix: false

  - id: aspect-ratio-platform-match
    name: Match aspect ratio to platform
    severity: medium
    description: Social media content should use platform-appropriate aspect ratios
    pattern:
      file_glob: "**/*.{ts,js,yaml}"
      match: "(instagram|tiktok|twitter|linkedin|facebook)"
      exclude: "1:1|4:5|9:16|16:9|aspect|ratio"
    message: "Platform mentioned without aspect ratio specification."
    autofix: false

  - id: style-reference-for-series
    name: Use style references for image series
    severity: low
    description: Multiple related images should use style reference for consistency
    pattern:
      file_glob: "**/*.{ts,js,py}"
      match: "for.*\\{.*generate|series|batch|multiple.*image"
      exclude: "style_reference|reference_image|consistent|ip_adapter|seed"
    message: "Generating series without style reference. Use IP-Adapter or consistent seeds."
    autofix: false

# Pre-commit checks
pre_commit:
  - id: no-api-keys-hardcoded
  - id: no-copyrighted-artist-names
  - id: user-input-sanitization
  - id: error-handling-for-generation

# CI/CD checks
ci_checks:
  - id: no-api-keys-hardcoded
  - id: user-input-sanitization
  - id: batch-has-rate-limiting
  - id: cost-tracking-present

# Prompt library quality gates
prompt_library_checks:
  - id: prompt-has-structure
  - id: negative-prompt-for-people
  - id: resolution-specified
  - id: no-copyrighted-artist-names
