# Test Strategist Validations
# Checks for testing patterns that reduce confidence or waste effort

validations:
  - id: weak-assertion-truthy
    name: Weak Assertion - toBeTruthy
    severity: warning
    type: regex
    pattern:
      - "expect\\(.*\\)\\.toBeTruthy\\(\\)"
      - "expect\\(.*\\)\\.toBeDefined\\(\\)"
      - "expect\\(.*\\)\\.not\\.toBeNull\\(\\)"
      - "expect\\(.*\\)\\.not\\.toBeUndefined\\(\\)"
    message: "Weak assertion proves existence, not correctness. Assert on specific values."
    fix_action: "Replace with specific assertion: expect(result.total).toBe(100) instead of expect(result).toBeTruthy()"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: no-assertion-test
    name: Test Without Assertion
    severity: error
    type: regex
    pattern:
      - "it\\(['\"][^'\"]+['\"]\\s*,\\s*(?:async\\s*)?\\([^)]*\\)\\s*=>\\s*\\{[^}]*\\}\\s*\\)"
    message: "Test has no assertions. Either add expect() calls or remove the test."
    fix_action: "Add assertions that verify the expected behavior, not just that code runs."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
    exceptions:
      - "expect\\("
      - "assert\\("
      - "should\\."

  - id: hardcoded-future-date
    name: Hardcoded Future Date
    severity: warning
    type: regex
    pattern:
      - "new Date\\(['\"]202[5-9]"
      - "new Date\\(['\"]203"
      - "Date\\.parse\\(['\"]202[5-9]"
    message: "Hardcoded future date will cause test failures when that date passes."
    fix_action: "Use relative dates or freeze time: jest.useFakeTimers(); jest.setSystemTime(new Date('2024-01-15'));"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: sleep-in-test
    name: Sleep/Delay in Test
    severity: warning
    type: regex
    pattern:
      - "await\\s+new\\s+Promise.*setTimeout"
      - "await\\s+sleep\\("
      - "await\\s+delay\\("
      - "setTimeout\\([^,]+,\\s*\\d{4,}\\)"
    message: "Fixed delays make tests slow and flaky. Wait for conditions instead."
    fix_action: "Use waitFor or polling: await waitFor(() => expect(element).toBeVisible());"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: test-implementation-detail
    name: Testing Implementation Details
    severity: info
    type: regex
    pattern:
      - "expect\\(.*\\.mock\\.calls"
      - "toHaveBeenCalledWith\\([^)]*SELECT"
      - "toHaveBeenCalledWith\\([^)]*INSERT"
      - "expect\\(.*\\.innerHTML\\)"
    message: "Testing implementation details makes tests brittle. Test behavior instead."
    fix_action: "Test outputs and side effects, not internal method calls or DOM structure."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: excessive-mocking
    name: Excessive Mocking
    severity: info
    type: regex
    pattern:
      - "jest\\.mock\\([^)]+\\)[\\s\\S]*jest\\.mock\\([^)]+\\)[\\s\\S]*jest\\.mock\\([^)]+\\)[\\s\\S]*jest\\.mock"
      - "vi\\.mock\\([^)]+\\)[\\s\\S]*vi\\.mock\\([^)]+\\)[\\s\\S]*vi\\.mock\\([^)]+\\)[\\s\\S]*vi\\.mock"
    message: "Many mocks suggest testing mocks, not code. Consider integration test."
    fix_action: "Use real dependencies where practical. Mock only external systems."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: shared-test-state
    name: Shared State Between Tests
    severity: warning
    type: regex
    pattern:
      - "beforeAll\\([^)]*\\{[^}]*insert"
      - "beforeAll\\([^)]*\\{[^}]*create"
      - "let\\s+\\w+\\s*;[\\s\\S]*beforeEach[\\s\\S]*=\\s*[^;]+;[\\s\\S]*it\\("
    message: "Shared state causes test pollution. Each test should set up its own data."
    fix_action: "Move setup to beforeEach or inside each test. Use unique IDs per test."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: only-happy-path
    name: Only Happy Path Testing
    severity: info
    type: regex
    pattern:
      - "describe\\([^)]+\\)[^]*it\\(['\"].*(?:success|works|valid|correct)"
    message: "Test file may only cover happy path. Consider edge cases and error paths."
    fix_action: "Add tests for: empty input, null/undefined, invalid data, error conditions."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
    exceptions:
      - "error|fail|invalid|empty|null|undefined|reject|throw"

  - id: test-naming-unclear
    name: Unclear Test Name
    severity: info
    type: regex
    pattern:
      - "it\\(['\"]test\\s"
      - "it\\(['\"]should\\s+work"
      - "it\\(['\"]works\\s*['\"]"
      - "it\\(['\"]test\\d+"
    message: "Test name doesn't describe behavior. Name should explain what and when."
    fix_action: "Use format: 'returns X when Y' or 'throws error when invalid input'"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: random-data-unseeded
    name: Random Data Without Seed
    severity: warning
    type: regex
    pattern:
      - "Math\\.random\\(\\)"
      - "faker\\."
      - "chance\\."
    message: "Random data without seed causes flaky tests. Set seed for reproducibility."
    fix_action: "Seed random generator: faker.seed(12345); or use fixed test data."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
    exceptions:
      - "\\.seed\\("

  - id: commented-test
    name: Commented Out Test
    severity: warning
    type: regex
    pattern:
      - "//\\s*it\\("
      - "//\\s*test\\("
      - "//\\s*describe\\("
      - "/\\*[\\s\\S]*it\\([\\s\\S]*\\*/"
    message: "Commented-out test is dead code. Delete or fix it."
    fix_action: "Either fix the test and uncomment, or delete entirely."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: skip-without-reason
    name: Skipped Test Without Reason
    severity: warning
    type: regex
    pattern:
      - "\\.skip\\(\\)"
      - "xit\\("
      - "xdescribe\\("
      - "it\\.skip\\(['\"][^'\"]+['\"]\\s*,"
    message: "Skipped test without explanation. Add TODO comment or remove."
    fix_action: "Add comment explaining why: it.skip('reason: waiting for API fix', ...)"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
    exceptions:
      - "TODO|FIXME|BUG|ISSUE"

  - id: console-in-test
    name: Console Statement in Test
    severity: info
    type: regex
    pattern:
      - "console\\.log\\("
      - "console\\.debug\\("
    message: "Console statements in tests create noise. Remove debug output."
    fix_action: "Remove console statements or use test framework's debug utilities."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: network-call-in-unit-test
    name: Network Call in Unit Test
    severity: warning
    type: regex
    pattern:
      - "fetch\\(['\"]http"
      - "axios\\.[a-z]+\\(['\"]http"
      - "request\\(['\"]http"
    message: "Real network call in test creates flakiness. Mock external calls."
    fix_action: "Mock HTTP layer: jest.mock('axios'); or use MSW for integration tests."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
    exceptions:
      - "nock\\("
      - "msw"
      - "mock"

  - id: long-test-file
    name: Test File Too Long
    severity: info
    type: regex
    pattern:
      - "describe\\([\\s\\S]{15000,}"
    message: "Very long test file. Consider splitting by feature or scenario."
    fix_action: "Split into focused test files: user.create.test.ts, user.delete.test.ts"
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"

  - id: single-assertion-per-test-violation
    name: Too Many Assertions
    severity: info
    type: regex
    pattern:
      - "expect\\([^)]+\\)[^;]*;[\\s\\S]*expect\\([^)]+\\)[^;]*;[\\s\\S]*expect\\([^)]+\\)[^;]*;[\\s\\S]*expect\\([^)]+\\)[^;]*;[\\s\\S]*expect\\([^)]+\\)[^;]*;"
    message: "Many assertions in one test. Consider splitting for clearer failure messages."
    fix_action: "Split into multiple tests, each verifying one behavior."
    applies_to:
      - "**/*.test.ts"
      - "**/*.test.tsx"
      - "**/*.test.js"
      - "**/*.spec.ts"
      - "**/*.spec.js"
