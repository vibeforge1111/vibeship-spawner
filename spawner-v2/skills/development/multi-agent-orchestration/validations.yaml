# Multi-Agent Orchestration Validations

validations:
  - id: parallel-shared-state
    name: Parallel Agents with Shared State
    severity: high
    type: regex
    pattern: 'Promise\.all\s*\([^)]+\)[^;]*state\.'
    negative_pattern: 'mutex|lock|atomic|synchronized'
    message: "Parallel agent execution with shared state access. Risk of race conditions."
    fix_action: "Use scoped state channels or mutex for safe concurrent access"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: unbounded-recursion
    name: Unbounded Agent Recursion
    severity: critical
    type: regex
    pattern: 'async\s+\w+Agent[^{]*\{[^}]*this\.\w+Agent|callAgent\s*\([^)]*\)'
    negative_pattern: 'maxDepth|maxCalls|circuitBreaker|limit|depth'
    message: "Agent can call other agents without recursion limit. Risk of infinite loops."
    fix_action: "Add maxDepth/maxCalls limit and circuit breaker pattern"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-handoff-context
    name: Missing Handoff Context
    severity: medium
    type: regex
    pattern: 'delegate|handoff|transfer|route.*to'
    negative_pattern: 'context|state|handoffData|previousAgent'
    message: "Agent handoff without explicit context transfer."
    fix_action: "Pass complete handoff context including previous work and expectations"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-token-tracking
    name: Multi-Agent Without Token Tracking
    severity: medium
    type: regex
    pattern: 'Promise\.all\s*\([^)]*\w+Agent|sequential.*agent|parallel.*agent'
    negative_pattern: 'token|usage|cost|budget'
    message: "Multi-agent workflow without token tracking. Risk of cost explosion."
    fix_action: "Track token usage per agent and enforce budgets"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-orchestration-tracing
    name: Missing Agent Orchestration Tracing
    severity: medium
    type: regex
    pattern: 'class\s+\w*(?:Orchestrator|Manager|Coordinator|Supervisor)'
    negative_pattern: 'trace|log|span|observe|monitor'
    message: "Agent orchestrator without tracing. Debugging will be difficult."
    fix_action: "Add tracing for agent invocations, state changes, and handoffs"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-timeout-multi-agent
    name: Multi-Agent Without Timeout
    severity: high
    type: regex
    pattern: 'await\s+this\.\w+Agent|await\s+agent\.|await\s+Promise\.all'
    negative_pattern: 'timeout|AbortController|deadline|timeLimit'
    message: "Multi-agent execution without timeout. Could hang indefinitely."
    fix_action: "Add execution timeout with Promise.race or AbortController"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: hardcoded-agent-selection
    name: Hardcoded Agent Selection
    severity: low
    type: regex
    pattern: 'if\s*\([^)]*===?\s*["\'][^"\']+["\']\s*\)\s*\{[^}]*Agent'
    message: "Agent selection using hardcoded string matching. Consider using registry."
    fix_action: "Use agent registry with capability matching for flexible routing"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-error-propagation
    name: Swallowed Errors in Agent Chain
    severity: high
    type: regex
    pattern: 'catch\s*\([^)]*\)\s*\{[^}]*(?:console\.log|return\s+null|continue)'
    message: "Agent errors swallowed without propagation. May cause silent failures."
    fix_action: "Propagate errors with context or implement explicit fallback handling"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: missing-agent-id
    name: Agent Without Unique Identifier
    severity: low
    type: regex
    pattern: 'class\s+\w+Agent\s*(?:extends|implements|{)'
    negative_pattern: 'id:|agentId|this\.id\s*='
    message: "Agent class without unique identifier. Tracing will be difficult."
    fix_action: "Add unique agent ID for tracing and debugging"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: global-state-modification
    name: Global State Modification in Agent
    severity: high
    type: regex
    pattern: 'global\.|window\.|process\.env\s*='
    message: "Agent modifying global state. Causes unpredictable behavior in multi-agent systems."
    fix_action: "Use passed-in state object instead of global state"
    applies_to:
      - "*.ts"
      - "*.js"
