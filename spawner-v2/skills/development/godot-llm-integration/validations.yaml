# Godot LLM Integration Validations
# Automated checks to catch common Godot LLM integration mistakes

validations:
  - id: godot-separate-model-nodes
    name: Separate Model Nodes Per NPC
    severity: critical
    type: regex
    pattern: 'NobodyWhoModel|model_file.*=.*\.gguf'
    message: "Each NobodyWhoModel loads model separately. Use shared model in autoload."
    fix_action: "Create one model in Global autoload, reference via chat.model_node = Global.model"
    applies_to:
      - "*.gd"
      - "*.tscn"

  - id: godot-blocking-await
    name: Blocking Await in Process
    severity: critical
    type: regex
    pattern: 'func _process\\([^)]*\\):[^}]*await|func _physics_process\\([^)]*\\):[^}]*await.*chat'
    message: "Awaiting LLM in _process blocks the game loop. Use signals instead."
    fix_action: "Connect to message_received signal, handle response in callback"
    applies_to:
      - "*.gd"

  - id: godot-absolute-model-path
    name: Absolute Model Path
    severity: high
    type: regex
    pattern: 'model_file\\s*=\\s*["\'][A-Za-z]:|model_path\\s*=\\s*["\']/'
    message: "Absolute path for model won't work in exports. Use res:// path."
    fix_action: "Place model in res://ai/models/ and use res:// path"
    applies_to:
      - "*.gd"

  - id: godot-no-signal-connection
    name: No Signal Connection for Response
    severity: high
    type: regex
    pattern: '\\.say\\('
    negative_pattern: 'message_received\\.connect|completed\\.connect'
    message: "Calling say() without connecting to response signal. Response will be lost."
    fix_action: "Connect to chat.message_received signal before calling say()"
    applies_to:
      - "*.gd"

  - id: godot-model-in-ready
    name: Model Loading in _ready Without Feedback
    severity: high
    type: regex
    pattern: 'func _ready\\(\\):[^}]*NobodyWhoModel\\.new\\(\\)'
    negative_pattern: 'loading|Loading|progress|Progress'
    message: "Model loading in _ready freezes game without feedback."
    fix_action: "Load model during loading screen with progress indication"
    applies_to:
      - "*.gd"

  - id: godot-no-grammar-for-actions
    name: No Grammar Constraint for Structured Output
    severity: warning
    type: regex
    pattern: 'JSON\\.parse_string'
    negative_pattern: 'grammar|Grammar|GRAMMAR'
    message: "Parsing JSON without grammar constraint. LLM may output invalid JSON."
    fix_action: "Use chat.grammar to guarantee valid JSON output"
    applies_to:
      - "*.gd"

  - id: godot-no-context-management
    name: No Context Window Management
    severity: warning
    type: regex
    pattern: 'NobodyWhoChat|system_prompt'
    negative_pattern: 'context_shifting|context_size|get_context_length'
    message: "No context management. Long conversations may lose early context."
    fix_action: "Enable context shifting or manually manage conversation history"
    applies_to:
      - "*.gd"

  - id: godot-mobile-without-check
    name: LLM Code Without Platform Check
    severity: warning
    type: regex
    pattern: 'NobodyWho|\.say\\(|\.model_node'
    negative_pattern: 'OS\\.has_feature|mobile|Mobile|platform|Platform'
    message: "LLM code without platform check. Mobile support is experimental."
    fix_action: "Add OS.has_feature() check and cloud API fallback for mobile"
    applies_to:
      - "*.gd"

  - id: godot-no-error-handling
    name: No Error Handling for LLM
    severity: warning
    type: regex
    pattern: '\\.say\\('
    negative_pattern: 'error|Error|failed|Failed|catch'
    message: "No error handling for LLM calls. What if model fails to load?"
    fix_action: "Add error signal handling and fallback responses"
    applies_to:
      - "*.gd"

  - id: godot-no-thinking-indicator
    name: No Visual Feedback During Generation
    severity: info
    type: regex
    pattern: '\\.say\\('
    negative_pattern: 'thinking|Thinking|loading|Loading|indicator|Indicator|bubble|Bubble'
    message: "No thinking indicator while LLM generates. Players won't know NPC is processing."
    fix_action: "Show thinking bubble or typing indicator while awaiting response"
    applies_to:
      - "*.gd"

  - id: godot-conversation-not-persisted
    name: Conversation Not Persisted
    severity: info
    type: regex
    pattern: 'NobodyWhoChat'
    negative_pattern: 'save|Save|persist|Persist|store|Store|conversation.*manager|ConversationManager'
    message: "Conversation state may be lost on scene change. Consider persisting."
    fix_action: "Save conversation in autoload, restore when NPC scene loads"
    applies_to:
      - "*.gd"
