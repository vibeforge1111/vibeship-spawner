# GraphQL Architect Validations
# Automated checks for GraphQL patterns

validations:
  - id: no-dataloader
    name: Resolver Without DataLoader
    severity: error
    type: regex
    pattern:
      - 'resolver.*findOne'
      - 'resolver.*findUnique'
      - 'Query:.*\{(?!.*loaders)'
    message: "Resolver without DataLoader causes N+1 queries."
    fix_action: "Use DataLoader for all entity fetching"
    applies_to:
      - "**/resolvers/**/*.ts"
      - "**/schema/**/*.ts"

  - id: unbounded-list
    name: Unbounded List Return
    severity: error
    type: regex
    pattern:
      - '\[.*\!?\](?!.*Connection)'
      - 'findMany\(\)(?!.*take)'
    message: "Unbounded list can return millions of records."
    fix_action: "Use pagination with Connection pattern"
    applies_to:
      - "**/*.graphql"
      - "**/schema/**/*.ts"

  - id: no-depth-limit
    name: No Query Depth Limit
    severity: error
    type: regex
    pattern:
      - 'ApolloServer\(\{(?!.*depthLimit)'
      - 'new GraphQLServer(?!.*validationRules)'
    message: "No depth limit allows DoS attacks."
    fix_action: "Add depthLimit validation rule"
    applies_to:
      - "**/server.ts"
      - "**/index.ts"
      - "**/apollo.ts"

  - id: introspection-production
    name: Introspection Enabled in Production
    severity: warning
    type: regex
    pattern:
      - 'introspection.*true'
      - 'ApolloServer\(\{(?!.*introspection.*false)'
    message: "Introspection exposes schema to attackers."
    fix_action: "Disable introspection in production"
    applies_to:
      - "**/server.ts"
      - "**/apollo.ts"

  - id: error-leak
    name: Error Message Leaking Details
    severity: error
    type: regex
    pattern:
      - 'throw new Error.*\$\{'
      - 'throw.*error\.message'
      - 'throw.*err\.stack'
    message: "Error may expose internal details to clients."
    fix_action: "Use GraphQLError with sanitized message"
    applies_to:
      - "**/resolvers/**/*.ts"

  - id: no-complexity-limit
    name: No Query Complexity Limit
    severity: warning
    type: regex
    pattern:
      - 'ApolloServer\(\{(?!.*complexity)'
    message: "No complexity limit allows expensive queries."
    fix_action: "Add complexity analysis validation"
    applies_to:
      - "**/server.ts"
      - "**/apollo.ts"

  - id: direct-db-return
    name: Direct Database Return
    severity: warning
    type: regex
    pattern:
      - 'return.*findUnique\('
      - 'return.*findOne\('
      - 'return.*findFirst\('
    message: "Returning DB object directly may expose sensitive fields."
    fix_action: "Select specific fields or use transformation"
    applies_to:
      - "**/resolvers/**/*.ts"

  - id: no-rate-limit
    name: No Rate Limiting
    severity: warning
    type: regex
    pattern:
      - 'Query:.*\{(?!.*@rateLimit)'
    message: "No rate limiting allows API abuse."
    fix_action: "Add rate limiting directive or middleware"
    applies_to:
      - "**/*.graphql"

  - id: subscription-no-limit
    name: Subscription Without Connection Limit
    severity: warning
    type: regex
    pattern:
      - 'Subscription:.*\{(?!.*limit)'
      - 'pubsub\.asyncIterator'
    message: "Unlimited subscriptions exhaust resources."
    fix_action: "Limit subscriptions per client"
    applies_to:
      - "**/resolvers/**/*.ts"

  - id: n-plus-one-pattern
    name: N+1 Query Pattern
    severity: error
    type: regex
    pattern:
      - 'parent\s*=>\s*.*find'
      - '\(parent\).*prisma\.'
    message: "Pattern suggests N+1 query problem."
    fix_action: "Use DataLoader to batch fetches"
    applies_to:
      - "**/resolvers/**/*.ts"

  - id: mutation-no-validation
    name: Mutation Without Input Validation
    severity: warning
    type: regex
    pattern:
      - 'Mutation:.*args\.'
    message: "Mutation should validate input before processing."
    fix_action: "Add input validation with zod or similar"
    applies_to:
      - "**/resolvers/**/*.ts"

  - id: schema-db-mismatch
    name: Schema Matches Database Names
    severity: info
    type: regex
    pattern:
      - '_id:'
      - 'created_at:'
      - 'updated_at:'
    message: "Schema uses database naming (snake_case)."
    fix_action: "Use camelCase in GraphQL schema"
    applies_to:
      - "**/*.graphql"
