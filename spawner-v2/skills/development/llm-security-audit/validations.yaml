# LLM Security Audit Validations

validations:
  - id: no-security-logging
    name: Missing Security Event Logging
    severity: high
    type: regex
    pattern: '(?:messages\.create|completion|chat)\s*\('
    negative_pattern: 'log|audit|monitor|track|record'
    message: "LLM API calls without security event logging."
    fix_action: "Log all LLM interactions with timestamps, user IDs, and request hashes"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-rate-limiting
    name: Missing Rate Limiting on LLM Endpoints
    severity: high
    type: regex
    pattern: 'app\.(?:get|post)\s*\([^)]*(?:chat|completion|generate|ask)'
    negative_pattern: 'rateLimit|rateLimiter|throttle|limiter'
    message: "LLM endpoint without rate limiting. Vulnerable to DoS and cost attacks."
    fix_action: "Add rate limiting: app.use('/api/chat', rateLimiter({ max: 10, window: 60000 }))"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-cost-monitoring
    name: Missing Cost Monitoring
    severity: medium
    type: regex
    pattern: 'messages\.create|completion\.create|chat\.completions'
    negative_pattern: 'cost|usage|tokens|billing|budget'
    message: "LLM calls without cost/usage tracking. Risk of unexpected bills."
    fix_action: "Track token usage and implement budget alerts"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: hardcoded-api-key
    name: Hardcoded LLM API Key
    severity: critical
    type: regex
    pattern: '(?:ANTHROPIC_API_KEY|OPENAI_API_KEY|api[_-]?key)\s*[:=]\s*["\'][a-zA-Z0-9_-]{20,}["\']'
    message: "Hardcoded API key detected. Use environment variables."
    fix_action: "Use process.env.ANTHROPIC_API_KEY or secrets manager"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"
      - "*.env"

  - id: no-timeout
    name: LLM Call Without Timeout
    severity: medium
    type: regex
    pattern: 'messages\.create|completion\.create|chat\.completions\.create'
    negative_pattern: 'timeout|signal|AbortController'
    message: "LLM API call without timeout. Could hang indefinitely."
    fix_action: "Add timeout: new AbortController() with setTimeout"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-error-handling
    name: LLM Call Without Error Handling
    severity: medium
    type: regex
    pattern: 'await\s+(?:client|anthropic|openai)\.(?:messages|chat|completions)'
    negative_pattern: 'try|catch|\.catch|error|except'
    message: "LLM API call without error handling."
    fix_action: "Wrap in try-catch and handle API errors gracefully"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: pii-in-logs
    name: Potential PII in LLM Logs
    severity: high
    type: regex
    pattern: 'console\.log|logger\.(?:info|debug|log)\s*\([^)]*(?:message|content|prompt|input)'
    negative_pattern: 'redact|mask|sanitize|scrub'
    message: "Logging LLM content that may contain PII."
    fix_action: "Redact PII before logging: log(redactPII(content))"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-model-validation
    name: Model Selection Without Validation
    severity: medium
    type: regex
    pattern: 'model:\s*(?:req|user|input|body)\.'
    message: "Model parameter from user input. Could be manipulated."
    fix_action: "Validate model against allowed list before use"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-content-policy
    name: Missing Content Policy Enforcement
    severity: medium
    type: regex
    pattern: 'messages\.create|completion\.create'
    negative_pattern: 'content.?policy|moderat|filter|safe|block'
    message: "LLM without content policy enforcement."
    fix_action: "Implement content moderation for inputs and outputs"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-user-isolation
    name: Missing User Context Isolation
    severity: high
    type: regex
    pattern: 'messages\.push|conversation|history'
    negative_pattern: 'user.?id|session.?id|isolat|tenant'
    message: "Conversation context without user isolation. Risk of data leakage."
    fix_action: "Isolate conversation contexts by user/session ID"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-audit-trail
    name: Missing Audit Trail
    severity: high
    type: regex
    pattern: 'tool.?call|function.?call|execute'
    negative_pattern: 'audit|log|record|trace'
    message: "Tool/function execution without audit trail."
    fix_action: "Log all tool executions with user, timestamp, and parameters"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-dependency-scanning
    name: AI Dependencies Without Vulnerability Scanning
    severity: medium
    type: regex
    pattern: '"@anthropic-ai/sdk"|"openai"|"langchain"|"llama-index"'
    negative_pattern: 'audit|snyk|trivy|dependabot'
    message: "AI SDK dependency without vulnerability scanning configured."
    fix_action: "Add npm audit, Snyk, or Dependabot for dependency scanning"
    applies_to:
      - "package.json"
      - "requirements.txt"
      - "pyproject.toml"
