# DevOps Engineering Validations
# Automated checks to catch common DevOps mistakes

validations:
  - id: devops-latest-tag
    name: Latest Docker Tag
    severity: error
    type: regex
    pattern:
      - 'FROM\\s+\\w+:latest'
      - 'image:\\s*\\w+:latest'
    message: "Using :latest Docker tag. Builds will be inconsistent."
    fix_action: "Pin to specific version: node:20.11.0-alpine3.19"
    applies_to:
      - "Dockerfile"
      - "*.yaml"
      - "*.yml"

  - id: devops-npm-install-in-docker
    name: npm install Instead of npm ci
    severity: warning
    type: regex
    pattern:
      - 'RUN\\s+npm\\s+install(?!.*ci)'
    message: "Using npm install in Dockerfile. Use npm ci for deterministic builds."
    fix_action: "Change to: RUN npm ci"
    applies_to:
      - "Dockerfile"

  - id: devops-public-database
    name: Publicly Accessible Database
    severity: error
    type: regex
    pattern:
      - 'publicly_accessible\\s*=\\s*true'
    message: "Database marked publicly accessible. This is a security risk."
    fix_action: "Set publicly_accessible = false and use private subnets"
    applies_to:
      - "*.tf"

  - id: devops-open-security-group
    name: Security Group Open to Internet
    severity: error
    type: regex
    pattern:
      - 'cidr_blocks\\s*=\\s*\\[\\s*"0\\.0\\.0\\.0/0"\\s*\\]'
    message: "Security group allows traffic from entire internet (0.0.0.0/0)."
    fix_action: "Restrict to specific IP ranges or security groups"
    applies_to:
      - "*.tf"

  - id: devops-no-resource-limits
    name: Missing Resource Limits
    severity: warning
    type: regex
    pattern:
      - 'resources:\\s*\\{\\}'
      - 'resources:\\s*\\{\\s*\\}'
    message: "Container has no resource limits. Can cause node instability."
    fix_action: "Add resources.requests and resources.limits"
    applies_to:
      - "*.yaml"
      - "*.yml"

  - id: devops-single-replica
    name: Single Replica Deployment
    severity: warning
    type: regex
    pattern:
      - 'replicas:\\s*1(?!\\d)'
      - 'minReplicas:\\s*1(?!\\d)'
    message: "Single replica has no redundancy. Deploys will cause downtime."
    fix_action: "Use at least 2 replicas for high availability"
    applies_to:
      - "*.yaml"
      - "*.yml"

  - id: devops-tfstate-in-repo
    name: Terraform State in Repository
    severity: error
    type: file
    pattern: "*.tfstate"
    message: "Terraform state file should not be committed. Contains secrets."
    fix_action: "Add *.tfstate to .gitignore, use remote backend"
    applies_to:
      - "*"

  - id: devops-env-file-committed
    name: Environment File Committed
    severity: error
    type: file
    pattern: ".env"
    message: ".env file should not be committed. May contain secrets."
    fix_action: "Add .env to .gitignore, use .env.example for templates"
    applies_to:
      - "*"

  - id: devops-no-backup-retention
    name: No Backup Retention
    severity: warning
    type: regex
    pattern:
      - 'backup_retention_period\\s*=\\s*0'
    message: "Database has no backup retention. Data loss risk."
    fix_action: "Set backup_retention_period to at least 7 days"
    applies_to:
      - "*.tf"

  - id: devops-hardcoded-aws-key
    name: Hardcoded AWS Access Key
    severity: error
    type: regex
    pattern:
      - 'AKIA[A-Z0-9]{16}'
    message: "AWS access key hardcoded. Use IAM roles or environment variables."
    fix_action: "Remove hardcoded key, use IAM roles or ${{ secrets.AWS_ACCESS_KEY_ID }}"
    applies_to:
      - "*.tf"
      - "*.yaml"
      - "*.yml"
      - "*.ts"
      - "*.js"

  - id: devops-no-deletion-protection
    name: No Deletion Protection
    severity: warning
    type: regex
    pattern:
      - 'deletion_protection\\s*=\\s*false'
    message: "Database has deletion protection disabled. Accidental deletion possible."
    fix_action: "Set deletion_protection = true for production databases"
    applies_to:
      - "*.tf"

  - id: devops-unencrypted-storage
    name: Unencrypted Storage
    severity: warning
    type: regex
    pattern:
      - 'encrypt\\s*=\\s*false'
      - 'encrypted\\s*=\\s*false'
    message: "Storage encryption disabled. Data at rest should be encrypted."
    fix_action: "Set encrypt = true"
    applies_to:
      - "*.tf"

  - id: devops-no-health-check
    name: Missing Health Check
    severity: warning
    type: regex
    pattern:
      - 'spec:\\s*\\n\\s*containers:(?![\\s\\S]*(?:livenessProbe|readinessProbe))'
    message: "Container deployment without health checks."
    fix_action: "Add livenessProbe and readinessProbe"
    applies_to:
      - "*.yaml"
      - "*.yml"

  - id: devops-console-log-logging
    name: Console Log for Logging
    severity: warning
    type: regex
    pattern:
      - "console\\.log\\([^)]*\\+[^)]*\\)"
      - "console\\.log\\(`[^`]*\\$\\{"
    message: "Using console.log with string concatenation. Use structured logging."
    fix_action: "Use structured logger: logger.info({ key: value }, 'message')"
    applies_to:
      - "*.ts"
      - "*.js"
