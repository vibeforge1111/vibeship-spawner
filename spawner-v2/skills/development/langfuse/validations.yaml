# Langfuse Validations

validations:
  - id: no-flush
    name: Missing Langfuse Flush
    severity: high
    type: regex
    pattern: 'langfuse\.trace\('
    negative_pattern: 'langfuse\.flush\(\)|@observe'
    message: "Langfuse traces may be lost without flush() call."
    fix_action: "Add langfuse.flush() before script/function exit"
    applies_to:
      - "*.py"

  - id: no-user-id
    name: Trace Without User ID
    severity: medium
    type: regex
    pattern: 'langfuse\.trace\([^)]*\)'
    negative_pattern: 'user_id='
    message: "Traces should include user_id for better analytics."
    fix_action: "Add user_id parameter to trace()"
    applies_to:
      - "*.py"

  - id: dynamic-trace-name
    name: Dynamic Trace Name
    severity: medium
    type: regex
    pattern: 'name=f"[^"]*\{[^"]*\}"'
    message: "Dynamic trace names create high cardinality. Use metadata instead."
    fix_action: "Use static name and move variables to metadata parameter"
    applies_to:
      - "*.py"

  - id: no-usage-tracking
    name: Generation Without Usage
    severity: medium
    type: regex
    pattern: 'generation\([^)]*\)'
    negative_pattern: 'usage=|from langfuse\.openai'
    message: "Generation without usage data won't show costs."
    fix_action: "Add usage={input: X, output: Y} or use langfuse.openai wrapper"
    applies_to:
      - "*.py"

  - id: no-generation-model
    name: Generation Without Model
    severity: low
    type: regex
    pattern: '\.generation\([^)]*\)'
    negative_pattern: 'model='
    message: "Generation should specify model for proper cost calculation."
    fix_action: "Add model parameter to generation()"
    applies_to:
      - "*.py"

  - id: no-end-call
    name: Span Without End
    severity: high
    type: regex
    pattern: '\.generation\(|\.span\('
    negative_pattern: '\.end\(\)|@observe'
    message: "Spans should be ended to record duration."
    fix_action: "Call span.end() or generation.end() when complete"
    applies_to:
      - "*.py"

  - id: hardcoded-keys
    name: Hardcoded Langfuse Keys
    severity: high
    type: regex
    pattern: '(public_key|secret_key)=["\']pk-|sk-'
    message: "API keys should not be hardcoded. Use environment variables."
    fix_action: "Use LANGFUSE_PUBLIC_KEY and LANGFUSE_SECRET_KEY env vars"
    applies_to:
      - "*.py"

  - id: no-auth-check
    name: No Auth Check
    severity: low
    type: regex
    pattern: 'Langfuse\(\)'
    negative_pattern: 'auth_check'
    message: "Consider checking Langfuse auth on startup."
    fix_action: "Add langfuse.auth_check() to verify connection"
    applies_to:
      - "*.py"
