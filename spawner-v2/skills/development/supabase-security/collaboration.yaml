version: 1.0.0
skill_id: supabase-security

prerequisites:
  required: []
  recommended:
    - skill: supabase-backend
      reason: Database schema context
      what_to_know:
        - Table structure
        - Relationships between tables
        - Query patterns

    - skill: nextjs-supabase-auth
      reason: Auth implementation context
      what_to_know:
        - How users authenticate
        - Session management
        - Auth middleware setup

  knowledge:
    - SQL and PostgreSQL basics
    - Row Level Security concepts
    - OAuth and JWT tokens

delegation_triggers:
  - trigger: user needs auth flow implementation
    delegate_to: nextjs-supabase-auth
    context: Auth UI and session management

  - trigger: user needs database schema
    delegate_to: supabase-backend
    context: Table design and relationships

  - trigger: user needs query optimization
    delegate_to: postgres-wizard
    context: Performance tuning

receives_context_from:
  - skill: supabase-backend
    receives:
      - Table structure and relationships
      - Current RLS policies
      - Query patterns to secure

  - skill: nextjs-supabase-auth
    receives:
      - Auth flow being used
      - JWT claims structure
      - User roles and permissions

provides_context_to:
  - skill: supabase-backend
    provides:
      - RLS policy definitions
      - Security requirements
      - Index recommendations for policies

  - skill: nextjs-supabase-auth
    provides:
      - Required JWT claims for policies
      - Role-based access requirements
      - Token validation patterns

  - skill: security-owasp
    provides:
      - Database security posture
      - Access control patterns
      - Audit recommendations

workflow_integration:
  typical_sequence:
    1:
      step: Design database schema
      skills: [supabase-backend]
      output: Tables and relationships

    2:
      step: Enable RLS and create policies
      skills: [supabase-security]
      output: Secured tables

    3:
      step: Implement auth flow
      skills: [nextjs-supabase-auth]
      output: Working authentication

    4:
      step: Add storage security
      skills: [supabase-security]
      output: Secured file uploads

    5:
      step: Security audit
      skills: [supabase-security, security-owasp]
      output: Verified security

  decision_points:
    - question: Anon key or service role?
      guidance: |
        Anon key when:
        - Client-side queries
        - RLS should apply
        - Normal user operations

        Service role when:
        - Server-side admin operations
        - Background jobs
        - Need to bypass RLS

    - question: Private or public bucket?
      guidance: |
        Private bucket when:
        - User-specific files
        - Sensitive documents
        - Access control needed

        Public bucket when:
        - Truly public assets
        - No access control needed
        - CDN distribution

collaboration_patterns:
  with_nextjs:
    when: Next.js application
    approach: |
      1. Use @supabase/ssr for auth
      2. Verify tokens in middleware
      3. Service role only in Server Actions
      4. RLS policies match auth flow

  with_multi_tenant:
    when: SaaS with organizations
    approach: |
      1. Create org_members table
      2. Helper function for user_org_ids()
      3. All data tables have org_id
      4. Policies check org membership
      5. Index org_id and user_id columns

ecosystem:
  tools:
    - name: Supabase Dashboard
      use_when: View and edit policies
    - name: psql
      use_when: Test policies locally
    - name: Supabase CLI
      use_when: Manage migrations
