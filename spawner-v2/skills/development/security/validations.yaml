# Security Validations
# Automated checks to catch security vulnerabilities before they ship

validations:
  - id: sql-injection-template-literal
    name: SQL injection via template literal
    severity: critical
    type: regex
    pattern: "(SELECT|INSERT|UPDATE|DELETE|FROM|WHERE).*\\$\\{"
    message: "Potential SQL injection - use parameterized queries instead of template literals"
    fix_action: "Use parameterized queries: db.query('SELECT * FROM x WHERE id = $1', [id])"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: dangerous-innerhtml
    name: dangerouslySetInnerHTML usage
    severity: critical
    type: regex
    pattern: "dangerouslySetInnerHTML"
    message: "dangerouslySetInnerHTML can lead to XSS - ensure input is sanitized with DOMPurify"
    fix_action: "Use DOMPurify.sanitize() on the HTML content"
    applies_to:
      - "**/*.tsx"
      - "**/*.jsx"

  - id: eval-usage
    name: Eval function usage
    severity: critical
    type: regex
    pattern: "\\beval\\s*\\("
    message: "eval() executes arbitrary code - this is almost always a security vulnerability"
    fix_action: "Refactor to avoid eval - use JSON.parse for data, proper functions for logic"
    applies_to:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.tsx"
      - "**/*.jsx"

  - id: hardcoded-secrets
    name: Hardcoded API keys or secrets
    severity: critical
    type: regex
    pattern: "(api_key|apikey|secret|password|token|auth)\\s*[=:]\\s*['\"][^'\"]{16,}['\"]"
    message: "Potential hardcoded secret detected - use environment variables"
    fix_action: "Move to process.env.SECRET_NAME"
    applies_to:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.tsx"
      - "**/*.jsx"

  - id: stripe-keys-hardcoded
    name: Stripe keys in code
    severity: critical
    type: regex
    pattern: "sk_live_[a-zA-Z0-9]+|sk_test_[a-zA-Z0-9]+"
    message: "Stripe secret key in code - use environment variables"
    fix_action: "Use process.env.STRIPE_SECRET_KEY"
    applies_to:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.tsx"
      - "**/*.jsx"

  - id: mass-assignment
    name: Mass assignment vulnerability
    severity: error
    type: regex
    pattern: "\\.update\\([^)]*data:\\s*req\\.body|\\.create\\([^)]*data:\\s*req\\.body"
    message: "Mass assignment vulnerability - explicitly whitelist allowed fields"
    fix_action: "Destructure only allowed fields: const { name, email } = req.body"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: path-traversal
    name: Path traversal vulnerability
    severity: critical
    type: regex
    pattern: "path\\.(join|resolve).*req\\.(query|body|params)"
    message: "Potential path traversal - use path.basename() to sanitize input"
    fix_action: "Use path.basename() to strip directory traversal"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: jwt-no-algorithm
    name: JWT verification without algorithm
    severity: critical
    type: regex
    pattern: "jwt\\.verify\\s*\\([^)]+\\)(?!.*algorithms)"
    message: "JWT verification should specify allowed algorithms"
    fix_action: "Add { algorithms: ['HS256'] } or appropriate algorithm"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: cookie-no-httponly
    name: Cookie without HttpOnly
    severity: error
    type: regex
    pattern: "Set-Cookie.*(?!.*HttpOnly)"
    message: "Session cookies should have HttpOnly flag"
    fix_action: "Add HttpOnly to cookie flags"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: console-log-sensitive
    name: Console logging potentially sensitive data
    severity: warning
    type: regex
    pattern: "console\\.log\\s*\\([^)]*(?:password|token|secret|key|auth|bearer)[^)]*\\)"
    message: "Avoid logging sensitive data - it may appear in logs"
    fix_action: "Remove sensitive data from console.log or redact it"
    applies_to:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.tsx"
      - "**/*.jsx"

  - id: cors-star
    name: CORS allowing all origins
    severity: warning
    type: regex
    pattern: "origin:\\s*['\"]\\*['\"]|Access-Control-Allow-Origin.*\\*"
    message: "CORS * allows any origin - consider restricting to specific domains"
    fix_action: "Specify allowed origins explicitly"
    applies_to:
      - "**/*.ts"
      - "**/*.js"

  - id: exec-child-process
    name: Shell command execution
    severity: error
    type: regex
    pattern: "exec\\s*\\(|execSync\\s*\\(|spawn\\s*\\("
    message: "Shell command execution detected - ensure input is sanitized"
    fix_action: "Avoid user input in shell commands or use proper escaping"
    applies_to:
      - "**/*.ts"
      - "**/*.js"
