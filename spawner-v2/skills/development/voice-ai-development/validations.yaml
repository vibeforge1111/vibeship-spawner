# Voice AI Development Validations

validations:
  - id: no-streaming-tts
    name: Non-Streaming TTS
    severity: high
    type: regex
    pattern: 'await.*tts\.(synthesize|convert)\([^)]*\)'
    negative_pattern: 'stream|async for'
    message: "Non-streaming TTS adds significant latency."
    fix_action: "Use tts.synthesize_stream() or tts.convert_as_stream()"
    applies_to:
      - "*.py"

  - id: hardcoded-sample-rate
    name: Hardcoded Sample Rate
    severity: medium
    type: regex
    pattern: 'sample_rate\s*=\s*\d{4,5}'
    message: "Hardcoded sample rate may cause format mismatches."
    fix_action: "Define sample rates as constants, document expected formats"
    applies_to:
      - "*.py"

  - id: no-reconnection-logic
    name: WebSocket Without Reconnection
    severity: high
    type: regex
    pattern: 'websockets\.connect\('
    negative_pattern: 'while.*True|reconnect|retry'
    message: "WebSocket connections need reconnection logic."
    fix_action: "Add retry loop with exponential backoff"
    applies_to:
      - "*.py"

  - id: no-vad-configuration
    name: Missing VAD Configuration
    severity: medium
    type: regex
    pattern: 'turn_detection'
    negative_pattern: 'threshold|silence_duration'
    message: "VAD needs tuning for good user experience."
    fix_action: "Configure threshold and silence_duration_ms"
    applies_to:
      - "*.py"

  - id: blocking-audio-processing
    name: Blocking Audio Processing
    severity: high
    type: regex
    pattern: 'def process_audio|def transcribe'
    negative_pattern: 'async def'
    message: "Audio processing should be async to avoid blocking."
    fix_action: "Use async def and await for audio operations"
    applies_to:
      - "*.py"

  - id: no-interruption-handling
    name: Missing Interruption Handling
    severity: medium
    type: regex
    pattern: 'is_speaking|speaking'
    negative_pattern: 'interrupt|cancel|stop_speaking'
    message: "Voice agents should handle user interruptions."
    fix_action: "Add barge-in detection and cancel current response"
    applies_to:
      - "*.py"

  - id: audio-queue-no-clear
    name: Audio Queue Without Clear
    severity: low
    type: regex
    pattern: 'audio_queue|Queue\(\)'
    negative_pattern: 'clear|empty|get_nowait'
    message: "Audio queues should be clearable for interruptions."
    fix_action: "Add method to clear queue on interruption"
    applies_to:
      - "*.py"

  - id: no-error-handling-websocket
    name: WebSocket Without Error Handling
    severity: high
    type: regex
    pattern: 'await ws\.(send|recv)'
    negative_pattern: 'try:|except|ConnectionClosed'
    message: "WebSocket operations need error handling."
    fix_action: "Wrap in try/except for ConnectionClosed"
    applies_to:
      - "*.py"
