# Prompt Injection Defense Validations

validations:
  - id: no-input-sanitization
    name: Missing Input Sanitization
    severity: critical
    type: regex
    pattern: 'messages\.create\s*\(\{[^}]*content:\s*(?:req|user|input|body)\.'
    negative_pattern: 'sanitize|validate|filter|escape|detect'
    message: "User input passed directly to LLM without sanitization."
    fix_action: "Add input validation: await detector.detect(userInput)"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: rag-no-sanitization
    name: RAG Content Without Sanitization
    severity: critical
    type: regex
    pattern: 'retrieve|search\s*\([^)]+\)[^;]*(?:content|text|messages)'
    negative_pattern: 'sanitize|filter|isolate|validate'
    message: "Retrieved content passed to LLM without sanitization."
    fix_action: "Sanitize retrieved documents before including in context"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: verbose-injection-error
    name: Verbose Injection Detection Error
    severity: medium
    type: regex
    pattern: '(?:throw|return|send)\s*[^;]*(?:injection|blocked|detected)[^;]*pattern|reason|details'
    message: "Error messages reveal injection detection details to attacker."
    fix_action: "Return generic error: 'Request could not be processed'"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: single-layer-defense
    name: Single Layer Injection Defense
    severity: medium
    type: regex
    pattern: 'if\s*\([^)]*(?:includes|match|test)\s*\([^)]*ignore.*instruction'
    negative_pattern: 'semantic|behavioral|monitor|layer|multi'
    message: "Single pattern-based injection check. Easily bypassed."
    fix_action: "Implement multi-layer defense with semantic analysis and output monitoring"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-output-monitoring
    name: Missing Output Behavior Monitoring
    severity: medium
    type: regex
    pattern: 'response\.content|message\.content|completion\.text'
    negative_pattern: 'monitor|analyze|check|validate.*output|suspicious'
    message: "LLM output used without behavior monitoring."
    fix_action: "Monitor output for signs of successful injection"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: tool-no-validation
    name: Tool Calls Without Validation
    severity: critical
    type: regex
    pattern: 'tool_calls|function_call|toolCalls'
    negative_pattern: 'validate|allow|check|verify|permission'
    message: "Tool calls executed without validation."
    fix_action: "Validate tool calls against allowed list and check arguments"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: system-prompt-in-output
    name: System Prompt Exposure Risk
    severity: high
    type: regex
    pattern: 'system.*prompt|SYSTEM_PROMPT|systemPrompt'
    negative_pattern: 'private|secret|hidden|redact|mask'
    message: "System prompt may be extractable via prompt injection."
    fix_action: "Mark system prompt as sensitive, monitor for leakage"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-conversation-context-check
    name: No Multi-Turn Context Analysis
    severity: medium
    type: regex
    pattern: 'messages\.push|addMessage|appendMessage'
    negative_pattern: 'analyze.*conversation|multi.*turn|session.*check|cumulative'
    message: "Messages added without multi-turn injection analysis."
    fix_action: "Analyze full conversation context, not just latest message"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: external-content-no-isolation
    name: External Content Without Isolation
    severity: high
    type: regex
    pattern: '(?:fetch|axios|request|http)\s*\([^)]+\)[^;]*(?:content|text|body)[^;]*messages'
    negative_pattern: 'isolate|boundary|external.*content|untrusted'
    message: "External content added to context without isolation markers."
    fix_action: "Wrap external content with clear boundaries and untrusted labels"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: no-encoding-check
    name: No Encoded Injection Detection
    severity: medium
    type: regex
    pattern: 'detect.*injection|injection.*detect'
    negative_pattern: 'base64|encode|decode|unicode|homoglyph'
    message: "Injection detection doesn't check for encoded payloads."
    fix_action: "Add checks for Base64, URL encoding, Unicode homoglyphs"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"

  - id: unlimited-tool-access
    name: Unlimited Tool Access
    severity: critical
    type: regex
    pattern: 'tools:\s*(?:ALL_TOOLS|allTools|tools)'
    negative_pattern: 'filter|allow|limit|restrict|subset'
    message: "LLM has access to all tools without restriction."
    fix_action: "Limit tools to minimum required for task"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.py"
