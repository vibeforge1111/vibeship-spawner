# iOS/Swift Specialist Validations
# Automated checks for iOS development patterns

validations:
  - id: force-unwrap
    name: Force Unwrap in Production
    severity: error
    type: regex
    pattern:
      - '(?<!!)\!(?![=!])'
      - '\.unwrap\(\)'
    message: "Force unwrapping crashes when value is nil."
    fix_action: "Use guard-let, if-let, or nil coalescing"
    applies_to:
      - "**/*.swift"
    excludes:
      - "**/Tests/**"
      - "**/XCTests/**"

  - id: strong-self-closure
    name: Strong Self in Escaping Closure
    severity: error
    type: regex
    pattern:
      - '\{ self\.'
      - 'completion = \{(?!.*weak)'
    message: "Strong self in closure may cause retain cycle."
    fix_action: "Use [weak self] or [unowned self]"
    applies_to:
      - "**/*.swift"

  - id: main-thread-ui
    name: UI Update from Background Thread
    severity: error
    type: regex
    pattern:
      - 'DispatchQueue\.global.*self\..*view'
      - 'async.*\{.*self\.view'
    message: "UI updates must be on main thread."
    fix_action: "Use @MainActor or DispatchQueue.main"
    applies_to:
      - "**/*.swift"

  - id: userdefaults-sensitive
    name: Sensitive Data in UserDefaults
    severity: error
    type: regex
    pattern:
      - 'UserDefaults.*token'
      - 'UserDefaults.*password'
      - 'UserDefaults.*secret'
      - 'UserDefaults.*key'
    message: "Sensitive data should use Keychain, not UserDefaults."
    fix_action: "Use KeychainAccess or Security framework"
    applies_to:
      - "**/*.swift"

  - id: print-statement
    name: Print Statement in Production
    severity: warning
    type: regex
    pattern:
      - 'print\('
      - 'debugPrint\('
    message: "Print statements impact performance and expose data."
    fix_action: "Use os.log or structured logging"
    applies_to:
      - "**/*.swift"
    excludes:
      - "**/Tests/**"
      - "**/Debug/**"

  - id: try-force
    name: Force Try
    severity: warning
    type: regex
    pattern:
      - 'try!'
    message: "Force try crashes on error."
    fix_action: "Use do-catch or try?"
    applies_to:
      - "**/*.swift"
    excludes:
      - "**/Tests/**"

  - id: implicitly-unwrapped
    name: Implicitly Unwrapped Optional
    severity: info
    type: regex
    pattern:
      - ': [A-Z][a-zA-Z]+\!'
    message: "Implicitly unwrapped optionals are risky outside IBOutlets."
    fix_action: "Use regular optional or ensure initialization"
    applies_to:
      - "**/*.swift"

  - id: class-over-struct
    name: Class Where Struct Would Work
    severity: info
    type: regex
    pattern:
      - 'class [A-Z][a-zA-Z]+(?!.*:.*ViewController|.*:.*View)'
    message: "Consider struct for value types (no inheritance needed)."
    fix_action: "Use struct for data models without identity"
    applies_to:
      - "**/Models/**/*.swift"

  - id: massive-view-controller
    name: Large View Controller
    severity: info
    type: regex
    pattern:
      - 'class.*ViewController.*\{[\s\S]{5000,}'
    message: "Large view controller violates single responsibility."
    fix_action: "Extract to view model, coordinators, child VCs"
    applies_to:
      - "**/*ViewController.swift"

  - id: stringly-typed
    name: String-Based Identifier
    severity: warning
    type: regex
    pattern:
      - 'performSegue.*"[^"]+"'
      - 'dequeueReusableCell.*"[^"]+"'
      - 'Notification\.Name\("'
    message: "String identifiers are error-prone."
    fix_action: "Use static constants or generated identifiers"
    applies_to:
      - "**/*.swift"

  - id: deprecated-api
    name: Deprecated iOS API
    severity: info
    type: regex
    pattern:
      - 'UIApplication\.shared\.keyWindow'
      - 'statusBarStyle'
      - 'topLayoutGuide'
      - 'bottomLayoutGuide'
    message: "Using deprecated API that may be removed."
    fix_action: "Use modern equivalent (see Apple documentation)"
    applies_to:
      - "**/*.swift"

  - id: async-no-task
    name: Async Without Task Management
    severity: warning
    type: regex
    pattern:
      - 'Task \{(?!.*cancel)'
      - 'Task\.init'
    message: "Task without cancellation handling may leak."
    fix_action: "Store Task and cancel in deinit/disappear"
    applies_to:
      - "**/*.swift"
