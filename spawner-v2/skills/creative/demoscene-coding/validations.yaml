id: demoscene-coding
skill: Demoscene Coding
version: "1.0"

validations:
  - id: check-time-based-animation
    name: Time-Based Animation
    description: Animations should use time, not frame count
    pattern: "requestAnimationFrame|render|animate"
    file_glob: "**/*.{js,ts}"
    match: present
    context_pattern: "now|time|Date|performance"
    message: "Use time-based animation (pass 'now' from requestAnimationFrame)"
    severity: warning
    autofix: false

  - id: check-precision-qualifier
    name: GLSL Precision Qualifier
    description: GLSL shaders should specify precision explicitly
    pattern: "precision\\s+(lowp|mediump|highp)\\s+float"
    file_glob: "**/*.{glsl,frag,vert,js,ts}"
    match: present
    context_pattern: "void\\s+main|gl_FragColor|out\\s+vec4"
    message: "Add explicit precision qualifier to shader"
    severity: warning
    autofix: false

  - id: check-audio-context-interaction
    name: Audio Context User Interaction
    description: AudioContext should be created after user interaction
    pattern: "new\\s+AudioContext|audioContext\\.resume"
    file_glob: "**/*.{js,ts}"
    match: present
    context_pattern: "click|keydown|touchstart|onclick"
    message: "Create AudioContext only after user interaction (click, key, touch)"
    severity: error
    autofix: false

  - id: check-division-by-zero
    name: Division By Zero Guard
    description: Division operations should guard against zero
    pattern: "1\\.|length|distance|normalize"
    file_glob: "**/*.{glsl,frag,vert}"
    match: present
    context_pattern: "\\+\\s*0\\.0+1|max\\s*\\(|clamp|step"
    message: "Guard division by zero with epsilon or max()"
    severity: warning
    autofix: false

  - id: check-variable-initialization
    name: GLSL Variable Initialization
    description: Variables should be initialized to avoid undefined behavior
    pattern: "(float|vec[234]|mat[234])\\s+\\w+\\s*;"
    file_glob: "**/*.{glsl,frag,vert}"
    match: absent
    message: "Initialize variables to avoid undefined behavior"
    severity: warning
    autofix: false

  - id: check-webgl-context-fallback
    name: WebGL Context Fallback
    description: Should have fallback if WebGL2 unavailable
    pattern: "getContext\\(['\"]webgl2['\"]\\)"
    file_glob: "**/*.{js,ts}"
    match: present
    context_pattern: "getContext\\(['\"]webgl['\"]\\)|catch|fallback"
    message: "Add WebGL1 fallback for broader compatibility"
    severity: info
    autofix: false

  - id: check-viewport-resize
    name: Viewport Resize Handler
    description: Canvas should handle window resize
    pattern: "canvas\\.width|renderer\\.setSize|viewport"
    file_glob: "**/*.{js,ts}"
    match: present
    context_pattern: "resize|innerWidth|innerHeight"
    message: "Handle window resize for different display sizes"
    severity: warning
    autofix: false

  - id: check-audio-clipping
    name: Audio Gain Safety
    description: Multiple audio sources should be properly mixed to prevent clipping
    pattern: "createOscillator|createGain|connect"
    file_glob: "**/*.{js,ts}"
    match: present
    context_pattern: "gain\\.value|compressor|limiter|master"
    message: "Use proper gain staging or compressor to prevent audio clipping"
    severity: info
    autofix: false

  - id: check-loop-bounds
    name: Shader Loop Bounds
    description: Loops should have reasonable upper bounds
    pattern: "for\\s*\\(\\s*int\\s+\\w+\\s*=\\s*\\d+\\s*;[^;]+<\\s*(\\d+)"
    file_glob: "**/*.{glsl,frag,vert}"
    match: present
    message: "Ensure loop bounds are reasonable for all GPUs"
    severity: info
    autofix: false

  - id: check-texture-coord-safety
    name: Texture Coordinate Safety
    description: Texture coordinates should be clamped or wrapped
    pattern: "texture\\s*\\("
    file_glob: "**/*.{glsl,frag,vert}"
    match: present
    context_pattern: "fract|clamp|mod"
    message: "Ensure texture coordinates are properly wrapped or clamped"
    severity: info
    autofix: false

pre_commit:
  - id: shader-compile-check
    name: GLSL Shader Compile Check
    command: "npm run validate:shaders"
    description: Validate all GLSL shaders compile without errors

  - id: size-check
    name: Demo Size Check
    command: "npm run size:check"
    description: Verify demo size is within category limits

  - id: gpu-compatibility
    name: GPU Compatibility Lint
    command: "npm run lint:gpu"
    description: Check for common GPU compatibility issues

ci_checks:
  - id: multi-browser-test
    name: Multi-Browser WebGL Test
    command: "npm run test:browsers"
    description: Test on Chrome, Firefox, and Safari
    required: false

  - id: size-report
    name: Size Report
    command: "npm run size:report"
    description: Generate detailed size breakdown
    required: true

  - id: visual-diff
    name: Visual Regression Check
    command: "npm run test:visual"
    description: Compare output frames against reference
    required: false
