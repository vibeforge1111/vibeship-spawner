id: x402-payments
skill: HTTP 402 Payment Protocol
version: "1.0"

receives_from:
  - skill: api-designer
    receives:
      - API endpoint specifications
      - Rate limiting requirements
      - Authentication patterns
      - Response format standards
    provides:
      - 402 response format
      - Payment header conventions
      - Pricing tier integration
      - Metered billing patterns

  - skill: backend
    receives:
      - Server framework context
      - Database models
      - Session management approach
      - Middleware patterns
    provides:
      - Payment verification middleware
      - Receipt storage patterns
      - Webhook handling
      - Payment state management

  - skill: blockchain-defi
    receives:
      - DeFi protocol requirements
      - Token economics
      - Liquidity considerations
      - Smart contract context
    provides:
      - Payment channel design
      - Multi-token acceptance
      - On-chain settlement patterns
      - Fee optimization

  - skill: layer2-scaling
    receives:
      - L2 chain recommendations
      - Gas optimization patterns
      - Finality considerations
      - Bridge requirements
    provides:
      - L2 payment contracts
      - Streaming payment implementation
      - Cross-L2 payment routing
      - Confirmation requirements

  - skill: frontend
    receives:
      - UI component library
      - State management approach
      - User flow requirements
      - Mobile considerations
    provides:
      - Payment modal components
      - Wallet connection patterns
      - Invoice display widgets
      - Payment status indicators

  - skill: stripe-integration
    receives:
      - Fiat payment fallback needs
      - Subscription management
      - Billing portal integration
      - Webhook patterns
    provides:
      - Crypto-fiat hybrid flows
      - Multi-payment method UI
      - Receipt consolidation
      - Refund coordination

delegation_triggers:
  - pattern: "api.*design|rest|graphql|endpoint.*spec"
    delegate_to: api-designer
    context: "Design payment-gated API endpoints"

  - pattern: "lightning.*node|channel|routing|lnd"
    delegate_to: blockchain-defi
    context: "Lightning Network infrastructure setup"

  - pattern: "l2|layer.*2|optimism|base|arbitrum"
    delegate_to: layer2-scaling
    context: "L2 payment channel deployment"

  - pattern: "smart.*contract|solidity|deploy"
    delegate_to: evm-deep-dive
    context: "Payment contract development"

  - pattern: "frontend|ui|modal|checkout.*page"
    delegate_to: frontend
    context: "Payment UI implementation"

  - pattern: "database|storage|persist"
    delegate_to: backend
    context: "Payment data storage and state"

  - pattern: "fiat|credit.*card|stripe|fallback"
    delegate_to: stripe-integration
    context: "Fiat payment fallback integration"

  - pattern: "webhook|event|async.*process"
    delegate_to: event-architect
    context: "Payment event processing pipeline"

  - pattern: "auth|session|token.*manage"
    delegate_to: backend
    context: "Payment token session management"

  - pattern: "test|integration|e2e"
    delegate_to: test-architect
    context: "Payment flow testing strategy"

common_combinations:
  - name: API Monetization Platform
    skills:
      - x402-payments
      - api-designer
      - backend
      - analytics-architecture
    workflow: |
      1. Design API with metering points (api-designer)
      2. Implement payment gates (x402-payments)
      3. Store usage and billing (backend)
      4. Track payment metrics (analytics-architecture)

  - name: Lightning-First Content Platform
    skills:
      - x402-payments
      - frontend
      - blockchain-defi
    workflow: |
      1. Set up Lightning node infrastructure (blockchain-defi)
      2. Implement L402 payment flow (x402-payments)
      3. Build payment UI with WebLN (frontend)

  - name: L2 Streaming Payments
    skills:
      - x402-payments
      - layer2-scaling
      - evm-deep-dive
    workflow: |
      1. Choose L2 chain for payments (layer2-scaling)
      2. Deploy streaming payment contract (evm-deep-dive)
      3. Integrate payment verification (x402-payments)

  - name: Hybrid Crypto-Fiat Platform
    skills:
      - x402-payments
      - stripe-integration
      - frontend
      - backend
    workflow: |
      1. Implement crypto payments (x402-payments)
      2. Add Stripe fallback (stripe-integration)
      3. Build unified checkout UI (frontend)
      4. Reconcile receipts (backend)

  - name: Pay-Per-AI-Request
    skills:
      - x402-payments
      - api-designer
      - llm-architect
    workflow: |
      1. Design AI API endpoints (api-designer)
      2. Price per token/request (x402-payments)
      3. Optimize LLM costs (llm-architect)

cross_domain_insights:
  - domain: CDN and Edge Computing
    insight: |
      CDNs solved global content delivery with caching and edge.
      Payment verification can follow similar patterns:
      - Cache verified tokens at edge
      - Verify once, serve from cache
      - Geographic payment routing
    application: Edge-cached payment verification for low latency

  - domain: Telecommunications
    insight: |
      Telecom billing handles massive micropayment volumes:
      - Call Detail Records (CDRs) aggregate small charges
      - Prepaid vs postpaid models
      - Real-time rating engines
    application: Batch micropayments into periodic settlements

  - domain: Gaming Economies
    insight: |
      Games have solved in-game currency UX:
      - Buy virtual currency once, spend freely
      - Instant purchases, no friction
      - Clear value exchange visualization
    application: Pre-loaded payment credits for frictionless spending

  - domain: Public Transit
    insight: |
      Transit payment systems handle millions of daily micropayments:
      - Contactless tap-and-go
      - Post-payment aggregation
      - Lost transaction tolerance
    application: Accept-then-verify for speed, reconcile async

  - domain: Advertising Technology
    insight: |
      Programmatic ads process billions of micropayments:
      - Real-time bidding (RTB) at millisecond speed
      - Aggregated settlements
      - Fraud detection at scale
    application: Sub-second payment decisions with batch settlement

ecosystem_alternatives:
  lightning_implementations:
    - name: LND
      when: Most mature, best for custom integrations
      tradeoff: Resource heavy, complex setup
    - name: Core Lightning
      when: Plugin ecosystem, lighter weight
      tradeoff: Smaller community
    - name: LDK
      when: Building wallet/node from scratch
      tradeoff: More development work

  l2_payment_chains:
    - name: Base
      when: Coinbase integration, US users
      tradeoff: More centralized
    - name: Optimism
      when: OP Stack ecosystem
      tradeoff: 7-day withdrawal delay
    - name: Arbitrum
      when: Largest TVL, most dApps
      tradeoff: More complex architecture
    - name: zkSync
      when: ZK security, account abstraction
      tradeoff: Different EVM behavior

  stablecoins:
    - name: USDC
      when: Regulatory clarity, Circle backing
      tradeoff: Centralized freeze capability
    - name: USDT
      when: Highest liquidity
      tradeoff: Less transparent reserves
    - name: DAI
      when: Decentralized, DeFi native
      tradeoff: Slight depeg risk

  payment_protocols:
    - name: L402 (LSAT)
      when: Lightning-native, macaroon-based
      tradeoff: Lightning-only
    - name: Web Monetization
      when: Streaming micropayments
      tradeoff: Limited wallet support
    - name: Custom 402
      when: Full control, any payment method
      tradeoff: More implementation work

feedback_loops:
  - from: api-designer
    incorporates:
      - API design patterns
      - Response format standards
      - Rate limiting approaches
    into: Payment endpoint design

  - from: frontend
    incorporates:
      - User experience insights
      - Conversion data
      - Wallet compatibility issues
    into: Payment flow optimization

  - from: analytics-architecture
    incorporates:
      - Payment success rates
      - Abandonment points
      - Revenue metrics
    into: Pricing and UX improvements

  - from: layer2-scaling
    incorporates:
      - Gas cost changes
      - New L2 options
      - Finality improvements
    into: L2 payment recommendations

prerequisites:
  required_skills:
    - Understanding of HTTP headers and status codes
    - Basic cryptography (hashing, signatures)
    - Async JavaScript/TypeScript
    - REST API design

  recommended_tools:
    - Lightning wallet (Phoenix, Muun for testing)
    - Browser wallet extension (MetaMask, Rabby)
    - LND or Core Lightning (for server-side)
    - Viem/ethers.js (for L2 payments)

  environment_setup: |
    # Lightning development (regtest)
    polar # Local Lightning network simulator
    # Or use Voltage for hosted testnet

    # L2 development
    export BASE_SEPOLIA_RPC="https://sepolia.base.org"
    export TESTNET_PRIVATE_KEY="..."

    # Libraries
    npm install @lightninglabs/lnc-web  # Lightning
    npm install viem wagmi              # L2
    npm install macaroon                # L402 tokens

    # Testing tools
    npm install -D @playwright/test     # E2E payment flows

    # Environment variables needed
    LIGHTNING_RPC_HOST=
    LIGHTNING_MACAROON=
    MACAROON_SECRET_KEY=
    L2_RPC_URL=
    PAYMENT_PRIVATE_KEY=

future_considerations:
  emerging_standards:
    - name: WebLN Standardization
      status: Active development
      impact: Universal browser Lightning support
    - name: L402 IETF RFC
      status: Draft
      impact: Industry-standard HTTP payment protocol
    - name: Bolt 12 (Offers)
      status: Implemented in CLN
      impact: Reusable payment requests

  technology_trends:
    - name: Account Abstraction
      impact: Gasless payments, social recovery
    - name: ZK Rollups
      impact: Instant finality, lower costs
    - name: Stablecoin Regulations
      impact: May require KYC for larger payments

  integration_opportunities:
    - name: AI Agent Payments
      description: Autonomous agents paying for resources
    - name: IoT Micropayments
      description: Machine-to-machine payments
    - name: Streaming Economy
      description: Per-second billing for all services
