id: solana-development
skill: Solana Development
version: "1.0"

validations:
  - id: check-account-ownership
    name: Account Ownership Verification
    description: Ensure accounts verify ownership before access
    pattern: "Account<'info"
    file_glob: "**/*.rs"
    match: absent_in_context
    context_pattern: "constraint.*owner|has_one"
    message: "Account should verify ownership with constraint or has_one"
    severity: error
    autofix: false

  - id: check-signer-required
    name: Signer Type for Authority
    description: Authority accounts should use Signer type
    pattern: "pub.*authority.*AccountInfo"
    file_glob: "**/lib.rs"
    match: present
    message: "Use Signer<'info> instead of AccountInfo for authority accounts"
    severity: error
    autofix: false

  - id: check-checked-math
    name: Checked Arithmetic Operations
    description: Use checked_add/sub/mul/div for arithmetic
    pattern: "\\b(balance|amount|quantity|total|sum)\\s*[+\\-*/]=?\\s*\\w+"
    file_glob: "**/*.rs"
    match: present
    message: "Use checked arithmetic (checked_add, checked_sub) for token amounts"
    severity: warning
    autofix: false

  - id: check-pda-seeds
    name: PDA Seeds Include User Context
    description: PDA seeds should include user-specific data
    pattern: "seeds\\s*=\\s*\\[b\"\\w+\"\\]\\s*,?\\s*bump"
    file_glob: "**/*.rs"
    match: present
    message: "PDA seeds should include user pubkey or unique identifier"
    severity: warning
    autofix: false

  - id: check-rent-exemption
    name: Rent Exemption Calculation
    description: New accounts should calculate rent exemption
    pattern: "init\\s*,"
    file_glob: "**/*.rs"
    match: present
    context_pattern: "space\\s*="
    message: "init accounts must specify space for rent calculation"
    severity: error
    autofix: false

  - id: check-close-zero-data
    name: Zero Data Before Close
    description: Accounts should be zeroed before closing
    pattern: "close\\s*="
    file_glob: "**/*.rs"
    match: present
    message: "Consider zeroing account data before closing to prevent resurrection"
    severity: warning
    autofix: false

  - id: check-cpi-program-id
    name: CPI Program ID Verification
    description: Verify program ID before cross-program invocation
    pattern: "CpiContext::new"
    file_glob: "**/*.rs"
    match: present
    context_pattern: "Program<'info|key\\(\\).*==.*ID"
    message: "Verify target program ID before CPI"
    severity: warning
    autofix: false

  - id: check-compute-budget
    name: Compute Budget Instructions
    description: Complex transactions should set compute budget
    pattern: "ComputeBudgetProgram"
    file_glob: "**/*.ts"
    match: absent
    context_pattern: "transaction|sendTransaction"
    message: "Consider setting compute budget for complex transactions"
    severity: info
    autofix: false

  - id: check-error-codes
    name: Custom Error Codes
    description: Programs should define custom error codes
    pattern: "#\\[error_code\\]"
    file_glob: "**/lib.rs"
    match: absent
    message: "Define custom error codes for better debugging"
    severity: warning
    autofix: false

  - id: check-event-emission
    name: Event Emission for State Changes
    description: State changes should emit events for indexing
    pattern: "emit!"
    file_glob: "**/*.rs"
    match: absent_in_context
    context_pattern: "pub fn.*->.*Result"
    message: "Consider emitting events for off-chain indexing"
    severity: info
    autofix: false

pre_commit:
  - id: anchor-build
    name: Anchor Build Check
    command: "anchor build"
    description: Verify program compiles

  - id: anchor-test
    name: Anchor Test Suite
    command: "anchor test --skip-local-validator"
    description: Run test suite

  - id: cargo-clippy
    name: Clippy Lints
    command: "cargo clippy --all-targets -- -D warnings"
    description: Check for common Rust issues

ci_checks:
  - id: security-audit
    name: Security Audit
    command: "cargo audit"
    description: Check for known vulnerabilities
    required: true

  - id: program-size
    name: Program Size Check
    command: "ls -la target/deploy/*.so | awk '{print $5}'"
    description: Verify program is under size limit
    max_bytes: 1400000

  - id: idl-generation
    name: IDL Generation
    command: "anchor idl parse -o target/idl"
    description: Generate and verify IDL
