# Sharp Edges - RWA Tokenization
# Critical pitfalls that can destroy your project or land you in legal trouble

id: rwa-tokenization
version: "1.0.0"

sharp_edges:
  # CRITICAL SEVERITY - Project-ending risks
  - id: unregistered-securities-offering
    severity: critical
    title: "Unregistered Securities Offering"
    description: |
      Selling tokens that represent real-world assets without proper
      securities registration or exemption is a federal crime. The SEC
      has shut down hundreds of projects and pursued criminal charges.
    symptoms:
      - "We're not a security because it's on blockchain"
      - "We'll call it a utility token"
      - "Only selling to our community, not the public"
      - "We're outside the US so SEC doesn't apply"
    why_dangerous: |
      The Howey Test doesn't care about your terminology. If investors
      are putting money into a common enterprise expecting profits from
      others' efforts, it's a security. Period.

      Consequences:
      - SEC enforcement action
      - Criminal referral to DOJ
      - Investor rescission rights (must return all money)
      - Personal liability for founders
      - Permanent industry ban
    prevention:
      - Always work with securities counsel BEFORE token design
      - Assume you ARE a security until counsel confirms otherwise
      - File proper exemption (Reg D, Reg S, Reg A+)
      - Use compliant platforms (Securitize, Tokeny, etc.)
    detection_patterns:
      - "permissionless.*transfer"
      - "anyone.*can.*buy"
      - "no.*kyc.*required"
      - "utility.*token.*represents.*ownership"

  - id: transfer-agent-bypass
    severity: critical
    title: "Bypassing Transfer Agent Requirements"
    description: |
      In the US, SEC Rule 17Ad requires registered transfer agents for
      securities. The blockchain cannot replace this legal requirement.
      Your on-chain transfers must reconcile with official records.
    symptoms:
      - "The blockchain IS the shareholder registry"
      - "We don't need a transfer agent, it's decentralized"
      - "Smart contract handles all record-keeping"
    why_dangerous: |
      Without a registered transfer agent:
      - Token transfers may not be legally valid
      - Investors may not have enforceable rights
      - Corporate actions (dividends, votes) may be invalid
      - SEC can halt all trading

      Transfer agents provide:
      - Legal shareholder registry
      - Lost token recovery
      - Estate processing
      - Court order compliance
    prevention:
      - Partner with registered transfer agent (Securitize, tZero, etc.)
      - Build integration bridge, not replacement
      - Sync on-chain and off-chain records
      - Transfer agent approves or can block transfers
    detection_patterns:
      - "no.*transfer.*agent"
      - "blockchain.*replaces.*registry"
      - "decentralized.*cap.*table"

  - id: oracle-single-point-of-failure
    severity: critical
    title: "Single Oracle for Asset Valuation"
    description: |
      Real-world assets need off-chain data (valuations, ownership status,
      physical condition). A single oracle point of failure can break your
      entire token's connection to reality.
    symptoms:
      - Using one appraiser's API for all valuations
      - No staleness checks on oracle data
      - No circuit breakers for price anomalies
      - Oracle updates controlled by single key
    why_dangerous: |
      Oracle failure scenarios:
      - Oracle goes stale (price doesn't update) -> arbitrage attack
      - Oracle is compromised -> false valuations
      - Oracle provider goes bankrupt -> no data source
      - Flash manipulation -> incorrect NAV

      For a $100M real estate token with stale oracle:
      - Arbitrageurs buy cheap tokens
      - Redeem at stale (higher) price
      - Protocol takes the loss
    prevention:
      - Multiple oracle sources with aggregation
      - Staleness thresholds (halt if data > X hours old)
      - Price deviation circuit breakers (halt if > 10% change)
      - Manual override capability for emergencies
      - Decentralized oracle networks where possible
    detection_patterns:
      - "single.*oracle"
      - "oracle\\.get.*Price\\(\\).*without.*staleness"
      - "trustedOracle"
      - "owner.*can.*set.*price"

  - id: custody-gap
    severity: critical
    title: "Gap Between Token and Asset Custody"
    description: |
      A token is only as valuable as the legal claim it represents. If
      the underlying asset isn't properly custodied, token holders have
      nothing.
    symptoms:
      - "Trust us, we own the real estate"
      - No third-party custodian
      - No proof of reserves
      - Asset held in founder's personal name
    why_dangerous: |
      Without proper custody:
      - Issuer can sell asset without token holder consent
      - Bankruptcy doesn't protect token holders
      - No recourse if asset disappears
      - Due diligence is impossible

      Famous failures:
      - Multiple "gold-backed" tokens with no actual gold
      - Real estate tokens where property was never transferred
      - Art tokens where art was sold separately
    prevention:
      - Third-party qualified custodian
      - Regular proof of reserves audits
      - Legal structure that isolates assets (SPV per asset)
      - On-chain attestations from custodian
      - Insurance coverage
    detection_patterns:
      - "trust.*the.*issuer"
      - "no.*custodian"
      - "self.*custody.*of.*underlying"

  # HIGH SEVERITY - Serious regulatory and operational risks
  - id: holding-period-violation
    severity: high
    title: "Holding Period Non-Enforcement"
    description: |
      Most private securities have mandatory holding periods before resale.
      Reg D requires 12 months. Reg S has distribution compliance periods.
      Rule 144 has 6-12 month holding periods.
    symptoms:
      - Immediate trading enabled after purchase
      - No tracking of acquisition dates
      - Same transfer rules for all investors
      - "Holding periods are just guidance"
    why_dangerous: |
      Holding period violations:
      - Create rescission rights for ALL investors
      - Violate the exemption (offering becomes unregistered)
      - Personal liability for issuer officers
      - SEC can require unwinding of all trades

      These violations often surface during audits or when
      investors try to exit and realize their tokens are tainted.
    prevention:
      - Track acquisition date per token
      - Enforce holding periods in transfer logic
      - Different rules for primary vs secondary sales
      - Whitelist qualified transferees during holding period
    detection_patterns:
      - "transfer.*without.*holding.*period"
      - "immediate.*liquidity"
      - "no.*lockup"

  - id: investor-count-explosion
    severity: high
    title: "Exceeding Investor Limits"
    description: |
      Reg D 506(b) limits non-accredited investors to 35. Exceeding this
      voids the exemption. 506(c) requires ALL investors to be verified
      accredited. Section 12(g) triggers at 2000 investors or $10M assets.
    symptoms:
      - Not tracking investor counts by qualification
      - Allowing unlimited transfers
      - No checks before new investor onboarding
      - "We'll deal with limits later"
    why_dangerous: |
      Investor limit violations:
      - 506(b) with 36+ non-accredited = exemption void
      - 506(c) with one non-accredited = exemption void
      - 2000+ holders = mandatory SEC registration
      - These cannot be fixed retroactively
    prevention:
      - On-chain tracking of investor counts by type
      - Block transfers that would exceed limits
      - Re-verify accreditation periodically
      - Monitor for 12(g) threshold
    detection_patterns:
      - "no.*investor.*limit"
      - "unlimited.*transfers"
      - "count.*investors.*after"

  - id: cross-border-compliance-failure
    severity: high
    title: "Cross-Border Regulatory Violations"
    description: |
      Each jurisdiction has its own securities laws. A token legal in the
      US under Reg D may be illegal in the EU without proper prospectus.
      Reg S carve-outs have strict flow-back restrictions.
    symptoms:
      - "We're US-based so only US law matters"
      - No jurisdiction checks in transfer logic
      - Reg S tokens flowing back to US persons
      - Selling to retail in MiCA-regulated jurisdictions
    why_dangerous: |
      Multi-jurisdictional failures:
      - EU regulators can block your token
      - Reg S flow-back voids the exemption
      - Each violation is a separate offense
      - Investors in one country can't be made whole

      I've seen a token that was compliant in US but violated
      securities laws in 8 other countries where investors resided.
    prevention:
      - Jurisdiction mapping in identity registry
      - Transfer restrictions by geography
      - Reg S flow-back prevention (12 month distribution compliance)
      - Local counsel in major investor markets
      - Geofencing for token purchases
    detection_patterns:
      - "no.*jurisdiction.*check"
      - "global.*offering"
      - "anyone.*worldwide"

  - id: kyc-expiration-blind-spot
    severity: high
    title: "Stale KYC/AML Verification"
    description: |
      KYC verification is not one-time. Accredited investor status changes,
      PEP status changes, sanctions lists update. Stale verification creates
      compliance gaps.
    symptoms:
      - One-time KYC at onboarding
      - No expiration on verification claims
      - No re-verification process
      - Not monitoring sanctions list updates
    why_dangerous: |
      Stale KYC issues:
      - Investor loses accredited status (divorce, job loss)
      - Investor added to sanctions list (OFAC)
      - Investor becomes PEP (political appointment)
      - AML red flags emerge after onboarding

      Regulators expect ongoing monitoring, not point-in-time checks.
    prevention:
      - 90-day verification expiration
      - Automated re-verification triggers
      - Sanctions screening on every transfer
      - Accreditation re-attestation annually
      - Pause transfers for expired verifications
    detection_patterns:
      - "verified.*=.*true.*permanent"
      - "no.*expiration"
      - "kyc.*once"

  - id: dividend-calculation-errors
    severity: high
    title: "Dividend/Distribution Calculation Errors"
    description: |
      Incorrect dividend calculations create accounting nightmares, tax
      issues, and potential securities violations. Rounding errors at
      scale become material.
    symptoms:
      - Integer division without precision handling
      - No record date snapshot
      - Dust accumulation in contract
      - Missing tax withholding logic
    why_dangerous: |
      Calculation errors cause:
      - Investors receive wrong amounts
      - Tax withholding mismatches (IRS issues)
      - Unclaimed dividends stuck forever
      - Audit failures

      At 10,000 investors, a $0.01 rounding error per distribution
      is $100 per cycle. Over 4 quarterly distributions, that's $400
      per year unaccounted for.
    prevention:
      - Use high precision (18 decimals minimum)
      - Proper rounding with dust collection
      - Snapshot balances at record date
      - Claim period with unclaimed recovery
      - Tax withholding by jurisdiction
    detection_patterns:
      - "amount.*\\/.*supply"  # Integer division
      - "no.*snapshot"
      - "no.*withholding"

  # MEDIUM SEVERITY - Operational issues
  - id: upgrade-without-governance
    severity: medium
    title: "Upgradeable Contracts Without Governance"
    description: |
      Compliance modules often need updates (new regulations, new
      jurisdictions). But upgrades without proper governance create
      centralization and trust issues.
    symptoms:
      - Single admin can upgrade any contract
      - No timelock on upgrades
      - No investor notification
      - Compliance rules can change silently
    why_dangerous: |
      Governance failures:
      - Admin can add themselves to whitelist
      - Compliance modules can be gutted
      - Investors don't know rules changed
      - Audit trail is broken

      "Trust me" doesn't work in securities. Investors need
      assurance that rules won't change arbitrarily.
    prevention:
      - Multi-sig governance for upgrades
      - Timelock (48-72 hours minimum)
      - On-chain upgrade proposals
      - Investor notification system
      - Immutable core rights
    detection_patterns:
      - "owner.*can.*upgrade"
      - "no.*timelock"
      - "single.*admin"

  - id: missing-forced-transfer
    severity: medium
    title: "No Forced Transfer Mechanism"
    description: |
      Legal systems require the ability to execute court orders, estate
      transfers, and regulatory seizures. Tokens without this capability
      may be non-compliant.
    symptoms:
      - Only voluntary transfers supported
      - "Private keys are sacred"
      - No freeze capability
      - No recovery for lost keys
    why_dangerous: |
      Missing forced transfer creates:
      - Court order non-compliance
      - Estate settlement impossible
      - Regulatory seizure blocked
      - Lost key = permanent loss

      Securities law requires issuers to comply with legal orders.
      A token that cannot do this is problematic.
    prevention:
      - Agent role with forced transfer capability
      - Freeze/unfreeze for investigations
      - Recovery mechanism for lost keys
      - Audit trail for all forced actions
      - Legal document hash requirement
    detection_patterns:
      - "only.*owner.*can.*transfer"
      - "no.*agent.*role"
      - "no.*freeze"

  - id: secondary-market-blind-spot
    severity: medium
    title: "Unplanned Secondary Market"
    description: |
      If your token can trade on secondary markets, you need to plan for
      it. Uncontrolled secondary trading may require ATS registration
      or broker-dealer involvement.
    symptoms:
      - "We'll figure out secondary later"
      - Tokens can be transferred to any DEX
      - No exchange/ATS relationship
      - Market making without BD license
    why_dangerous: |
      Secondary market issues:
      - Unlicensed exchange operation
      - Market manipulation liability
      - No trade surveillance
      - Price discovery problems

      Operating an exchange without registration is a serious offense.
      Even "decentralized" venues have faced enforcement.
    prevention:
      - Plan secondary strategy from day one
      - Partner with registered ATS
      - Whitelist only compliant venues
      - Implement trade surveillance
      - Consider bulletin board only initially
    detection_patterns:
      - "any.*exchange"
      - "dex.*listing"
      - "permissionless.*trading"

  # LOW SEVERITY - Best practice violations
  - id: missing-audit-trail
    severity: low
    title: "Insufficient Audit Trail"
    description: |
      Regulators expect complete audit trails. Every transfer, every
      verification, every compliance check should be logged with
      enough detail to reconstruct history.
    symptoms:
      - Minimal event emissions
      - No reason codes for rejections
      - No timestamp on verifications
      - No document hash linking
    why_dangerous: |
      Audit failures cause:
      - Regulatory exam complications
      - Inability to prove compliance
      - Dispute resolution difficulties
      - Costly manual reconstruction
    prevention:
      - Comprehensive event emissions
      - Reason codes for all rejections
      - Document hash linking
      - Indexed events for efficient querying
      - Off-chain event storage
    detection_patterns:
      - "no.*event"
      - "silent.*failure"
      - "no.*reason.*code"

  - id: gas-optimization-over-compliance
    severity: low
    title: "Optimizing Gas at Expense of Compliance"
    description: |
      Gas optimization is important, but not at the cost of compliance
      checks. Skipping verifications to save gas creates vulnerabilities.
    symptoms:
      - Batched transfers skip individual checks
      - "Gas efficient mode" bypasses compliance
      - Cached verification to avoid re-checks
      - "We check off-chain before on-chain"
    why_dangerous: |
      Gas shortcuts create:
      - Compliance bypass vectors
      - Race condition vulnerabilities
      - Audit findings
      - Potential enforcement issues

      Regulators don't care about gas costs. They care about compliance.
    prevention:
      - Always check compliance on-chain
      - Optimize within compliance bounds
      - If batching, still check each transfer
      - Layer 2 for gas reduction, not fewer checks
    detection_patterns:
      - "skip.*compliance.*batch"
      - "gas.*efficient.*mode"
      - "cached.*verification"

stack_specific_edges:
  erc3643:
    - id: identity-registry-desync
      severity: high
      title: "Identity Registry Desync"
      description: |
        If Identity Registry becomes desynced with actual investor
        KYC status, transfers can be blocked or incorrectly allowed.
      prevention:
        - Automated sync with KYC provider
        - Regular reconciliation checks
        - Alert on verification expiration
        - Manual override with audit trail

  polygon:
    - id: bridge-compliance-gap
      severity: high
      title: "L1-L2 Bridge Compliance Gap"
      description: |
        When bridging RWA tokens between L1 and L2, compliance checks
        must be enforced on both sides. A token compliant on L1 may
        bypass checks when bridging to L2.
      prevention:
        - Mirror compliance contracts on L2
        - Bridge enforces same transfer restrictions
        - Identity registry synced across chains
        - Block bridging to non-compliant chains

  real_estate:
    - id: property-lifecycle-events
      severity: medium
      title: "Property Lifecycle Not Reflected"
      description: |
        Real estate has lifecycle events (refinancing, renovations,
        insurance claims, tenant changes) that affect value but may
        not be reflected in token state.
      prevention:
        - Oracle updates for material events
        - Governance for major decisions
        - Regular property audits
        - NAV recalculation triggers

regulatory_jurisdiction_edges:
  united_states:
    - id: state-blue-sky-laws
      severity: high
      title: "State Blue Sky Law Non-Compliance"
      description: |
        Federal exemptions don't automatically preempt state laws.
        Some states require notice filings, fees, or have their own
        accredited investor definitions.
      prevention:
        - Blue sky filing in each state with investors
        - State-specific investor qualifications
        - Notice filing automation
        - State fee payment tracking

  european_union:
    - id: mica-classification
      severity: high
      title: "MiCA Token Classification Error"
      description: |
        Under MiCA, RWA tokens may be classified as asset-referenced
        tokens (ARTs) which have specific reserve and licensing
        requirements.
      prevention:
        - Legal classification before launch
        - ART license if required
        - Reserve requirements compliance
        - Whitepaper requirements

  singapore:
    - id: mas-digital-token-offering
      severity: high
      title: "MAS Digital Token Offering Requirements"
      description: |
        Singapore has specific requirements for digital token offerings
        including prospectus requirements and recognized market operator
        licensing for secondary trading.
      prevention:
        - MAS registration or exemption
        - Prospectus if not exempt
        - RMO license for trading platform
        - Ongoing reporting requirements
