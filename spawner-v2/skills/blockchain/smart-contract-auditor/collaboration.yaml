# Collaboration - Smart Contract Auditor
# How this skill works with other blockchain skills

version: 1.0.0
skill_id: smart-contract-auditor

prerequisites:
  required:
    - skill: evm-deep-dive
      reason: "Understanding EVM internals is essential for identifying storage collisions, gas-based attacks, and opcode-level vulnerabilities"
    - skill: blockchain-defi
      reason: "DeFi protocol patterns and economic models are common audit targets - must understand how they're supposed to work"

  recommended:
    - skill: solana-development
      reason: "For auditing Solana programs - different security model (account ownership, PDA validation)"
    - skill: token-launch
      reason: "Token contracts are frequent audit targets with specific vulnerability patterns"
    - skill: dao-governance
      reason: "Governance attacks require understanding voting mechanisms and timelock patterns"

receives_from:
  - skill: token-launch
    receives:
      - Token contract source code
      - Deployment configuration
      - Vesting schedule contracts
      - Liquidity provision mechanics
    provides:
      - Vulnerability assessment report
      - Severity classifications (Critical/High/Medium/Low/Info)
      - Remediation recommendations with code examples
      - Gas optimization suggestions (when safe)

  - skill: blockchain-defi
    receives:
      - DeFi protocol architecture
      - Smart contract implementations
      - Oracle integration patterns
      - Liquidity pool mechanics
    provides:
      - Economic attack vector analysis
      - Flash loan vulnerability assessment
      - Oracle manipulation risk analysis
      - Reentrancy and access control findings

  - skill: evm-deep-dive
    receives:
      - Optimized contract code for review
      - Gas-saving techniques to validate
      - Assembly blocks requiring scrutiny
      - Proxy implementations
    provides:
      - Security assessment of optimizations
      - Confirmation that gas savings don't introduce vulnerabilities
      - Storage collision analysis
      - Delegatecall security review

  - skill: dao-governance
    receives:
      - Governance contract implementations
      - Voting mechanism designs
      - Timelock configurations
      - Treasury management contracts
    provides:
      - Governance attack vector analysis
      - Flash loan voting protection review
      - Timelock bypass vulnerability check
      - Proposal execution security assessment

  - skill: nft-systems
    receives:
      - NFT contract implementations
      - Marketplace contracts
      - Royalty enforcement mechanisms
      - Metadata handling
    provides:
      - Reentrancy analysis for marketplace interactions
      - Access control review for minting functions
      - Metadata manipulation risk assessment
      - Signature verification security

  - skill: cross-chain
    receives:
      - Bridge contract implementations
      - Cross-chain message handling
      - Multi-chain deployment configurations
      - Relayer trust assumptions
    provides:
      - Bridge security assessment
      - Message validation analysis
      - Replay attack prevention review
      - Trust assumption documentation

  - skill: perpetuals-trading
    receives:
      - Perpetual futures contract implementations
      - Funding rate calculations
      - Liquidation mechanisms
      - Margin handling logic
    provides:
      - Liquidation cascade vulnerability assessment
      - Price manipulation attack analysis
      - Funding rate manipulation review
      - Margin calculation precision analysis

  - skill: solana-development
    receives:
      - Anchor program source code
      - PDA derivation logic
      - CPI implementations
      - Account validation patterns
    provides:
      - Account ownership validation review
      - PDA seed uniqueness analysis
      - CPI authority verification
      - Signer privilege escalation assessment

delegation_triggers:
  - condition: "Need EVM opcode-level optimization after security fixes"
    delegate_to: evm-deep-dive
    context: "Pass vulnerability fixes that may need gas optimization review"

  - condition: "Reviewing Solana/Anchor program security"
    delegate_to: solana-development
    context: "Provide Rust program code and specific concern areas"

  - condition: "Economic attack modeling for DeFi protocol"
    delegate_to: blockchain-defi
    context: "Share protocol mechanics and potential attack vectors to validate"

  - condition: "Token launch requires security sign-off"
    delegate_to: token-launch
    context: "Provide audit report and remediation status"

  - condition: "Governance mechanism design review"
    delegate_to: dao-governance
    context: "Share governance attack analysis and recommended mitigations"

  - condition: "Bridge or cross-chain security assessment"
    delegate_to: cross-chain
    context: "Provide message handling analysis and trust assumptions"

  - condition: "Setting up security monitoring post-deployment"
    delegate_to: onchain-analytics
    context: "Share critical invariants and event patterns to monitor"

collaboration_patterns:
  - name: "Full Security Audit Pipeline"
    skills:
      - smart-contract-auditor
      - evm-deep-dive
      - blockchain-defi
      - onchain-analytics
    workflow: |
      1. Initial code review (smart-contract-auditor)
      2. EVM-level analysis (evm-deep-dive)
      3. Economic attack modeling (blockchain-defi)
      4. Deploy monitoring (onchain-analytics)

  - name: "DeFi Protocol Security Review"
    skills:
      - blockchain-defi
      - smart-contract-auditor
      - perpetuals-trading
    workflow: |
      1. Understand protocol mechanics (blockchain-defi)
      2. Security audit with economic context (smart-contract-auditor)
      3. Derivatives-specific analysis if applicable (perpetuals-trading)

  - name: "Token Launch Security"
    skills:
      - token-launch
      - smart-contract-auditor
      - tokenomics-design
    workflow: |
      1. Token design and implementation (token-launch)
      2. Security audit of contracts (smart-contract-auditor)
      3. Economic model validation (tokenomics-design)

  - name: "Cross-Chain Protocol Audit"
    skills:
      - cross-chain
      - smart-contract-auditor
      - evm-deep-dive
    workflow: |
      1. Bridge architecture review (cross-chain)
      2. Security audit of all chain contracts (smart-contract-auditor)
      3. Low-level message handling review (evm-deep-dive)

  - name: "Governance Security Review"
    skills:
      - dao-governance
      - smart-contract-auditor
      - onchain-analytics
    workflow: |
      1. Governance design review (dao-governance)
      2. Security audit (smart-contract-auditor)
      3. Voting pattern monitoring (onchain-analytics)

handoff_data:
  provides:
    - vulnerability_report  # Full audit findings
    - severity_matrix       # Critical/High/Medium/Low/Info counts
    - remediation_guide     # Fix recommendations with code
    - attack_vectors        # Documented potential exploits
    - invariant_set         # Properties that must hold
    - monitoring_config     # Forta bot configurations

  expects:
    - contract_source_code (from any skill)
    - deployment_config (from token-launch, cross-chain)
    - protocol_documentation (from blockchain-defi, dao-governance)
    - test_coverage_report (from any development skill)
    - known_assumptions (from all skills)

cross_domain_insights:
  - domain: Offensive Security
    insight: Think like an attacker - what would a black hat try first?
    application: Model attack scenarios before confirming security

  - domain: Formal Methods
    insight: Mathematical proofs catch bugs tests miss
    application: Use Halmos/Certora for critical invariants

  - domain: Economics
    insight: MEV and arbitrage create financial incentives for exploitation
    application: Analyze all economic attack vectors, not just code bugs

  - domain: Cryptography
    insight: Signature schemes have subtle correctness requirements
    application: Verify EIP-712 compliance, nonces, chain IDs

  - domain: Systems Engineering
    insight: Emergent behavior in complex systems causes unexpected failures
    application: Test composability with other protocols

ecosystem_alternatives:
  static_analysis:
    - name: Slither
      when: First-pass automated scanning
      tradeoff: False positives, misses complex logic bugs
    - name: Mythril
      when: Symbolic execution for reachability
      tradeoff: Slow, high resource usage
    - name: Aderyn
      when: Fast Rust-based analysis
      tradeoff: Newer tool, smaller rule set
    - name: Semgrep
      when: Custom pattern matching
      tradeoff: Requires rule writing expertise

  fuzzing:
    - name: Echidna
      when: Property-based testing and invariant fuzzing
      tradeoff: Configuration complexity, Haskell-based
    - name: Foundry Fuzz
      when: Solidity-native fuzzing
      tradeoff: Less advanced than Echidna for invariants
    - name: Medusa
      when: Parallelized fuzzing
      tradeoff: Newer, less documentation

  formal_verification:
    - name: Halmos
      when: Symbolic testing in Python
      tradeoff: Bounded verification, may miss edge cases
    - name: Certora
      when: Full formal proofs
      tradeoff: Expensive, steep learning curve
    - name: KEVM
      when: EVM semantics verification
      tradeoff: Very specialized, academic

  manual_review:
    - name: Code4rena
      when: Competitive audit with many eyes
      tradeoff: Variable quality, public disclosure
    - name: Trail of Bits
      when: Deep security research
      tradeoff: Expensive, long timeline
    - name: OpenZeppelin
      when: Standard patterns, high profile
      tradeoff: High cost, scheduling constraints

feedback_loops:
  - from: onchain-analytics
    incorporates:
      - Post-deployment transaction patterns
      - Attempted exploit signatures
      - Gas usage anomalies
    into: Updated threat models and detection patterns

  - from: blockchain-defi
    incorporates:
      - New protocol patterns and integrations
      - Economic model changes
      - Flash loan pool sizes
    into: Economic attack vector analysis

  - from: evm-deep-dive
    incorporates:
      - New EVM opcodes and behaviors
      - Compiler version changes
      - Gas cost updates
    into: Low-level vulnerability patterns

  - from: cross-chain
    incorporates:
      - New bridge implementations
      - Cross-chain message standards
      - L2 security models
    into: Multi-chain security assessment

audit_methodology:
  phases:
    - name: Scoping
      activities:
        - Review protocol documentation
        - Identify trust boundaries
        - Document assumptions
        - Define threat model

    - name: Static Analysis
      activities:
        - Run Slither, Aderyn, 4naly3er
        - Review all findings
        - Triage false positives
        - Document confirmed issues

    - name: Manual Review
      activities:
        - Line-by-line code review
        - Access control analysis
        - State machine verification
        - Economic attack modeling

    - name: Dynamic Testing
      activities:
        - Write PoC exploits
        - Fuzz testing with Echidna
        - Invariant testing
        - Integration testing

    - name: Formal Verification
      activities:
        - Define critical properties
        - Halmos symbolic testing
        - Certora specs (if applicable)

    - name: Reporting
      activities:
        - Write detailed findings
        - Classify by severity
        - Provide remediation guidance
        - Review with development team

integration_notes: |
  Smart Contract Auditor is a gatekeeper skill that other blockchain
  skills should route through before production deployment:

  BEFORE DEPLOYMENT:
  - token-launch -> smart-contract-auditor (mandatory)
  - blockchain-defi -> smart-contract-auditor (mandatory)
  - dao-governance -> smart-contract-auditor (mandatory)
  - cross-chain -> smart-contract-auditor (critical)
  - nft-systems -> smart-contract-auditor (recommended)

  AFTER AUDIT:
  - smart-contract-auditor -> onchain-analytics (monitoring setup)
  - smart-contract-auditor -> evm-deep-dive (gas optimization if safe)

  ONGOING:
  - Protocol upgrades require re-audit
  - New integrations require scope expansion
  - Incident response may require rapid assessment

  Never skip the audit for "trusted" code or "standard" patterns.
  Every protocol thinks their code is simple until the exploit.
