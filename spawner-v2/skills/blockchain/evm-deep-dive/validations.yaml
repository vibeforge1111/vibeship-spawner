id: evm-deep-dive
skill: EVM Deep Dive
version: "1.0"

validations:
  - id: check-unchecked-arithmetic
    name: Unchecked Arithmetic Safety
    description: Verify unchecked blocks are used safely
    pattern: "unchecked\\s*\\{[^}]*\\+[^}]*\\}"
    file_glob: "**/*.sol"
    match: present
    message: "Verify unchecked arithmetic cannot overflow in context"
    severity: warning
    autofix: false

  - id: check-storage-caching
    name: Storage Variable Caching
    description: Storage variables should be cached for multiple reads
    pattern: "storage\\w+\\s*[^=]*storage\\w+"
    file_glob: "**/*.sol"
    match: present
    message: "Consider caching storage variable in memory for multiple reads"
    severity: info
    autofix: false

  - id: check-calldata-params
    name: Calldata for External Functions
    description: External functions should use calldata for arrays/structs
    pattern: "function.*external.*\\(.*memory.*\\[\\]"
    file_glob: "**/*.sol"
    match: present
    message: "Use calldata instead of memory for external function array parameters"
    severity: warning
    autofix: false

  - id: check-loop-optimization
    name: Loop Length Caching
    description: Array length should be cached outside loop
    pattern: "for.*<.*\\.length"
    file_glob: "**/*.sol"
    match: present
    message: "Cache array length before loop: uint256 len = arr.length"
    severity: warning
    autofix: false

  - id: check-increment-style
    name: Unchecked Increment
    description: Loop increments should be unchecked
    pattern: "for.*\\+\\+\\s*\\)"
    file_glob: "**/*.sol"
    match: present
    context_pattern: "unchecked"
    message: "Use unchecked { ++i } for loop increment"
    severity: info
    autofix: false

  - id: check-zero-initialization
    name: Redundant Zero Initialization
    description: Variables don't need explicit zero initialization
    pattern: "(uint|int)\\d*\\s+\\w+\\s*=\\s*0\\s*;"
    file_glob: "**/*.sol"
    match: present
    message: "Remove explicit zero initialization - variables are zero by default"
    severity: info
    autofix: false

  - id: check-custom-errors
    name: Custom Error Usage
    description: Use custom errors instead of require strings
    pattern: "require\\([^,]+,\\s*\"[^\"]+\"\\)"
    file_glob: "**/*.sol"
    match: present
    message: "Consider custom error instead of require with string"
    severity: info
    autofix: false

  - id: check-packed-storage
    name: Storage Packing Analysis
    description: Check for suboptimal storage variable ordering
    pattern: "(uint256|bytes32|address).*;\\s*(uint\\d+|bool|bytes\\d+).*;"
    file_glob: "**/*.sol"
    match: present
    message: "Review storage layout - smaller types after uint256 waste a slot"
    severity: info
    autofix: false

  - id: check-delegatecall-safety
    name: Delegatecall Safety
    description: Delegatecall to untrusted contracts is dangerous
    pattern: "delegatecall\\("
    file_glob: "**/*.sol"
    match: present
    message: "Verify delegatecall target is trusted - storage collision risk"
    severity: warning
    autofix: false

  - id: check-selfdestruct-usage
    name: Selfdestruct Deprecation
    description: Selfdestruct behavior changed post-Cancun
    pattern: "selfdestruct\\("
    file_glob: "**/*.sol"
    match: present
    message: "selfdestruct only sends ETH post-Cancun, doesn't delete contract"
    severity: warning
    autofix: false

  - id: check-assembly-safety
    name: Assembly Block Review
    description: Assembly blocks need careful review
    pattern: "assembly\\s*\\{"
    file_glob: "**/*.sol"
    match: present
    message: "Assembly block requires careful security review"
    severity: info
    autofix: false

  - id: check-immutable-usage
    name: Immutable Variable Usage
    description: Frequently read constants should be immutable
    pattern: "constant.*SLOAD|view.*return.*storage"
    file_glob: "**/*.sol"
    match: present
    message: "Consider immutable for frequently accessed values"
    severity: info
    autofix: false

pre_commit:
  - id: forge-build
    name: Forge Build Check
    command: "forge build"
    description: Verify contracts compile

  - id: forge-test
    name: Forge Test Suite
    command: "forge test"
    description: Run test suite

  - id: gas-snapshot
    name: Gas Snapshot
    command: "forge snapshot"
    description: Generate gas usage report

ci_checks:
  - id: slither-analysis
    name: Slither Static Analysis
    command: "slither ."
    description: Run Slither security checks
    required: true

  - id: gas-comparison
    name: Gas Comparison
    command: "forge snapshot --diff"
    description: Compare gas usage against baseline

  - id: contract-size
    name: Contract Size Check
    command: "forge build --sizes"
    description: Verify contracts under 24KB limit

  - id: coverage-report
    name: Test Coverage
    command: "forge coverage"
    description: Generate test coverage report
