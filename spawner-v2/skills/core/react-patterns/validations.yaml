# React Patterns Validations
# Checks that run on code to catch issues

validations:
  - id: react-object-in-deps
    name: Object Literal in Dependency Array
    severity: error
    type: regex
    pattern:
      - 'useEffect\([^)]+,\s*\[[^\]]*\{[^}]*\}[^\]]*\]'
      - 'useMemo\([^)]+,\s*\[[^\]]*\{[^}]*\}[^\]]*\]'
      - 'useCallback\([^)]+,\s*\[[^\]]*\{[^}]*\}[^\]]*\]'
    message: "Object literal in dependency array causes infinite loops. Memoize the object or use primitives."
    fix_action: "Use useMemo for the object or extract primitive values as deps"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-empty-deps-with-state
    name: Empty Deps with State Reference
    severity: warning
    type: regex
    pattern:
      - 'useEffect\(\(\)\s*=>\s*\{[^}]*\b(count|value|data|items|state)\b[^}]*\},\s*\[\s*\]\)'
    message: "Empty dependency array but referencing state may cause stale closure."
    fix_action: "Add state to deps or use functional update (setState(prev => ...))"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-missing-key
    name: Missing Key in Map
    severity: error
    type: regex
    pattern:
      - '\.map\([^)]+\)\s*=>\s*\(\s*<[A-Z][^>]*(?!key=)[^>]*>'
      - '\.map\([^)]+\)\s*=>\s*<[A-Z][^>]*(?!key=)[^>]*>'
    message: "Missing key prop in mapped elements. Add unique key for proper reconciliation."
    fix_action: "Add key={item.id} or another unique identifier"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-index-as-key
    name: Array Index as Key
    severity: warning
    type: regex
    pattern:
      - '\.map\(\s*\([^,]+,\s*(\w+)\)\s*=>[^)]*key=\{\s*\1\s*\}'
      - '\.map\(\s*\([^,]+,\s*index\)\s*=>[^)]*key=\{index\}'
    message: "Using array index as key can cause bugs when list items change order."
    fix_action: "Use unique item ID instead: key={item.id}"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-setstate-in-render
    name: setState Called During Render
    severity: error
    type: regex
    pattern:
      - 'function \w+\([^)]*\)\s*\{[^}]*set\w+\([^)]+\)[^}]*return\s*[(<]'
    message: "setState called during render causes infinite loop. Move to useEffect or event handler."
    fix_action: "Use useEffect for side effects or useMemo for derived state"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-missing-cleanup
    name: useEffect Without Cleanup
    severity: warning
    type: regex
    pattern:
      - 'useEffect\(\(\)\s*=>\s*\{[^}]*addEventListener[^}]*\}[^}]*(?!return)'
      - 'useEffect\(\(\)\s*=>\s*\{[^}]*subscribe[^}]*\}[^}]*(?!return)'
      - 'useEffect\(\(\)\s*=>\s*\{[^}]*setInterval[^}]*\}[^}]*(?!return)'
    message: "useEffect with subscription/listener but no cleanup. Add return function to clean up."
    fix_action: "Add cleanup: return () => { removeEventListener/unsubscribe/clearInterval }"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-context-no-check
    name: useContext Without Null Check
    severity: warning
    type: regex
    pattern:
      - 'const \w+ = useContext\(\w+\)(?!\s*\n[^}]*(?:if|throw|\?\.))'
    message: "useContext without null check. Context may be undefined if Provider is missing."
    fix_action: "Add null check and throw helpful error, or create a custom hook"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-inline-function-prop
    name: Inline Function in JSX Prop
    severity: warning
    type: regex
    pattern:
      - 'onClick=\{\(\)\s*=>'
      - 'onChange=\{\([^)]*\)\s*=>'
    message: "Inline function creates new reference every render. May cause unnecessary re-renders."
    fix_action: "Extract to useCallback if child component is memoized"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: react-async-useeffect
    name: Async Function as useEffect Callback
    severity: error
    type: regex
    pattern:
      - 'useEffect\(async\s*\('
      - 'useEffect\(\s*async\s*\(\)\s*=>'
    message: "useEffect callback cannot be async directly. Define async function inside and call it."
    fix_action: "useEffect(() => { async function fetch() {...} fetch() }, [deps])"
    applies_to:
      - "*.tsx"
      - "*.jsx"
