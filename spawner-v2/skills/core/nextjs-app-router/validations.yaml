# Next.js App Router Validations
# Checks that run on code to catch issues

validations:
  - id: nextjs-async-client
    name: Async Client Component
    severity: error
    type: regex
    pattern:
      - '["'']use client["''][\s\S]{0,500}export\s+(?:default\s+)?async\s+function'
      - '["'']use client["''][\s\S]{0,500}async\s+function\s+\w+\s*\('
    message: "Client Components cannot be async. Move data fetching to a Server Component or use useEffect."
    fix_action: "Remove async from the component, fetch data in a parent Server Component"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: nextjs-server-import-client
    name: Server Import in Client
    severity: error
    type: regex
    pattern:
      - '["'']use client["''][\s\S]*?import[^;]*from\s*["''](?:fs|path|crypto|child_process)["'']'
      - '["'']use client["''][\s\S]*?import[^;]*from\s*["'']next/headers["'']'
      - '["'']use client["''][\s\S]*?import[^;]*from\s*["'']server-only["'']'
    message: "Server-only module imported in Client Component. This will fail at build/runtime."
    fix_action: "Move server imports to a Server Component or Server Action"
    applies_to:
      - "*.tsx"
      - "*.jsx"
      - "*.ts"
      - "*.js"

  - id: nextjs-cookies-client
    name: Cookies in Client Component
    severity: error
    type: regex
    pattern:
      - '["'']use client["''][\s\S]*?(?:cookies|headers)\s*\(\s*\)'
    message: "cookies()/headers() can only be used in Server Components."
    fix_action: "Read cookies in a Server Component and pass as props, or use document.cookie"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: nextjs-window-ssr
    name: Window Access Without Guard
    severity: warning
    type: regex
    pattern:
      - '(?<!typeof\s)window\.\w+'
      - '(?<!typeof\s)document\.\w+'
    message: "Browser API used without guard. May cause hydration mismatch."
    fix_action: "Wrap in useEffect or check typeof window !== 'undefined'"
    applies_to:
      - "*.tsx"
      - "*.jsx"

  - id: nextjs-missing-loading
    name: Missing Loading State
    severity: warning
    type: file
    pattern: "loading.tsx"
    message: "Consider adding loading.tsx for better UX during data fetching."
    fix_action: "Create loading.tsx with a skeleton or spinner"
    applies_to:
      - "app/**/page.tsx"

  - id: nextjs-missing-error
    name: Missing Error Boundary
    severity: warning
    type: file
    pattern: "error.tsx"
    message: "Consider adding error.tsx to handle errors gracefully."
    fix_action: "Create error.tsx with 'use client' and error UI"
    applies_to:
      - "app/**/page.tsx"

  - id: nextjs-use-client-overuse
    name: Excessive use client
    severity: warning
    type: regex
    pattern:
      - '["'']use client["''][\s\S]*?export\s+default\s+function\s+\w*Page'
    message: "Page component marked as Client Component. Consider if Server Component would work."
    fix_action: "Extract only the interactive parts into Client Components"
    applies_to:
      - "app/**/page.tsx"

  - id: nextjs-fetch-no-cache
    name: Fetch Without Cache Config
    severity: warning
    type: regex
    pattern:
      - 'fetch\s*\([^)]+\)(?![^)]*(?:cache|revalidate|next))'
    message: "fetch() without cache configuration. Consider adding cache or revalidate options."
    fix_action: "Add { cache: 'force-cache' } or { next: { revalidate: 60 } }"
    applies_to:
      - "*.ts"
      - "*.tsx"
