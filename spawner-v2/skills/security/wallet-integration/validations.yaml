# Wallet Integration Validations
# Automated checks for Web3 wallet patterns

validations:
  - id: metamask-only
    name: MetaMask Only Detection
    severity: warning
    type: regex
    pattern:
      - 'window\.ethereum(?!.*providers)'
      - 'ethereum\.isMetaMask'
      - 'detectMetaMask'
    message: "Hardcoded MetaMask detection excludes other wallet users."
    fix_action: "Use wallet aggregator (RainbowKit, Web3Modal) or multi-wallet detection"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: unhandled-connect-rejection
    name: Unhandled Connection Rejection
    severity: error
    type: regex
    pattern:
      - 'await.*connect\(\)(?!.*catch)'
      - 'ethereum\.request.*eth_requestAccounts(?!.*catch)'
      - '\.connect\(\)\.then(?!.*catch)'
    message: "Wallet connection rejection not handled - UI may break."
    fix_action: "Handle connection rejection with try/catch and user message"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: unhandled-tx-rejection
    name: Unhandled Transaction Rejection
    severity: error
    type: regex
    pattern:
      - 'await.*sendTransaction(?!.*catch)'
      - 'await.*write(?!.*catch)'
      - 'await.*signMessage(?!.*catch)'
    message: "Transaction/signature rejection not handled."
    fix_action: "Handle rejection, show message, and allow retry"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: no-chain-check
    name: No Chain ID Check
    severity: warning
    type: regex
    pattern:
      - 'sendTransaction(?!.*chainId)'
      - 'write(?!.*chain)'
      - 'contract\.(?!.*verifyChain)'
    message: "Transaction without chain check - user may be on wrong network."
    fix_action: "Check chainId before transactions, prompt switch if needed"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: unlimited-approval
    name: Unlimited Token Approval
    severity: warning
    type: regex
    pattern:
      - 'approve.*MAX_UINT'
      - 'approve.*2\*\*256'
      - 'approve.*type\(uint256\)\.max'
      - 'MaxUint256'
    message: "Unlimited approval is risky if contract is compromised."
    fix_action: "Approve exact amounts or use permit (EIP-2612)"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
      - "**/*.sol"

  - id: raw-error-display
    name: Raw Error Display
    severity: warning
    type: regex
    pattern:
      - 'alert\(error'
      - 'toast.*error\.message'
      - 'setError\(e\.message'
      - 'console\.error\(.*\)\s*$'
    message: "Raw wallet/RPC errors shown to users are confusing."
    fix_action: "Parse errors and show user-friendly messages"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: auto-connect-aggressive
    name: Aggressive Auto-Connect
    severity: info
    type: regex
    pattern:
      - 'useEffect.*connect\('
      - 'componentDidMount.*connect'
      - 'autoConnect:\s*true'
    message: "Aggressive auto-connect may annoy users with prompts."
    fix_action: "Let user initiate connection, persist state across sessions"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: no-pending-state
    name: No Pending State
    severity: warning
    type: regex
    pattern:
      - 'await.*sendTransaction(?!.*setPending|.*setLoading|.*isLoading)'
      - 'await.*write(?!.*isPending|.*isLoading)'
    message: "Transaction submitted without pending state - user may resubmit."
    fix_action: "Show pending state, disable button, update on confirmation"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: hardcoded-rpc
    name: Hardcoded RPC URL
    severity: warning
    type: regex
    pattern:
      - 'https://mainnet\.infura\.io'
      - 'https://eth-mainnet\.g\.alchemy\.com'
      - 'rpc.*=.*["\']https://(?!.*env)'
    message: "Hardcoded RPC URL - should be configurable via environment."
    fix_action: "Use environment variable for RPC URL"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    excludes:
      - "**/.env*"
      - "**/config.*"
