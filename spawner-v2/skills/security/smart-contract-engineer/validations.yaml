# Smart Contract Engineer Validations
# Automated checks for Solidity patterns

validations:
  - id: reentrancy-risk
    name: External Call Before State Update
    severity: error
    type: regex
    pattern:
      - 'call\{value.*balances\[.*\].*='
      - 'transfer\(.*amount.*balances.*='
      - 'send\(.*balance.*='
    message: "External call before state update - reentrancy risk."
    fix_action: "Update state BEFORE external calls (checks-effects-interactions)"
    applies_to:
      - "**/*.sol"

  - id: tx-origin
    name: Using tx.origin for Auth
    severity: error
    type: regex
    pattern:
      - 'tx\.origin'
      - 'require.*tx\.origin'
    message: "tx.origin is vulnerable to phishing attacks."
    fix_action: "Use msg.sender for authentication"
    applies_to:
      - "**/*.sol"

  - id: floating-pragma
    name: Floating Pragma Version
    severity: warning
    type: regex
    pattern:
      - 'pragma solidity \^'
      - 'pragma solidity >='
    message: "Floating pragma may compile with different versions."
    fix_action: "Lock to specific version: pragma solidity 0.8.20"
    applies_to:
      - "**/*.sol"

  - id: unchecked-return
    name: Unchecked External Call Return
    severity: error
    type: regex
    pattern:
      - '\.call\{.*\}\([^)]*\);(?!\s*if)'
      - '\.send\(.*\);(?!\s*require)'
    message: "External call return value not checked."
    fix_action: "Check return: (bool success, ) = ...; require(success);"
    applies_to:
      - "**/*.sol"

  - id: unsafe-math
    name: Unsafe Math Operations (Pre-0.8)
    severity: error
    type: regex
    pattern:
      - 'pragma solidity.*0\.[0-7]'
    message: "Solidity < 0.8 has no overflow protection."
    fix_action: "Use Solidity 0.8+ or SafeMath library"
    applies_to:
      - "**/*.sol"

  - id: missing-access-control
    name: Missing Access Control
    severity: error
    type: regex
    pattern:
      - 'function.*external(?!.*onlyOwner|.*onlyRole|.*require\(msg\.sender)'
      - 'function.*public(?!.*onlyOwner|.*view|.*pure)'
    message: "State-changing function may be missing access control."
    fix_action: "Add onlyOwner or role-based access control"
    applies_to:
      - "**/*.sol"

  - id: unbounded-loop
    name: Unbounded Loop
    severity: warning
    type: regex
    pattern:
      - 'for.*\.length'
      - 'while.*true'
    message: "Unbounded loop may exceed gas limit."
    fix_action: "Add iteration limits or use pagination"
    applies_to:
      - "**/*.sol"

  - id: block-timestamp-dependence
    name: Block Timestamp Manipulation
    severity: info
    type: regex
    pattern:
      - 'block\.timestamp.*<'
      - 'block\.timestamp.*>'
      - 'now.*[<>]'
    message: "block.timestamp can be manipulated by miners (~15 seconds)."
    fix_action: "Don't use for critical timing within short windows"
    applies_to:
      - "**/*.sol"

  - id: private-not-hidden
    name: Private Variable Assumption
    severity: info
    type: regex
    pattern:
      - 'private.*password'
      - 'private.*secret'
      - 'private.*key'
    message: "Private variables are readable from blockchain storage."
    fix_action: "Never store secrets on-chain - use hashes or off-chain"
    applies_to:
      - "**/*.sol"

  - id: selfdestruct-usage
    name: Selfdestruct Usage
    severity: warning
    type: regex
    pattern:
      - 'selfdestruct'
      - 'suicide'
    message: "selfdestruct is deprecated and may be removed."
    fix_action: "Use alternative patterns for contract cleanup"
    applies_to:
      - "**/*.sol"

  - id: no-events
    name: State Change Without Event
    severity: info
    type: regex
    pattern:
      - 'function.*external(?!.*emit)'
    message: "State changes should emit events for indexing."
    fix_action: "Emit event for important state changes"
    applies_to:
      - "**/*.sol"

  - id: hardcoded-addresses
    name: Hardcoded Contract Address
    severity: warning
    type: regex
    pattern:
      - '0x[a-fA-F0-9]{40}'
    message: "Hardcoded address can't be updated if dependency changes."
    fix_action: "Use constructor parameter or admin-settable address"
    applies_to:
      - "**/*.sol"
