# Validations - Error Handling
version: 1.0.0
skill_id: error-handling

validations:
  - id: empty-catch
    name: Empty catch block
    severity: critical
    type: regex
    pattern:
      - "catch.*\{\s*\}"
    message: "Empty catch block swallows errors"
    fix_action: "Handle, log, or rethrow the error"
    applies_to:
      - "*.ts"
      - "*.js"
      - "*.tsx"

  - id: console-only-catch
    name: Catch with only console.log
    severity: warning
    type: regex
    pattern:
      - "catch.*\{\s*console\.(log|error).*\}"
    message: "Console only logging may not be sufficient"
    fix_action: "Add proper error tracking"
    applies_to:
      - "*.ts"
      - "*.tsx"

  - id: throw-string
    name: Throwing string instead of Error
    severity: warning
    type: regex
    pattern:
      - 'throw\s+["\x27]'
    message: "Throw Error objects, not strings"
    fix_action: "Use throw new Error() or custom error class"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: floating-promise
    name: Promise without await or catch
    severity: warning
    type: regex
    pattern:
      - "^\s+\w+\([^)]*\)(?!.*await|.*\.catch|.*\.then)"
    message: "Floating promise may lose errors"
    fix_action: "Add await or .catch()"
    applies_to:
      - "*.ts"
      - "*.tsx"

  - id: error-in-response
    name: Raw error in response
    severity: warning
    type: regex
    pattern:
      - "res\.json.*err\.message"
      - "res\.send.*error\.stack"
    message: "Do not expose internal errors to clients"
    fix_action: "Return user-friendly message, log internal error"
    applies_to:
      - "*.ts"
      - "*.js"

best_practices:
  error_handler:
    recommendation: |
      ## Global Error Handler

      app.use((err, req, res, next) => {
        const requestId = req.id || crypto.randomUUID();
        
        logger.error({
          requestId,
          error: err.message,
          stack: err.stack,
          path: req.path,
        });

        if (err instanceof AppError) {
          return res.status(err.statusCode).json({
            error: err.code,
            message: err.message,
            requestId,
          });
        }

        res.status(500).json({
          error: "INTERNAL_ERROR",
          message: "Something went wrong",
          requestId,
        });
      });
