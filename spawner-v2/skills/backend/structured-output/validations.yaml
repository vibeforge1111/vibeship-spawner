# Structured Output Validations

validations:
  - id: json-mode-no-prompt
    name: JSON Mode Without Prompt Mention
    severity: high
    type: regex
    pattern: 'response_format.*json_object'
    negative_pattern: '[Jj][Ss][Oo][Nn].*[Rr]espond|[Rr]espond.*[Jj][Ss][Oo][Nn]|format.*[Jj][Ss][Oo][Nn]'
    message: "OpenAI JSON mode requires mentioning JSON in the prompt."
    fix_action: "Add 'Respond in JSON format' to system or user message"
    applies_to:
      - "*.py"

  - id: no-response-validation
    name: JSON Parse Without Validation
    severity: medium
    type: regex
    pattern: 'json\.loads\([^)]*\.content'
    negative_pattern: 'model_validate|try:|except'
    message: "Parsing JSON without Pydantic validation is risky."
    fix_action: "Use MyModel.model_validate_json() instead of json.loads()"
    applies_to:
      - "*.py"

  - id: missing-max-retries
    name: Instructor Without Retries
    severity: medium
    type: regex
    pattern: 'response_model=\w+'
    negative_pattern: 'max_retries'
    message: "Instructor extraction without max_retries may fail silently."
    fix_action: "Add max_retries=3 for production reliability"
    applies_to:
      - "*.py"

  - id: complex-optional-schema
    name: Many Optional Fields
    severity: low
    type: regex
    pattern: 'Optional\[.*\]\s*=\s*None.*Optional\[.*\]\s*=\s*None.*Optional\['
    message: "Multiple optional fields increase extraction failure rate."
    fix_action: "Split into required and optional models, or use defaults"
    applies_to:
      - "*.py"

  - id: no-error-handling-extraction
    name: Extraction Without Error Handling
    severity: high
    type: regex
    pattern: 'response_model=\w+[^}]*messages='
    negative_pattern: 'try:|except|max_retries'
    message: "Structured extraction can fail. Add error handling."
    fix_action: "Wrap in try/except or use max_retries parameter"
    applies_to:
      - "*.py"

  - id: anthropic-direct-content-access
    name: Direct Content Access on Anthropic Response
    severity: high
    type: regex
    pattern: 'response\.content\[0\]\.input'
    message: "Anthropic response may have TextBlock before ToolUseBlock."
    fix_action: "Iterate content blocks to find tool_use type"
    applies_to:
      - "*.py"

  - id: outlines-model-in-function
    name: Outlines Model Load in Function
    severity: medium
    type: regex
    pattern: 'def \w+\([^)]*\):[^}]*outlines\.models\.'
    message: "Loading Outlines model inside function causes slow calls."
    fix_action: "Load model at module level or in __init__"
    applies_to:
      - "*.py"

  - id: streaming-with-validation
    name: Streaming With Strict Validation
    severity: medium
    type: regex
    pattern: 'stream=True.*@validator|@model_validator.*stream=True'
    message: "Validators may fail on partial streaming data."
    fix_action: "Use instructor.Partial[] wrapper or skip validation during stream"
    applies_to:
      - "*.py"

  - id: hardcoded-schema-json
    name: Hardcoded JSON Schema
    severity: low
    type: regex
    pattern: '"type":\s*"object".*"properties":\s*\{'
    message: "Hardcoded JSON schemas are hard to maintain."
    fix_action: "Use Pydantic model.model_json_schema() to generate"
    applies_to:
      - "*.py"
