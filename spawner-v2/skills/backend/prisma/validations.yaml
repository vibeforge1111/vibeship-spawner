# Prisma Validations

validations:
  - id: new-client-per-request
    name: New PrismaClient Per Request
    severity: high
    type: regex
    pattern: 'async function.*\{[^}]*new PrismaClient\(\)'
    message: "Creating PrismaClient per request causes connection exhaustion."
    fix_action: "Use singleton pattern from lib/prisma.ts"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: missing-index-foreign-key
    name: Foreign Key Without Index
    severity: medium
    type: regex
    pattern: '@relation\(fields:\s*\[(\w+)\]'
    negative_pattern: '@@index\(\[\1\]\)'
    message: "Foreign key fields should have an index for query performance."
    fix_action: "Add @@index([fieldName]) to the model"
    applies_to:
      - "schema.prisma"

  - id: no-select-on-list
    name: FindMany Without Select
    severity: low
    type: regex
    pattern: 'findMany\(\s*\{[^}]*where:'
    negative_pattern: 'select:|include:'
    message: "Consider using select to limit returned fields for performance."
    fix_action: "Add select: { id: true, ... } for specific fields"
    applies_to:
      - "*.ts"

  - id: loop-with-await
    name: Await in Loop (N+1 Risk)
    severity: high
    type: regex
    pattern: 'for.*\{[^}]*await prisma\.'
    message: "Await in loop may cause N+1 queries. Consider batching."
    fix_action: "Use include for relations or batch with findMany/updateMany"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: no-error-handling
    name: Prisma Query Without Error Handling
    severity: medium
    type: regex
    pattern: 'await prisma\.\w+\.\w+\('
    negative_pattern: 'try|catch|\.catch'
    message: "Prisma queries should have error handling."
    fix_action: "Wrap in try/catch or add .catch() handler"
    applies_to:
      - "*.ts"
      - "*.js"

  - id: cascade-without-review
    name: Cascade Delete Without Comment
    severity: medium
    type: regex
    pattern: 'onDelete:\s*Cascade'
    message: "Cascade delete can remove more data than intended. Ensure this is desired."
    fix_action: "Add comment explaining cascade behavior or consider soft delete"
    applies_to:
      - "schema.prisma"

  - id: missing-unique-constraint
    name: Email/Username Without Unique
    severity: high
    type: regex
    pattern: '(email|username)\s+String(?!.*@unique)'
    message: "Email and username fields should typically be unique."
    fix_action: "Add @unique attribute to field"
    applies_to:
      - "schema.prisma"

  - id: no-updated-at
    name: Model Without updatedAt
    severity: low
    type: regex
    pattern: 'model \w+ \{[^}]*createdAt'
    negative_pattern: 'updatedAt'
    message: "Model has createdAt but no updatedAt. Consider adding for tracking."
    fix_action: "Add updatedAt DateTime @updatedAt"
    applies_to:
      - "schema.prisma"

  - id: raw-sql-injection
    name: Potential SQL Injection
    severity: high
    type: regex
    pattern: '\$queryRaw`[^`]*\$\{[^}]+\}[^`]*`'
    negative_pattern: 'Prisma\.sql'
    message: "Use parameterized queries or Prisma.sql for raw SQL to prevent injection."
    fix_action: "Use Prisma.sql template or parameterized $queryRaw"
    applies_to:
      - "*.ts"
      - "*.js"
