id: sox-compliance-sharp-edges
skill: sox-compliance
version: 1.0.0

sharp_edges:

  - id: shared-service-accounts
    severity: critical
    title: "Shared Service Account Credentials"
    summary: "Multiple users sharing the same service account breaks accountability"
    symptoms:
      - "Application uses single service account for all access"
      - "Multiple people know the password"
      - "Cannot trace actions to individuals"
    why: |
      SOX requires individual accountability for actions affecting financial
      data. When multiple people share credentials, you cannot determine
      who performed a specific action. This is a common material weakness.
    gotcha: |
      "The finance team all uses the 'financeapp' service account to
       access the ERP system. It's easier to manage one account."

      # Who made that journal entry adjustment? No one knows!
    solution: |
      1. Individual user accounts for all access:
         - Each user has unique credentials
         - Tie actions to individuals in audit logs

      2. Service accounts for automation only:
         - Not shared with humans
         - Rotate credentials regularly
         - Monitor usage for anomalies

      3. Privileged Access Management:
         - Check out credentials when needed
         - Full session recording
         - Automatic rotation after use

  - id: developer-prod-access
    severity: critical
    title: "Developers Have Production Database Access"
    summary: "Segregation of duties failure - same person can write and deploy code"
    symptoms:
      - "Developers can access production directly"
      - "Same person develops and deploys"
      - "No change approval process"
    why: |
      SOX requires segregation of duties to prevent fraud. If developers
      can both write code and push to production, they could manipulate
      financial calculations without detection. This is a common ITGC
      material weakness.
    gotcha: |
      "Our senior developer handles deployments because he knows the
       system best. He just SSHs in and pushes the changes."

      # He could modify the revenue calculation and no one would know!
    solution: |
      1. Separate environments with different access:
         - Dev: Developers have access
         - Test: QA has access
         - Prod: Operations only (not developers)

      2. Automated deployment pipelines:
         - Code flows through pipeline
         - Approvals required at each stage
         - Developers cannot push directly

      3. Emergency change procedures:
         - Documented exception process
         - Post-change review required
         - Temporary access with monitoring

  - id: missing-audit-trail
    severity: high
    title: "Financial Data Changes Without Audit Trail"
    summary: "No log of who changed what, when, and why"
    symptoms:
      - "Direct database updates allowed"
      - "No change logging"
      - "Cannot reconstruct history"
    why: |
      SOX Section 802 requires record retention. Auditors need to trace
      any financial data back to its source. Without audit trails, you
      cannot prove controls operated effectively.
    gotcha: |
      UPDATE accounts SET balance = 1000000 WHERE account_id = 12345;

      # Who ran this? When? Why? No one knows!
    solution: |
      1. Application-level audit logging:
         - Log all data changes (CREATE, UPDATE, DELETE)
         - Include: user, timestamp, old value, new value
         - Store in immutable audit table

      2. Database-level protection:
         - Revoke direct UPDATE/DELETE from users
         - All changes through application with logging
         - Trigger-based audit trail as backup

      3. Log integrity:
         - Write-once audit logs (immutable)
         - Separate log storage from app database
         - Regular log verification

  - id: no-access-reviews
    severity: high
    title: "No Periodic Access Reviews"
    summary: "Stale access accumulates as people change roles"
    symptoms:
      - "Former employees still have access"
      - "Role changes don't trigger access review"
      - "No documentation of access decisions"
    why: |
      Access rights accumulate over time. Without regular reviews,
      people retain access they no longer need. This creates fraud
      risk and segregation of duties failures.
    gotcha: |
      "John moved from Accounts Payable to Sales 6 months ago, but
       he still has AP approval access because no one removed it."

      # John could approve his own invoices from his old role!
    solution: |
      1. Quarterly access reviews:
         - Manager certifies each user's access
         - Compare current access to job requirements
         - Remove stale access

      2. Role-based access with lifecycle:
         - Access tied to job role
         - Role change triggers access review
         - Termination removes all access immediately

      3. Privileged access review:
         - Monthly review of admin access
         - Justify each privileged account
         - Time-limited elevated access

detection:
  file_patterns:
    - "**/*audit*.ts"
    - "**/*compliance*.py"
    - "**/*access*.js"
