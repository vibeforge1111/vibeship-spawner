# QA Engineering Validations
# Automated checks to catch common QA mistakes

validations:
  - id: qa-hardcoded-timeout
    name: Hardcoded Wait in Tests
    severity: warning
    type: regex
    pattern:
      - 'waitForTimeout\\(\\d+'
      - 'sleep\\(\\d+'
      - 'setTimeout.*\\d{3,}'
      - '\\.delay\\(\\d+'
    message: "Hardcoded wait in test. Use condition-based waits instead."
    fix_action: "Replace with waitForSelector, waitForResponse, or waitForCondition"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"
      - "*.e2e.ts"
      - "*.e2e.js"

  - id: qa-skipped-test
    name: Skipped Test Without Ticket
    severity: warning
    type: regex
    pattern:
      - 'test\\.skip\\([^)]*\\)(?!.*JIRA|.*TODO|.*#\\d+)'
      - 'it\\.skip\\([^)]*\\)(?!.*JIRA|.*TODO|.*#\\d+)'
      - 'xit\\([^)]*\\)(?!.*JIRA|.*TODO|.*#\\d+)'
      - 'xdescribe\\([^)]*\\)(?!.*JIRA|.*TODO|.*#\\d+)'
    message: "Skipped test without tracking ticket. Skipped tests should have a JIRA/issue reference."
    fix_action: "Add tracking ticket or delete the test: test.skip('reason - JIRA-123')"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-shared-test-data
    name: Shared Global Test Data
    severity: warning
    type: regex
    pattern:
      - 'beforeAll.*insert|create'
      - 'global\\.[a-zA-Z]+\\s*=.*test'
      - 'let\\s+shared[A-Z]'
    message: "Shared test data detected. Each test should create its own data for isolation."
    fix_action: "Move data creation to beforeEach and cleanup to afterEach"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-console-error-suppressed
    name: Console Error Suppression
    severity: warning
    type: regex
    pattern:
      - 'console\\.error.*=.*jest\\.fn\\(\\)'
      - 'spyOn.*console.*error.*mockImplementation\\(\\s*\\)'
      - 'console\\.error.*=.*\\(\\)\\s*=>'
    message: "Console errors suppressed without assertion. Consider failing tests on console errors."
    fix_action: "Use mockImplementation that throws or assert on call count"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-no-assertion
    name: Test Without Assertion
    severity: error
    type: regex
    pattern:
      - 'test\\([^)]*,\\s*(?:async\\s*)?\\([^)]*\\)\\s*=>\\s*\\{[^}]*\\}\\s*\\)(?![\\s\\S]*expect)'
      - 'it\\([^)]*,\\s*(?:async\\s*)?\\([^)]*\\)\\s*=>\\s*\\{[^}]*\\}\\s*\\)(?![\\s\\S]*expect)'
    message: "Test has no assertion. Every test must verify expected outcomes."
    fix_action: "Add expect() assertions to verify the test outcome"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-only-test
    name: Focused Test (only) Committed
    severity: error
    type: regex
    pattern:
      - 'test\\.only\\('
      - 'it\\.only\\('
      - 'describe\\.only\\('
      - 'fit\\('
      - 'fdescribe\\('
    message: ".only test committed. This will skip other tests in CI."
    fix_action: "Remove .only before committing"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-todo-test
    name: TODO in Test Without Ticket
    severity: warning
    type: regex
    pattern:
      - '//\\s*TODO(?!.*JIRA|.*#\\d+)'
      - '//\\s*FIXME(?!.*JIRA|.*#\\d+)'
    message: "TODO/FIXME in test code without ticket reference."
    fix_action: "Create tracking ticket and reference it: // TODO: JIRA-123"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-mock-all-dependencies
    name: Excessive Mocking
    severity: warning
    type: regex
    pattern:
      - 'jest\\.mock\\([^)]*\\)\\s*jest\\.mock\\([^)]*\\)\\s*jest\\.mock'
    message: "Many dependencies mocked. Consider integration testing instead."
    fix_action: "Reduce mocks or use integration tests for better confidence"
    applies_to:
      - "*.test.ts"
      - "*.test.js"

  - id: qa-snapshot-no-name
    name: Snapshot Without Descriptive Name
    severity: warning
    type: regex
    pattern:
      - 'toMatchSnapshot\\(\\)'
      - 'toMatchInlineSnapshot\\(\\)'
    message: "Snapshot without descriptive name. Add a name for clarity."
    fix_action: "Add name: toMatchSnapshot('component renders correctly')"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.test.tsx"
      - "*.test.jsx"

  - id: qa-flaky-retry
    name: Flaky Test Retry Pattern
    severity: warning
    type: regex
    pattern:
      - 'retry\\s*:\\s*[3-9]'
      - 'retries\\s*:\\s*[3-9]'
      - '\\.retries\\(\\s*[3-9]'
    message: "High retry count suggests flaky test. Fix the root cause."
    fix_action: "Investigate and fix flakiness instead of adding retries"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"
      - "playwright.config.*"
      - "jest.config.*"

  - id: qa-test-implementation
    name: Testing Implementation Details
    severity: warning
    type: regex
    pattern:
      - 'expect\\(.*\\._'
      - 'expect\\(.*\\.private'
      - 'toHaveBeenCalledWith.*internal'
    message: "Testing private/internal implementation. Test behavior, not implementation."
    fix_action: "Test public API and outcomes instead of internal methods"
    applies_to:
      - "*.test.ts"
      - "*.test.js"

  - id: qa-no-cleanup
    name: Missing Test Cleanup
    severity: warning
    type: regex
    pattern:
      - 'beforeEach(?![\\s\\S]*afterEach)'
      - 'addEventListener(?![\\s\\S]*removeEventListener)'
      - 'setInterval(?![\\s\\S]*clearInterval)'
    message: "Setup without corresponding cleanup. Add afterEach for proper isolation."
    fix_action: "Add afterEach to clean up test state"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"

  - id: qa-magic-number-timeout
    name: Magic Number Timeout
    severity: warning
    type: regex
    pattern:
      - 'timeout:\\s*\\d{4,}'
      - 'waitFor.*\\d{4,}'
    message: "Magic number timeout. Use named constants for clarity."
    fix_action: "Define constant: const ASYNC_TIMEOUT = 5000"
    applies_to:
      - "*.test.ts"
      - "*.test.js"
      - "*.spec.ts"
      - "*.spec.js"
