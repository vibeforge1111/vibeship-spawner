validations:

  - id: latest-container-tag
    name: Using Latest Container Tag
    severity: warning
    type: regex
    pattern:
      - "container.*['\"].*:latest['\"]"
      - "docker.*:latest"
      - "singularity.*:latest"
    message: "Pin container version instead of 'latest' for reproducibility."
    fix_action: "Use specific version tag (e.g., :0.7.17--h5bf99c6_8)"
    applies_to:
      - "**/*.nf"
      - "**/nextflow.config"
      - "**/*.smk"
      - "**/Snakefile"

  - id: no-pipefail
    name: Shell Without Pipefail
    severity: warning
    type: regex
    pattern:
      - "shell:\\s*['\"]\\s*[^'\"]*\\|[^'\"]*['\"](?![\\s\\S]{0,50}pipefail)"
      - "shell:\\s*'''[^']*\\|[^']*'''(?![\\s\\S]{0,50}pipefail)"
    message: "Use 'set -euo pipefail' in shell blocks with pipes."
    applies_to:
      - "**/*.nf"

  - id: hardcoded-thread-count
    name: Hardcoded Thread Count
    severity: info
    type: regex
    pattern:
      - "-t\\s+[0-9]+(?![\\s\\S]{0,20}\\$\\{?task\\.cpus)"
      - "--threads\\s+[0-9]+(?![\\s\\S]{0,20}\\$\\{?task\\.cpus)"
      - "-p\\s+[0-9]+(?![\\s\\S]{0,20}threads)"
    message: "Use dynamic thread allocation (task.cpus or {threads})."
    applies_to:
      - "**/*.nf"
      - "**/*.smk"

  - id: no-version-output
    name: Process Without Version Tracking
    severity: info
    type: regex
    pattern:
      - "process\\s+\\w+\\s*\\{[^}]*output:[^}]*(?!versions)[^}]*\\}"
    message: "Include versions.yml output for tool version tracking."
    applies_to:
      - "**/*.nf"

  - id: temp-without-protected
    name: Temp Files Without Backup Strategy
    severity: info
    type: regex
    pattern:
      - "temp\\([^)]+\\.bam[^)]*\\)"
      - "temp\\([^)]+\\.vcf[^)]*\\)"
    message: "Consider keeping intermediate BAM/VCF until pipeline completes."
    applies_to:
      - "**/*.smk"

  - id: missing-log-directive
    name: Snakemake Rule Without Log
    severity: info
    type: regex
    pattern:
      - "rule\\s+\\w+:[^}]*(?!log:)[^}]*shell:"
    message: "Add log directive to capture stderr for debugging."
    applies_to:
      - "**/*.smk"
      - "**/Snakefile"

  - id: no-resource-specification
    name: Process Without Resource Limits
    severity: warning
    type: regex
    pattern:
      - "process\\s+\\w+\\s*\\{[^}]*(?!memory|cpus|label)[^}]*\\}"
    message: "Specify memory and CPU requirements for cluster execution."
    applies_to:
      - "**/*.nf"

  - id: unsorted-merge-input
    name: Merging Files Without Sorting
    severity: info
    type: regex
    pattern:
      - "collect\\(\\)(?![\\s\\S]{0,50}sort)"
      - "bcftools\\s+merge(?![\\s\\S]{0,50}sort)"
    message: "Sort input files before merging for reproducible order."
    applies_to:
      - "**/*.nf"
      - "**/*.smk"

  - id: no-error-strategy
    name: Process Without Error Handling
    severity: info
    type: regex
    pattern:
      - "process\\s+\\w+\\s*\\{[^}]*(?!errorStrategy)[^}]*\\}"
    message: "Consider adding errorStrategy for retry on transient failures."
    applies_to:
      - "**/*.nf"

  - id: absolute-path-in-workflow
    name: Absolute Path in Workflow Definition
    severity: warning
    type: regex
    pattern:
      - "['\"]\/home\/[a-z]+\/.*['\"]"
      - "['\"]\/data\/.*['\"]"
      - "['\"]C:\\\\.*['\"]"
    message: "Use relative paths or params for portability."
    applies_to:
      - "**/*.nf"
      - "**/*.smk"
      - "**/Snakefile"
