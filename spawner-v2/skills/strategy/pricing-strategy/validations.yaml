# Pricing Strategy Validations
# Checks for pricing-related patterns in code and configuration

validations:
  - id: hardcoded-prices
    name: Hardcoded Prices in Code
    severity: warning
    type: regex
    pattern:
      - "price\\s*[=:]\\s*[0-9]+"
      - "amount\\s*[=:]\\s*[0-9]+"
      - "cost\\s*[=:]\\s*[0-9]+"
      - "\\$[0-9]+\\.?[0-9]*"
    message: "Hardcoded price found. Consider moving to configuration for easy updates."
    fix_action: "Move prices to config file or database for easy price changes"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "test|spec|mock|fixture"

  - id: no-currency-handling
    name: Price Without Currency
    severity: info
    type: regex
    pattern:
      - "price:\\s*[0-9]"
      - "amount:\\s*[0-9]"
      - "\\{\\s*price:\\s*[0-9]"
    message: "Price without explicit currency. Add currency field to prevent issues."
    fix_action: "Add currency field: { amount: 1000, currency: 'USD' }"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.json"
    exceptions:
      - "currency|Currency|USD|EUR"

  - id: float-money-calculation
    name: Floating Point for Money
    severity: error
    type: regex
    pattern:
      - "price\\s*\\*\\s*[0-9]+\\.[0-9]"
      - "amount\\s*\\*\\s*[0-9]+\\.[0-9]"
      - "\\$[0-9]+\\.[0-9]+\\s*[\\+\\-\\*\\/]"
    message: "Floating point arithmetic with money causes rounding errors. Use cents."
    fix_action: "Store prices in cents (integers) and format for display only"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: pricing-page-monthly-first
    name: Monthly Before Annual on Pricing
    severity: info
    type: regex
    pattern:
      - "monthly.*annual"
      - "month.*year"
      - "\\$[0-9]+/mo.*\\$[0-9]+/yr"
    message: "Consider showing annual pricing first to anchor on higher value."
    fix_action: "Show annual first with 'save X%' messaging, monthly as alternative"
    applies_to:
      - "**/*.tsx"
      - "**/*.jsx"
      - "**/*.html"
      - "**/pricing*"

  - id: missing-trial-expiry
    name: Trial Without Expiration Handling
    severity: warning
    type: regex
    pattern:
      - "trial\\s*[=:]\\s*true"
      - "isTrial"
      - "trialActive"
    message: "Trial state found without clear expiration handling."
    fix_action: "Add trialEndsAt and handle expiration with conversion prompt"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "trialEnd|expiresAt|endsAt"

  - id: no-subscription-status-check
    name: Feature Access Without Plan Check
    severity: warning
    type: regex
    pattern:
      - "user\\.plan(?!\\s*===|\\s*!==|\\s*==)"
      - "subscription(?!\\.|\\[)"
    message: "Accessing plan without checking status. Verify subscription is active."
    fix_action: "Check subscription.status === 'active' before granting access"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: discount-without-validation
    name: Discount Applied Without Limits
    severity: warning
    type: regex
    pattern:
      - "discount\\s*=\\s*req\\."
      - "discount\\s*=\\s*params\\."
      - "applyDiscount\\([^)]*\\)"
    message: "Discount applied from user input. Validate discount codes server-side."
    fix_action: "Validate discount code exists and is within allowed percentage limits"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: pricing-no-analytics
    name: Pricing Page Without Analytics
    severity: info
    type: regex
    pattern:
      - "Pricing|pricing"
      - "PricingPage|pricingPage"
    message: "Pricing page should have conversion tracking."
    fix_action: "Add analytics events: pricing_view, plan_click, checkout_start"
    applies_to:
      - "**/pricing*.tsx"
      - "**/pricing*.jsx"
      - "**/Pricing*.tsx"
    exceptions:
      - "analytics|track|gtag|segment"

  - id: stripe-price-id-hardcoded
    name: Hardcoded Stripe Price ID
    severity: warning
    type: regex
    pattern:
      - "price_[a-zA-Z0-9]{24}"
      - "prod_[a-zA-Z0-9]{24}"
    message: "Hardcoded Stripe Price/Product ID. Use environment variables."
    fix_action: "Move to env: STRIPE_PRICE_STARTER=price_xxx"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - ".env|config"

  - id: no-upgrade-prompt
    name: Usage Limit Without Upgrade Path
    severity: info
    type: regex
    pattern:
      - "limit\\s*reached"
      - "exceeded\\s*quota"
      - "usage\\s*limit"
    message: "Usage limit shown without upgrade call-to-action."
    fix_action: "When showing limits, include clear upgrade CTA with value proposition"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "upgrade|Upgrade|subscribe"

  - id: free-tier-no-limits
    name: Free Tier Without Clear Limits
    severity: info
    type: regex
    pattern:
      - "plan\\s*===\\s*['\"]free['\"]"
      - "tier\\s*===\\s*['\"]free['\"]"
      - "isFree\\s*="
    message: "Free tier detected. Ensure clear limits to drive conversion."
    fix_action: "Free tier should have: usage limits, feature gates, or time limits"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

  - id: missing-proration
    name: Plan Change Without Proration
    severity: warning
    type: regex
    pattern:
      - "changePlan|updatePlan|upgradePlan"
      - "switchPlan|changeSubscription"
    message: "Plan change without clear proration handling."
    fix_action: "Handle proration: credit remaining time on old plan toward new plan"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "prorat|credit"

  - id: grandfathering-not-handled
    name: Price Change Without Grandfathering Logic
    severity: info
    type: regex
    pattern:
      - "updatePrice|priceChange|newPricing"
      - "price.*update|pricing.*change"
    message: "Price change logic without grandfathering existing customers."
    fix_action: "Add grandfathering: existing customers keep old price for X months"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "grandfather|legacy|existing"

  - id: checkout-no-tax-handling
    name: Checkout Without Tax Consideration
    severity: warning
    type: regex
    pattern:
      - "checkout\\s*\\("
      - "createCheckout"
      - "Checkout.*Session"
    message: "Checkout without tax handling. Required for many jurisdictions."
    fix_action: "Use Stripe Tax or similar for automatic tax calculation"
    applies_to:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
    exceptions:
      - "tax|Tax|VAT|automatic_tax"

  - id: pricing-config-unversioned
    name: Pricing Config Not Version Controlled
    severity: info
    type: regex
    pattern:
      - "pricing\\s*="
      - "plans\\s*="
      - "tiers\\s*="
    message: "Pricing configuration should be versioned for price change management."
    fix_action: "Add version to pricing config and log changes in changelog"
    applies_to:
      - "**/pricing*.ts"
      - "**/config/pricing*"
      - "**/constants/pricing*"
    exceptions:
      - "version|Version"
