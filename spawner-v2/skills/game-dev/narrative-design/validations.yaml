id: narrative-design-validations
skill: narrative-design
version: 1.0.0

validations:
  # ============================================================================
  # CRITICAL: Core Narrative Issues
  # ============================================================================

  - id: dialogue-writing-not-speaking
    name: Dialogue uses reading language instead of speaking language
    severity: critical
    description: Dialogue with formal constructs that sound unnatural when voiced
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml,csv,txt}"
      match: "\"[^\"]*\\b(do not|can not|will not|shall not|I am|you are|they are|it is|we are|there is|that is)\\b[^\"]*\""
      exclude: "# |// |formal|robot|ancient|narrator"
    message: "Dialogue may read as written, not spoken. Use contractions: 'do not' -> 'don't', 'I am' -> 'I'm'. Exception: intentionally formal characters."
    autofix: false

  - id: exposition-dump-detected
    name: Long exposition in dialogue without interaction
    severity: critical
    description: Blocks of explanatory text without player engagement
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "(As you know|Let me explain|The history of|Long ago|It all began|You see,|Allow me to tell you)"
      exclude: "# comment|mock|test"
    message: "Potential exposition dump detected. Consider: environmental storytelling, player discovery, or breaking into interactive dialogue."
    autofix: false

  - id: player-agency-removed
    name: Dialogue or script removes player choice without justification
    severity: critical
    description: Narrative forces player into specific action or emotion
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml,md}"
      match: "(you feel|you decide|you think|player feels|player decides|without choice|forced to|must accept|no option)"
      exclude: "# |// |design note|comment"
    message: "Narrative may be prescribing player emotion or action. Player should CHOOSE to feel or do. Offer alternatives or frame as character suggestion."
    autofix: false

  # ============================================================================
  # HIGH: Dialogue and Script Quality
  # ============================================================================

  - id: dialogue-too-long
    name: Individual dialogue lines exceed spoken length
    severity: high
    description: Lines too long for comfortable voice performance
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml,csv}"
      match: "\"[^\"]{250,}\""
      exclude: "description|note|comment|context"
    message: "Dialogue line exceeds 250 characters. Break into multiple lines for natural speech rhythm and actor breath points."
    autofix: false

  - id: missing-character-attribution
    name: Dialogue without speaker identification
    severity: high
    description: Lines that don't clearly indicate who is speaking
    pattern:
      file_glob: "**/*.{ink,yarn,json,csv}"
      match: "^\\s*\"[^\"]+\"\\s*$"
      exclude: "speaker:|character:|from:|name:"
    message: "Dialogue may lack speaker attribution. Every line should clearly indicate who is speaking for VO and localization."
    autofix: false

  - id: branching-without-consequence
    name: Dialogue options that lead to same outcome
    severity: high
    description: Choice architecture without meaningful divergence
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "(choice|option|branch|decision).*->\\s*(same|converge|merge|identical)"
      exclude: "test|mock|example"
    message: "Branching structure may converge without meaningful difference. Ensure choices have distinct consequences or clearly different journey."
    autofix: false

  - id: missing-localization-context
    name: Dialogue without localization context notes
    severity: high
    description: Translatable text without guidance for localizers
    pattern:
      file_glob: "**/*.{json,csv,yaml}"
      match: "(id|key|string_id).*:.*[\"'][^\"']+[\"']"
      exclude: "context:|note:|comment:|desc:|speaker:|emotion:"
    message: "Dialogue entry may lack localization context. Include: speaker, emotion, intended meaning, any wordplay to adapt."
    autofix: false

  # ============================================================================
  # HIGH: Bark and Voice Systems
  # ============================================================================

  - id: insufficient-bark-variants
    name: Bark category with too few variants
    severity: high
    description: Bark pools that will cause noticeable repetition
    pattern:
      file_glob: "**/*.{json,yaml}"
      match: "(bark|callout|combat_line|ambient_line).*:\\s*\\[[^\\]]{1,200}\\]"
      exclude: "test|mock"
    message: "Bark category may have insufficient variants. High-frequency barks need 10-15+ variants. Low-frequency need 4-6 minimum."
    autofix: false

  - id: bark-without-cooldown
    name: Bark definition without playback cooldown
    severity: high
    description: Barks that can repeat immediately
    pattern:
      file_glob: "**/*.{json,yaml}"
      match: "(bark|callout|line).*:"
      exclude: "cooldown|delay|timeout|min_interval"
    message: "Bark may lack cooldown/delay specification. Barks need minimum interval to prevent immediate repetition."
    autofix: false

  - id: voice-line-missing-direction
    name: Voice line without performance direction
    severity: high
    description: Dialogue for voice recording without emotional context
    pattern:
      file_glob: "**/*.{json,yaml,csv}"
      match: "(voice_line|vo_|dialogue).*:.*[\"'][^\"']{20,}[\"']"
      exclude: "emotion:|tone:|direction:|context:|\\(.*\\)"
    message: "Voice line may lack performance direction. Include: emotion, context, what character wants, any subtext."
    autofix: false

  # ============================================================================
  # MEDIUM: Narrative Structure
  # ============================================================================

  - id: quest-missing-motivation
    name: Quest objective without clear player motivation
    severity: medium
    description: Objectives that tell WHAT but not WHY
    pattern:
      file_glob: "**/*.{json,yaml,ink}"
      match: "(objective|quest|task|goal).*:.*\"(Go to|Find|Collect|Kill|Speak to|Return to)"
      exclude: "because|to save|to help|to discover|to prevent"
    message: "Quest objective may lack motivation framing. Include WHY this matters, not just WHAT to do."
    autofix: false

  - id: and-then-plotting
    name: Sequential plot without causal connection
    severity: medium
    description: Events connected by 'and then' instead of 'therefore' or 'but'
    pattern:
      file_glob: "**/*.{md,txt,yaml}"
      match: "(and then|next,|after that,|then they|then the player)"
      exclude: "therefore|because|but|however|as a result|which causes"
    message: "Plot may use 'and then' sequencing instead of causal 'therefore/but' connections. Events should cause each other."
    autofix: false

  - id: moral-choice-unbalanced
    name: Moral choice with obviously correct option
    severity: medium
    description: Ethical choices where one option is clearly superior
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "(choice|option|decision).*(good|evil|right|wrong|moral|immoral)"
      exclude: "gray|ambiguous|cost|sacrifice|trade-off|consequence"
    message: "Moral choice may be unbalanced. Both options should have real costs and benefits. Avoid clear 'right answer'."
    autofix: false

  - id: lore-not-environmental
    name: World information delivered through dialogue instead of environment
    severity: medium
    description: Lore dumps in dialogue rather than discoverable elements
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "(the history|the legend|it is said|according to|the prophecy|the ancient)"
      exclude: "item_description|codex|optional|book|note|environmental"
    message: "Lore may be delivered through dialogue. Consider: item descriptions, environmental details, optional discovery for those who seek."
    autofix: false

  # ============================================================================
  # MEDIUM: Localization and Technical
  # ============================================================================

  - id: hardcoded-gender-pronouns
    name: Hardcoded pronouns that won't localize
    severity: medium
    description: Gendered language that doesn't adapt for localization
    pattern:
      file_glob: "**/*.{json,yaml,ink,yarn}"
      match: "(he or she|him or her|his or her|s/he|\\(s\\)he)"
      exclude: "# |comment|note"
    message: "Hardcoded gender constructs may not localize. Consider: neutral wording, or variable-based pronoun system."
    autofix: false

  - id: pun-not-flagged
    name: Wordplay without localization warning
    severity: medium
    description: Puns or idioms that need adaptation flags
    pattern:
      file_glob: "**/*.{json,yaml,csv}"
      match: "[\"'][^\"']*\\b(dead|grave|killing|break|hit|struck|fall|caught|shot)\\b[^\"']*[\"']"
      exclude: "loc_note|pun|wordplay|adapt|idiom"
    message: "Potential wordplay detected. If intentional, add localization note for translators to adapt appropriately."
    autofix: false

  - id: text-length-not-considered
    name: UI text without expansion room
    severity: medium
    description: Interface text that won't fit when translated
    pattern:
      file_glob: "**/*.{json,yaml}"
      match: "(button_text|label|menu_item|ui_text).*:.*[\"'][^\"']{15,}[\"']"
      exclude: "max_length|expansion|loc_warning"
    message: "UI text may not have room for translation expansion. German can be 30% longer than English. Design for longest language."
    autofix: false

  # ============================================================================
  # MEDIUM: Player Agency
  # ============================================================================

  - id: cutscene-character-contradiction
    name: Cutscene character behaves unlike gameplay
    severity: medium
    description: Character capabilities differ in cinematics
    pattern:
      file_glob: "**/*.{json,yaml,md}"
      match: "(cutscene|cinematic|scene).*:(captured|defeated|fails|loses|falls|trapped)"
      exclude: "earned|player_choice|skill_check|consequence"
    message: "Cutscene may contradict player capability. If player can dodge in gameplay, character shouldn't fail to dodge in cutscene."
    autofix: false

  - id: false-urgency
    name: Narrative urgency without mechanical enforcement
    severity: medium
    description: "Hurry!" in dialogue but no time limit in gameplay
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "(hurry|quickly|no time|urgent|immediately|right now|before it's too late)"
      exclude: "timer|countdown|time_limit|deadline|timed"
    message: "Dialogue suggests urgency without mechanical support. Either add timer, or remove false urgency from dialogue."
    autofix: false

  # ============================================================================
  # LOW: Quality and Polish
  # ============================================================================

  - id: repeated-dialogue-pattern
    name: Same phrase appears multiple times
    severity: low
    description: Dialogue lines that may cause perceived repetition
    pattern:
      file_glob: "**/*.{json,yaml,csv}"
      match: "([\"'][^\"']{10,30}[\"']).*\\1"
      exclude: "intentional|refrain|callback|catchphrase"
    message: "Same phrase appears multiple times. Ensure variation or intentional callback. Players notice repetition."
    autofix: false

  - id: passive-voice-in-objective
    name: Quest objectives use passive voice
    severity: low
    description: Objectives that don't emphasize player as actor
    pattern:
      file_glob: "**/*.{json,yaml}"
      match: "(objective|task|goal).*:.*\"(The|A|An).*must be|should be|needs to be"
      exclude: "active_variant"
    message: "Objective uses passive voice. Use active: 'Find the artifact' not 'The artifact must be found'. Player is agent."
    autofix: false

  - id: missing-alternative-dialogue
    name: Voice line without alt takes
    severity: low
    description: Single take without performance variations
    pattern:
      file_glob: "**/*.{json,yaml}"
      match: "(voice_line|vo_line).*:.*\"[^\"]+\""
      exclude: "_alt|_var|variant|alternative|take_"
    message: "Voice line may lack alternative takes. Consider: intense/casual/interrupted versions for actor choice."
    autofix: false

  - id: dialogue-missing-interruption
    name: Long exchange without natural interruption points
    severity: low
    description: Back-and-forth that feels unnatural
    pattern:
      file_glob: "**/*.{ink,yarn,json}"
      match: "(speaker_a|speaker_b|npc|player).*{5,}"
      exclude: "interrupt|\\.\\.\\.|--|cut_off"
    message: "Long dialogue exchange may lack natural interruption. Real conversation has overlaps, interruptions, trailing off."
    autofix: false

  - id: emotion-told-not-shown
    name: Dialogue tells emotion instead of demonstrating
    severity: low
    description: Characters stating their feelings rather than expressing them
    pattern:
      file_glob: "**/*.{ink,yarn,json,yaml}"
      match: "\"(I am angry|I am sad|I feel|I'm feeling|I am so|I'm so|This makes me)"
      exclude: "sarcastic|ironic|teaching_moment"
    message: "Character may be telling emotion instead of showing. 'I'm angry' is weaker than angry dialogue. Show through word choice and action."
    autofix: false

# ============================================================================
# PRE-COMMIT CHECKS
# ============================================================================
pre_commit:
  - id: dialogue-writing-not-speaking
  - id: exposition-dump-detected
  - id: dialogue-too-long
  - id: missing-character-attribution

# ============================================================================
# CI/CD CHECKS
# ============================================================================
ci_checks:
  - id: dialogue-writing-not-speaking
  - id: exposition-dump-detected
  - id: player-agency-removed
  - id: missing-localization-context
  - id: insufficient-bark-variants

# ============================================================================
# QUALITY GATES
# ============================================================================
narrative_quality_gates:
  # Must pass before milestone
  milestone:
    - id: dialogue-writing-not-speaking
    - id: exposition-dump-detected
    - id: branching-without-consequence
    - id: quest-missing-motivation

  # Must pass before voice recording
  vo_ready:
    - id: dialogue-too-long
    - id: missing-character-attribution
    - id: voice-line-missing-direction
    - id: missing-alternative-dialogue

  # Must pass before localization handoff
  loc_ready:
    - id: missing-localization-context
    - id: hardcoded-gender-pronouns
    - id: pun-not-flagged
    - id: text-length-not-considered

  # Polish pass
  polish:
    - id: passive-voice-in-objective
    - id: repeated-dialogue-pattern
    - id: emotion-told-not-shown
    - id: dialogue-missing-interruption

# ============================================================================
# FILE TYPE DEFINITIONS
# ============================================================================
file_types:
  ink:
    description: Inkle's narrative scripting language
    extensions: [".ink"]
    special_handling: Parse ink syntax for dialogue

  yarn:
    description: Yarn Spinner dialogue files
    extensions: [".yarn", ".yarn.txt"]
    special_handling: Parse Yarn nodes and options

  dialogue_json:
    description: Custom dialogue JSON format
    extensions: [".json"]
    markers: ["dialogue", "conversation", "lines"]

  dialogue_csv:
    description: Spreadsheet dialogue exports
    extensions: [".csv"]
    columns: ["id", "character", "line", "context"]

  narrative_yaml:
    description: Narrative design documents
    extensions: [".yaml", ".yml"]
    markers: ["quest", "story", "scene"]
