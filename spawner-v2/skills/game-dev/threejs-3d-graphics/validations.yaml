id: threejs-3d-graphics
skill: Three.js 3D Graphics
version: "1.0"

validations:
  - id: check-disposal
    name: Resource Disposal Required
    description: Three.js resources must be disposed to prevent memory leaks
    pattern: "new THREE\\.(Mesh|Geometry|Material|Texture)"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "\\.dispose\\(\\)"
    message: "Ensure geometries, materials, and textures are disposed when removed"
    severity: warning
    autofix: false

  - id: check-pixel-ratio
    name: Pixel Ratio Handling
    description: Renderer should set pixel ratio for proper display
    pattern: "new THREE\\.WebGLRenderer"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "setPixelRatio|devicePixelRatio"
    message: "Set pixel ratio with renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))"
    severity: warning
    autofix: false

  - id: check-resize-handler
    name: Resize Handler Required
    description: Scene should handle window resize
    pattern: "new THREE\\.WebGLRenderer"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "resize|onResize|ResizeObserver"
    message: "Add resize handler to update camera aspect and renderer size"
    severity: warning
    autofix: false

  - id: check-context-lost
    name: WebGL Context Loss Handling
    description: Handle WebGL context loss for robustness
    pattern: "new THREE\\.WebGLRenderer"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "webglcontextlost|contextlost"
    message: "Consider handling WebGL context loss events"
    severity: info
    autofix: false

  - id: check-animation-loop
    name: Proper Animation Loop
    description: Use setAnimationLoop instead of manual RAF for visibility handling
    pattern: "requestAnimationFrame.*render"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "setAnimationLoop|visibilitychange"
    message: "Consider using renderer.setAnimationLoop() for automatic visibility handling"
    severity: info
    autofix: false

  - id: check-shader-precision
    name: Shader Precision Fallback
    description: GLSL shaders should handle mediump fallback for mobile
    pattern: "precision highp float"
    file_glob: "**/*.{js,ts,jsx,tsx,glsl,frag,vert}"
    match: present
    context_pattern: "GL_FRAGMENT_PRECISION_HIGH|mediump"
    message: "Add precision fallback for mobile: #ifdef GL_FRAGMENT_PRECISION_HIGH"
    severity: warning
    autofix: false

  - id: check-texture-async
    name: Async Texture Loading
    description: Textures should be loaded asynchronously
    pattern: "textureLoader\\.load\\("
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "loadAsync|callback|then|await"
    message: "Use loadAsync or callbacks to handle texture loading"
    severity: info
    autofix: false

  - id: check-environment-map
    name: Environment Map for PBR
    description: PBR materials need environment maps to look correct
    pattern: "MeshStandardMaterial|MeshPhysicalMaterial"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "envMap|scene\\.environment"
    message: "PBR materials need environment maps for proper lighting"
    severity: info
    autofix: false

  - id: check-camera-frustum
    name: Camera Frustum Optimization
    description: Near/far values should be optimized to prevent z-fighting
    pattern: "PerspectiveCamera\\([^)]+0\\.00?1"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    message: "Very small near value (0.001) can cause z-fighting. Use largest near value possible."
    severity: warning
    autofix: false

  - id: check-instancing
    name: Instancing for Repeated Objects
    description: Use InstancedMesh for many similar objects
    pattern: "for.*new THREE\\.Mesh"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "InstancedMesh"
    message: "Consider using InstancedMesh for better performance with repeated objects"
    severity: info
    autofix: false

  - id: check-controls-dispose
    name: Controls Disposal
    description: OrbitControls and other controls must be disposed
    pattern: "new.*Controls\\("
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "controls\\.dispose|dispose.*controls"
    message: "Dispose controls when cleaning up to prevent event listener leaks"
    severity: warning
    autofix: false

  - id: check-color-space
    name: Color Space Configuration
    description: Proper color space for correct color output
    pattern: "new THREE\\.WebGLRenderer"
    file_glob: "**/*.{js,ts,jsx,tsx}"
    match: present
    context_pattern: "outputColorSpace|outputEncoding"
    message: "Set renderer.outputColorSpace = THREE.SRGBColorSpace for correct colors"
    severity: info
    autofix: false

pre_commit:
  - id: three-bundle-check
    name: Three.js Bundle Size Check
    command: "npx bundlesize --config bundlesize.config.json"
    description: Ensure Three.js bundle stays within limits

  - id: shader-syntax-check
    name: GLSL Syntax Check
    command: "npx glslify-lint src/**/*.glsl"
    description: Validate GLSL shader syntax

ci_checks:
  - id: three-memory-test
    name: Memory Leak Test
    command: "npm run test:memory"
    description: Check for Three.js memory leaks in dispose
    required: false

  - id: webgl-compatibility
    name: WebGL Compatibility Check
    command: "npm run test:webgl"
    description: Test WebGL feature detection and fallbacks
    required: false
