# LangGraph Validations

validations:
  - id: state-without-reducer
    name: Message List Without Reducer
    severity: high
    type: regex
    pattern: 'messages:\s*list(?!\[.*Annotated)'
    message: "Message list without reducer will overwrite instead of append."
    fix_action: "Use Annotated[list, add_messages] for message fields"
    applies_to:
      - "*.py"

  - id: end-as-string
    name: END Used as String
    severity: high
    type: regex
    pattern: 'return\s*["\']end["\']|return\s*["\']END["\']'
    message: "Use END constant, not string 'end' or 'END'."
    fix_action: "from langgraph.graph import END; return END"
    applies_to:
      - "*.py"

  - id: invoke-without-config
    name: Invoke Without Thread Config
    severity: medium
    type: regex
    pattern: '\.invoke\(\{[^}]+\}\s*\)(?!\s*,|\s*\n\s*,)'
    message: "invoke() without config loses conversation state."
    fix_action: "Add config={'configurable': {'thread_id': '...'}}"
    applies_to:
      - "*.py"

  - id: graph-not-compiled
    name: Using StateGraph Without Compile
    severity: high
    type: regex
    pattern: 'StateGraph\([^)]*\)\s*\n(?:[^c]|c[^o]|co[^m])*\.invoke'
    message: "StateGraph must be compiled before invoke."
    fix_action: "app = graph.compile(); app.invoke(...)"
    applies_to:
      - "*.py"

  - id: toolnode-no-error-handling
    name: ToolNode Without Error Handling
    severity: medium
    type: regex
    pattern: 'ToolNode\(\s*\w+\s*\)'
    negative_pattern: 'handle_tool_errors'
    message: "ToolNode without error handling will crash on tool failures."
    fix_action: "Use ToolNode(tools, handle_tool_errors=True)"
    applies_to:
      - "*.py"

  - id: sync-in-async
    name: Sync Call in Async Function
    severity: medium
    type: regex
    pattern: 'async def.*\n(?:.*\n)*?.*(?<!a)invoke\([^)]*\)'
    message: "Sync invoke() in async function blocks event loop."
    fix_action: "Use ainvoke() in async contexts"
    applies_to:
      - "*.py"

  - id: no-max-iterations
    name: Agent Loop Without Max Iterations
    severity: medium
    type: regex
    pattern: 'add_edge\([^,]+,\s*["\'][^"\']+["\']\s*\).*\n.*add_edge\(["\'][^"\']+["\']\s*,'
    negative_pattern: 'iterations|max_|count|limit'
    message: "Agent loop without iteration limit may run forever."
    fix_action: "Add iteration counter in state and check in routing"
    applies_to:
      - "*.py"

  - id: memory-checkpointer-in-prod
    name: SQLite Memory Checkpointer in Production
    severity: medium
    type: regex
    pattern: 'SqliteSaver\.from_conn_string\(["\']:memory:["\']\)'
    message: "In-memory SQLite loses state on restart. Use persistent storage in production."
    fix_action: "Use PostgresSaver or file-based SQLite for production"
    applies_to:
      - "*.py"

  - id: missing-start-edge
    name: Graph Without START Edge
    severity: high
    type: regex
    pattern: 'StateGraph\([^)]*\)(?:.*\n)*?compile\(\)'
    negative_pattern: 'add_edge\(START'
    message: "Graph needs an edge from START to first node."
    fix_action: "Add graph.add_edge(START, 'first_node')"
    applies_to:
      - "*.py"
