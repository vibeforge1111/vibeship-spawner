# Art Consistency Validations
# Checks to enforce character and style consistency in AI generation workflows

validations:
  # ============================================================================
  # PRE-GENERATION VALIDATIONS
  # ============================================================================

  - id: missing-character-bible
    name: Generation Without Character Bible
    severity: error
    type: workflow
    condition: "generating character without documented reference"
    message: "Attempting to generate character without a character bible. Consistency impossible."
    fix_action: |
      Create character bible FIRST with:
      - Identity anchors (face, hair, body, outfit, accessories)
      - Style descriptors (art style, color palette, lighting)
      - Prompt template with exact wording
      - Reference images (turnaround sheet if possible)

  - id: missing-reference-image
    name: Generation Without Reference Image
    severity: error
    type: workflow
    condition: "generating established character without reference loaded"
    message: "Generating established character without reference image. Drift guaranteed."
    fix_action: |
      Load reference image before generation:
      - Upload turnaround sheet or approved previous image
      - Use IP-Adapter or image-to-image with reference
      - Or use trained LoRA with trigger word

  - id: vague-prompt-identity
    name: Vague Identity Descriptors
    severity: warning
    type: prompt_analysis
    pattern:
      - "(?i)pretty (?:girl|woman|boy|man)"
      - "(?i)beautiful (?:girl|woman|boy|man)"
      - "(?i)cute (?:girl|woman|boy|man)"
      - "(?i)anime (?:girl|woman|boy|man|character)"
      - "(?i)(?:generic|normal|regular) (?:looking|appearance)"
    message: "Prompt uses vague identity descriptors. Will produce inconsistent results."
    fix_action: |
      Replace vague descriptors with SPECIFIC identity anchors:
      BAD: "pretty anime girl with blue hair"
      GOOD: "heart-shaped face, large sapphire blue eyes, small nose,
             sky blue twin-tails shoulder-length with ribbon clips"

  - id: vague-style-descriptor
    name: Vague Style Descriptors
    severity: warning
    type: prompt_analysis
    pattern:
      - "(?i)^anime style$"
      - "(?i)^anime$"
      - "(?i)cartoon style"
      - "(?i)realistic style"
      - "(?i)artistic style"
    message: "Prompt uses vague style descriptors. Art style will drift between generations."
    fix_action: |
      Specify EXACT style characteristics:
      BAD: "anime style"
      GOOD: "90s anime cel-shading, bold black outlines,
             hard shadows, saturated colors, Studio Ghibli influence"

  - id: color-without-specification
    name: Color Without Specification
    severity: warning
    type: prompt_analysis
    pattern:
      - "(?i)(?:blue|red|green|purple|silver|gold|pink) (?:hair|eyes|outfit|dress)"
    message: "Color mentioned without specific shade. Colors will vary between generations."
    fix_action: |
      Use specific color descriptors or hex codes in documentation:
      BAD: "blue eyes"
      GOOD: "deep sapphire blue eyes" or "eyes #1E90FF"

      Document exact color in character bible for reference.

  - id: synonym-drift-risk
    name: Synonym Usage Across Prompts
    severity: warning
    type: prompt_comparison
    description: "Detecting when same feature described with different words"
    examples:
      - "silver hair vs gray hair vs platinum hair vs white hair"
      - "twin-tails vs pigtails vs twintails"
      - "sailor uniform vs school uniform vs seifuku"
    message: "Different words for same feature detected. Pick ONE term and use consistently."
    fix_action: |
      Document canonical term in character bible.
      Use ONLY that term in all prompts.
      Never substitute synonyms.

  # ============================================================================
  # POST-GENERATION VALIDATIONS
  # ============================================================================

  - id: face-drift-check
    name: Facial Feature Drift
    severity: error
    type: visual_comparison
    checks:
      - "Eye color matches reference"
      - "Eye shape matches reference"
      - "Face shape matches reference (round, oval, heart, square)"
      - "Nose shape matches reference"
    message: "Facial features do not match reference. Character identity compromised."
    fix_action: |
      Do NOT approve. Regenerate with:
      - Stronger reference image influence (increase IP-Adapter strength)
      - More specific facial feature description in prompt
      - Different seed if pattern persists

  - id: hair-drift-check
    name: Hair Style/Color Drift
    severity: error
    type: visual_comparison
    checks:
      - "Hair color exact match (compare in neutral lighting)"
      - "Hair style matches (ponytail vs twintails vs bob)"
      - "Hair length consistent"
      - "Hair accessories present and correct"
    message: "Hair does not match reference. Visible consistency break."
    fix_action: |
      Do NOT approve. Regenerate with:
      - Explicit hair description in prompt
      - Hair color in specific terms (not just "blue")
      - Accessories explicitly mentioned

  - id: outfit-drift-check
    name: Outfit/Clothing Drift
    severity: error
    type: visual_comparison
    checks:
      - "All clothing items present"
      - "Clothing colors match"
      - "Clothing details preserved (trim, patterns, buttons)"
      - "Accessories present (jewelry, gloves, belts)"
    message: "Outfit does not match reference. Character consistency broken."
    fix_action: |
      Do NOT approve. Regenerate with:
      - Complete outfit description in prompt
      - Each accessory explicitly mentioned
      - Color specifications for each item

  - id: style-drift-check
    name: Art Style Drift
    severity: warning
    type: visual_comparison
    checks:
      - "Art style matches series (anime vs realistic vs cartoon)"
      - "Line weight consistent with series"
      - "Shading style matches (cel-shaded vs soft gradient)"
      - "Color saturation appropriate"
    message: "Art style drifting from series aesthetic."
    fix_action: |
      Compare to series reference images.
      If drift detected:
      - Reinforce style descriptors in prompt
      - Use style reference image
      - Consider different model if style incompatible

  - id: quality-gate
    name: Quality Issues
    severity: error
    type: quality_check
    checks:
      - "No visible artifacts or glitches"
      - "Hands rendered correctly (count: 5 fingers per hand)"
      - "No floating or disconnected elements"
      - "Anatomy physically possible"
      - "Face not distorted"
    message: "Quality issues detected. Cannot approve for delivery."
    fix_action: |
      Do NOT approve. Either:
      - Regenerate with different seed
      - Use inpainting to fix specific issues
      - Adjust prompt if issue is systematic

  # ============================================================================
  # SERIES CONSISTENCY VALIDATIONS
  # ============================================================================

  - id: cross-image-consistency
    name: Cross-Image Consistency Check
    severity: warning
    type: series_comparison
    checks:
      - "Character proportions consistent across images"
      - "Head-to-body ratio maintained"
      - "Art style consistent across series"
      - "Color palette consistent (check same colors in different images)"
    message: "Inconsistency detected across series images."
    fix_action: |
      Review all series images together.
      Identify the drift point.
      Regenerate divergent images with stronger reference.
      Consider retraining LoRA if drift is systematic.

  - id: multi-character-consistency
    name: Multi-Character Scene Consistency
    severity: warning
    type: scene_validation
    checks:
      - "Each character matches their individual reference"
      - "Relative heights/proportions correct"
      - "Art style uniform across all characters"
      - "No style mixing between characters"
    message: "Multi-character scene has consistency issues."
    fix_action: |
      For multi-character scenes:
      - Generate characters separately if possible
      - Use composite/layering approach
      - Verify each character against their bible
      - Check relative proportions against size chart

# ============================================================================
# WORKFLOW GATES
# ============================================================================

workflow_gates:
  pre_generation:
    must_have:
      - character_bible_exists
      - reference_image_available
      - prompt_uses_identity_anchors
      - style_descriptors_specified
    block_if_missing: true
    message: "Generation blocked: consistency preparation incomplete"

  post_generation:
    must_pass:
      - face_drift_check
      - hair_drift_check
      - outfit_drift_check
      - quality_gate
    block_delivery_if_failed: true
    message: "Delivery blocked: QA checklist incomplete or failed"

  series_milestone:
    at_intervals: 10  # Every 10 images
    checks:
      - cross_image_consistency
    action_if_failed: "Pause production for consistency review"
