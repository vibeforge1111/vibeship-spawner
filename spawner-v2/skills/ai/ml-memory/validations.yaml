# ML Memory Validations
# Automated checks for memory system patterns

validations:
  - id: memory-no-temporal-level
    name: Memory Without Temporal Level
    severity: error
    type: regex
    pattern:
      - 'class Memory.*:(?!.*temporal_level)'
      - 'Memory\\((?!.*level|.*temporal)'
    message: "Memory created without temporal level. Always assign a hierarchy level."
    fix_action: "Add temporal_level field to Memory class and set on creation"
    applies_to:
      - "**/memory/**/*.py"
      - "**/*memory*.py"

  - id: memory-no-valid-from
    name: Memory Without Temporal Validity
    severity: error
    type: regex
    pattern:
      - 'class.*Fact.*:(?!.*valid_from)'
      - 'class.*Memory.*:(?!.*created_at|.*valid_from)'
    message: "Memory/Fact without temporal validity. Track when facts became true."
    fix_action: "Add valid_from and valid_until fields for temporal validity"
    applies_to:
      - "**/memory/**/*.py"
      - "**/*memory*.py"

  - id: entity-no-resolution
    name: Entity Created Without Resolution Check
    severity: error
    type: regex
    pattern:
      - 'Entity\\(.*name.*=|create.*entity(?!.*resolv)'
      - 'new.*Entity(?!.*resolution|.*dedupe|.*match)'
    message: "Entity created without resolution check. May create duplicates."
    fix_action: "Check for existing entity match before creating new one"
    applies_to:
      - "**/entity/**/*.py"
      - "**/memory/**/*.py"

  - id: salience-only-increase
    name: Salience Only Increases Never Decreases
    severity: warning
    type: regex
    pattern:
      - 'salience.*\\+.*=(?!.*-)'
      - 'salience.*=.*salience.*\\+(?!.*outcome|.*decay)'
    message: "Salience only increases. Implement decay or outcome-based decrease."
    fix_action: "Add decay mechanism and negative outcome handling"
    applies_to:
      - "**/memory/**/*.py"
      - "**/*salience*.py"

  - id: memory-no-decay
    name: Memory System Without Decay
    severity: warning
    type: regex
    pattern:
      - 'class.*Memory.*System.*:(?!.*decay|.*forget)'
    message: "Memory system without decay/forgetting. Will grow unbounded."
    fix_action: "Implement decay based on time and access patterns"
    applies_to:
      - "**/memory/**/*.py"

  - id: consolidation-no-lock
    name: Consolidation Without Locking
    severity: warning
    type: regex
    pattern:
      - 'async.*def.*consolidat.*:(?!.*lock|.*mutex)'
      - 'consolidat.*(?!.*lock|.*for_update|.*atomic)'
    message: "Consolidation without locking. Concurrent runs may corrupt data."
    fix_action: "Add distributed lock or database-level locking"
    applies_to:
      - "**/consolidation/**/*.py"
      - "**/*consolidat*.py"

  - id: memory-hardcoded-thresholds
    name: Hardcoded Memory Thresholds
    severity: info
    type: regex
    pattern:
      - 'promotion_threshold.*=.*\\d+'
      - 'decay.*=.*0\\.\\d+'
      - 'MAX_SALIENCE.*=.*1\\.0'
    message: "Hardcoded memory thresholds. Consider configuration or learning."
    fix_action: "Move thresholds to configuration or make them learnable"
    applies_to:
      - "**/memory/**/*.py"

  - id: memory-no-outcome-tracking
    name: Memory Retrieval Without Outcome Tracking
    severity: warning
    type: regex
    pattern:
      - 'retrieve.*memor.*(?!.*trace|.*log|.*track)'
      - 'search.*memor.*return(?!.*trace)'
    message: "Memory retrieval without outcome tracking. Can't learn from usage."
    fix_action: "Implement decision trace to track retrieval and outcome"
    applies_to:
      - "**/memory/**/*.py"
      - "**/retrieval/**/*.py"

  - id: forget-no-cascade
    name: Memory Deletion Without Reference Cleanup
    severity: error
    type: regex
    pattern:
      - 'delete.*memory(?!.*cascade|.*reference|.*edge)'
      - 'remove.*memory(?!.*graph|.*relationship)'
    message: "Memory deletion without reference cleanup. May leave dangling refs."
    fix_action: "Clean up graph edges and references before deletion"
    applies_to:
      - "**/memory/**/*.py"

  - id: embedding-no-model-version
    name: Embedding Without Model Version
    severity: warning
    type: regex
    pattern:
      - 'embedding.*:.*List\\[float\\](?!.*model)'
      - 'embed\\(.*\\)(?!.*model=)'
    message: "Embedding stored without model version. Migration will be hard."
    fix_action: "Store embedding_model alongside embedding vector"
    applies_to:
      - "**/memory/**/*.py"
      - "**/embedding/**/*.py"

  - id: memory-no-user-scope
    name: Memory Query Without User Scope
    severity: error
    type: regex
    pattern:
      - 'SELECT.*FROM.*memor(?!.*user_id|.*WHERE.*user)'
      - 'get.*memor.*(?!.*user_id)'
    message: "Memory query without user scope. May leak cross-user data."
    fix_action: "Always filter memories by user_id"
    applies_to:
      - "**/memory/**/*.py"
      - "**/db/**/*.py"

  - id: contradiction-no-handling
    name: Memory Update Without Contradiction Check
    severity: warning
    type: regex
    pattern:
      - 'update.*fact(?!.*contradict|.*conflict)'
      - 'store.*fact(?!.*existing|.*check)'
    message: "Fact stored without contradiction check. May have conflicting facts."
    fix_action: "Check for existing contradictory facts and resolve"
    applies_to:
      - "**/memory/**/*.py"
      - "**/fact/**/*.py"
