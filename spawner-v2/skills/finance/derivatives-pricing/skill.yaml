id: derivatives-pricing
name: Derivatives Pricing
category: finance
description: Use when pricing options, calculating Greeks, implementing exotic derivatives, or building pricing engines - covers Black-Scholes, binomial trees, Monte Carlo, and QuantLib integration

patterns:
  golden_rules:
    - rule: "Calibrate to market"
      reason: "Model parameters from liquid options"
    - rule: "Hedge, don't speculate on models"
      reason: "Greeks show exposure, not truth"
    - rule: "Check put-call parity"
      reason: "Arbitrage check for consistency"
    - rule: "Use implied vol, not historical"
      reason: "Market prices embed forward-looking info"
    - rule: "Validate Greeks numerically"
      reason: "Analytical Greeks can have errors"

  method_selection:
    european_vanilla: "Black-Scholes (Analytical)"
    american_vanilla: "Binomial/Trinomial Trees"
    barrier_asian: "Monte Carlo + Variance Reduction"
    exotic_path_dependent: "Monte Carlo or PDE Methods"
    volatility_smile: "Heston or Local Vol Models"

  black_scholes_formula: |
    d1 = (ln(S/K) + (r - q + 0.5*σ²)*T) / (σ*sqrt(T))
    d2 = d1 - σ*sqrt(T)
    Call = S*e^(-qT)*N(d1) - K*e^(-rT)*N(d2)
    Put = K*e^(-rT)*N(-d2) - S*e^(-qT)*N(-d1)

  greeks:
    delta: "Price sensitivity to spot"
    gamma: "Delta sensitivity to spot"
    theta: "Time decay (daily P&L)"
    vega: "Sensitivity to volatility"
    rho: "Sensitivity to rates"
    vanna: "Delta sensitivity to vol"
    volga: "Vega sensitivity to vol"

  binomial_parameters: |
    u = exp(σ*sqrt(dt))  # Up factor
    d = 1/u              # Down factor
    p = (exp((r-q)*dt) - d) / (u - d)  # Risk-neutral probability

  monte_carlo_exotics:
    asian: "Average price options with control variate"
    barrier: "Brownian bridge for barrier crossing"
    lookback: "Maximum/minimum over path"
    basket: "Correlated asset simulation"

anti_patterns:
  - pattern: "Using historical vol"
    problem: "Ignores market expectations"
    solution: "Calibrate to implied vol"
  - pattern: "Ignoring dividends"
    problem: "Misprices options near ex-dates"
    solution: "Use dividend yield or discrete dividends"
  - pattern: "Single model"
    problem: "Misses skew/smile"
    solution: "Compare multiple models"
  - pattern: "Analytical Greeks only"
    problem: "Can have errors in exotics"
    solution: "Verify with bump-and-reprice"
  - pattern: "Ignoring early exercise"
    problem: "Underprices American options"
    solution: "Use trees or LSM"

implementation_checklist:
  pricing:
    - "Choose appropriate model for option type"
    - "Calibrate to market implied volatility"
    - "Verify put-call parity holds"
    - "Handle dividends appropriately"
  greeks:
    - "Calculate all relevant Greeks"
    - "Validate Greeks numerically (bump and reprice)"
    - "Consider cross-Greeks for complex positions"
  exotic_options:
    - "Use variance reduction for Monte Carlo"
    - "Implement Brownian bridge for barriers"
    - "Control variate for Asian options"
  production:
    - "Backtest hedging performance"
    - "Document model limitations"
    - "Set up monitoring for pricing discrepancies"

handoffs:
  - skill: risk-modeling
    trigger: "portfolio VaR with options"
  - skill: algorithmic-trading
    trigger: "options execution strategies"
  - skill: portfolio-optimization
    trigger: "options in portfolio construction"

ecosystem:
  pricing:
    - "QuantLib - Full derivatives library"
    - "py_vollib - Black-Scholes and Greeks"
    - "mibian - Options pricing"
  data:
    - "yfinance - Options chains"
    - "CBOE - Volatility indices"
  volatility:
    - "arch - GARCH modeling"
    - "volsurface - Vol surface fitting"

sources:
  tutorials:
    - "QuantLib Python Bindings 2025"
    - "The Greeks Explained - Bookdown"
  books:
    - "Options, Futures, and Other Derivatives - Hull"
    - "Volatility Surface - Gatheral"
