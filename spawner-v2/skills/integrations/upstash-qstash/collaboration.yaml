id: upstash-qstash-collaboration
skill: upstash-qstash
version: 1.0.0

# ============================================================================
# RECEIVES FROM (Who delegates TO this skill)
# ============================================================================
receives_from:
  - skill: backend
    context: "Backend needs async job processing"
    receives:
      - "Job definitions"
      - "Endpoint requirements"
      - "Processing logic"
    provides: "Reliable message delivery"

  - skill: nextjs-app-router
    context: "Next.js app needs background tasks"
    receives:
      - "API route handlers"
      - "Webhook endpoints"
      - "Cron job requirements"
    provides: "QStash integration"

  - skill: vercel-deployment
    context: "Vercel deployment needs scheduled jobs"
    receives:
      - "Deployment URLs"
      - "Environment configuration"
      - "Function timeouts"
    provides: "Serverless cron and messaging"

  - skill: email-systems
    context: "Email needs reliable delivery"
    receives:
      - "Email sending requirements"
      - "Batch notification needs"
      - "Scheduled digest timing"
    provides: "Guaranteed email dispatch"

  - skill: stripe-integration
    context: "Stripe needs webhook processing"
    receives:
      - "Webhook event types"
      - "Processing requirements"
      - "Retry needs"
    provides: "Reliable webhook handling"

  - skill: supabase-backend
    context: "Database needs background processing"
    receives:
      - "Data sync requirements"
      - "Cleanup job needs"
      - "Batch processing logic"
    provides: "Scheduled data operations"

# ============================================================================
# DELEGATION TRIGGERS
# ============================================================================
delegation_triggers:
  - trigger: "complex workflow|multi-step|state machine"
    delegate_to: inngest
    pattern: sequential
    context: "Need durable step functions with checkpointing"
    handoff_data:
      - "Workflow requirements"
      - "Step dependencies"
      - "State management needs"
    receive: "Step function implementation"

  - trigger: "redis queue|worker process|job priority"
    delegate_to: bullmq-specialist
    pattern: sequential
    context: "Need traditional queue with workers"
    handoff_data:
      - "Queue requirements"
      - "Worker configuration"
      - "Priority levels"
    receive: "Redis queue setup"

  - trigger: "ai background|long running ai|model inference"
    delegate_to: trigger-dev
    pattern: parallel
    context: "Need AI-specific background processing"
    handoff_data:
      - "AI task requirements"
      - "Model inference needs"
      - "Long-running constraints"
    receive: "AI job infrastructure"

  - trigger: "deploy|vercel|production|environment"
    delegate_to: vercel-deployment
    pattern: parallel
    context: "Need deployment configuration for QStash"
    handoff_data:
      - "Public URLs"
      - "Environment variables"
      - "Function regions"
    receive: "Deployment setup"

  - trigger: "database|persistence|state|sync"
    delegate_to: supabase-backend
    pattern: parallel
    context: "Need database for job state"
    handoff_data:
      - "Job status schema"
      - "Message logging"
      - "Delivery tracking"
    receive: "Database schema"

  - trigger: "auth|user context|session"
    delegate_to: nextjs-supabase-auth
    pattern: parallel
    context: "Need user context in message handlers"
    handoff_data:
      - "User identification"
      - "Permission requirements"
      - "Session handling"
    receive: "Auth context"

# ============================================================================
# FEEDBACK LOOPS
# ============================================================================
feedback_loops:
  receives_feedback_from:
    - skill: vercel-deployment
      signal: "Function timeout limits"
      action: "Adjust message processing design"

    - skill: backend
      signal: "Endpoint performance data"
      action: "Tune retry and timeout settings"

    - skill: inngest
      signal: "Workflow complexity threshold"
      action: "Recommend migration path"

  sends_feedback_to:
    - skill: backend
      signal: "Message delivery stats"
      action: "Inform reliability decisions"

    - skill: vercel-deployment
      signal: "Cron execution status"
      action: "Monitor scheduled jobs"

    - skill: email-systems
      signal: "Delivery confirmation"
      action: "Track email dispatch"

# ============================================================================
# CROSS-DOMAIN INSIGHTS
# ============================================================================
cross_domain_insights:
  - domain: Distributed Systems
    insight: |
      Distributed systems engineers know messaging:
      - At-least-once delivery requires idempotency
      - Timeouts are not errors, they're uncertainty
      - Retries need exponential backoff
      - Dead letter queues save debugging time
      QStash follows distributed messaging principles.
    applies_when: "Designing message handling"

  - domain: Event-Driven Architecture
    insight: |
      Event architects know async patterns:
      - Events describe what happened, not what to do
      - Small payloads, fetch on demand
      - Fan-out enables loose coupling
      - Callbacks complete the feedback loop
      QStash enables event-driven patterns.
    applies_when: "Building event-based systems"

  - domain: Serverless Architecture
    insight: |
      Serverless experts know constraints:
      - Cold starts affect initial latency
      - Function timeouts limit processing time
      - Public endpoints are required
      - Stateless handlers need external state
      QStash works within serverless constraints.
    applies_when: "Deploying to serverless platforms"

# ============================================================================
# COMMON COMBINATIONS
# ============================================================================
common_combinations:
  - name: Serverless Background Jobs
    skills:
      - upstash-qstash
      - nextjs-app-router
      - vercel-deployment
    workflow: |
      1. Define API route handlers (nextjs-app-router)
      2. Configure QStash integration (upstash-qstash)
      3. Deploy with environment vars (vercel-deployment)

  - name: Reliable Webhooks
    skills:
      - upstash-qstash
      - stripe-integration
      - supabase-backend
    workflow: |
      1. Receive webhooks from Stripe (stripe-integration)
      2. Queue for reliable processing (upstash-qstash)
      3. Persist state to database (supabase-backend)

  - name: Scheduled Reports
    skills:
      - upstash-qstash
      - email-systems
      - supabase-backend
    workflow: |
      1. Configure cron schedule (upstash-qstash)
      2. Query data for report (supabase-backend)
      3. Send via email system (email-systems)

  - name: Fan-out Notifications
    skills:
      - upstash-qstash
      - email-systems
      - slack-bot-builder
    workflow: |
      1. Publish to URL group (upstash-qstash)
      2. Email handler receives (email-systems)
      3. Slack handler receives (slack-bot-builder)

  - name: Gradual Migration to Workflows
    skills:
      - upstash-qstash
      - inngest
    workflow: |
      1. Start with simple QStash messages (upstash-qstash)
      2. Identify multi-step patterns
      3. Migrate complex flows to Inngest (inngest)
      4. Keep simple schedules in QStash
