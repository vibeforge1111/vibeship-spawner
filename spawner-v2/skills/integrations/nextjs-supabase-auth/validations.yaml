# Next.js + Supabase Auth Validations
# Checks that run on code to catch issues

validations:
  - id: auth-getsession-insecure
    name: Using getSession() for Auth Checks
    severity: error
    type: regex
    pattern:
      - 'getSession\\(\\)[\\s\\S]{0,50}?(?:user|session)(?![\\s\\S]{0,50}?getUser)'
    message: "getSession() doesn't verify the JWT. Use getUser() for secure auth checks."
    fix_action: "Replace getSession() with getUser() for security-critical checks"
    applies_to:
      - "*.tsx"
      - "*.ts"
      - "middleware.ts"

  - id: auth-missing-callback
    name: OAuth Without Callback Route
    severity: error
    type: file
    pattern: "app/auth/callback/route.ts"
    message: "Using OAuth but missing callback route at app/auth/callback/route.ts"
    fix_action: "Create app/auth/callback/route.ts to handle OAuth redirects"
    applies_to:
      - "app/**/*"

  - id: auth-browser-client-server
    name: Browser Client in Server Context
    severity: error
    type: regex
    pattern:
      - "createBrowserClient[\\s\\S]*?cookies\\(\\)"
      - "import.*createBrowserClient.*from[\\s\\S]*?export.*async"
    message: "Browser client used in server context. Use createServerClient instead."
    fix_action: "Import and use createServerClient from @supabase/ssr"
    applies_to:
      - "app/**/page.tsx"
      - "app/**/layout.tsx"
      - "app/actions*.ts"
      - "middleware.ts"

  - id: auth-no-middleware
    name: Protected Routes Without Middleware
    severity: warning
    type: file
    pattern: "middleware.ts"
    message: "No middleware.ts found. Consider adding middleware for route protection."
    fix_action: "Create middleware.ts to protect routes and refresh sessions"
    applies_to:
      - "app/dashboard/**"
      - "app/admin/**"
      - "app/account/**"

  - id: auth-hardcoded-redirect
    name: Hardcoded Auth Redirect URL
    severity: warning
    type: regex
    pattern:
      - "redirectTo:\\s*['\"]https?://(?:localhost|127\\.0\\.0\\.1)"
      - "redirect.*http://localhost"
    message: "Hardcoded localhost redirect. Use origin for environment flexibility."
    fix_action: "Use window.location.origin or process.env.NEXT_PUBLIC_SITE_URL"
    applies_to:
      - "*.tsx"
      - "*.ts"

  - id: auth-missing-error-handling
    name: Auth Call Without Error Handling
    severity: warning
    type: regex
    pattern:
      - "await supabase\\.auth\\.sign(?:In|Up|Out)(?![\\s\\S]{0,100}?error)"
    message: "Auth operation without error handling. Always check for errors."
    fix_action: "Destructure { data, error } and handle error case"
    applies_to:
      - "*.tsx"
      - "*.ts"

  - id: auth-no-revalidate
    name: Auth Action Without Revalidation
    severity: warning
    type: regex
    pattern:
      - "signOut\\(\\)(?![\\s\\S]{0,100}?revalidate)"
      - "signIn(?:WithPassword|WithOAuth)(?![\\s\\S]{0,100}?revalidate)"
    message: "Auth action without revalidatePath. Cache may show stale auth state."
    fix_action: "Add revalidatePath('/', 'layout') after auth operations"
    applies_to:
      - "app/actions*.ts"
      - "**/actions/*.ts"

  - id: auth-client-side-protection
    name: Client-Only Route Protection
    severity: warning
    type: regex
    pattern:
      - "'use client'[\\s\\S]*?getUser\\(\\)[\\s\\S]*?redirect"
      - "'use client'[\\s\\S]*?useEffect[\\s\\S]*?redirect"
    message: "Client-side route protection shows flash of content. Use middleware."
    fix_action: "Move protection to middleware.ts for better UX"
    applies_to:
      - "app/**/page.tsx"
